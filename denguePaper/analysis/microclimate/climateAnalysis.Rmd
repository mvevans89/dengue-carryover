---
title: "Athens Dengue Data"
author: "Michelle Evans"
date: ""
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)

library(ggplot2)
library(dplyr)
library(ggthemes)
library(lme4)
library(multcomp)
```

#Load Data

This data was cleaned in the RMarkdown file "dengueAnalysis.Rmd"

```{r}
climate <- read.csv(file='../../data/microclimate/clean/2016TrialsAdultCleaned.csv', stringsAsFactors = F)

climate$Day <- as.Date(climate$Day, format="%Y-%m-%d")
climate$Site_ID <- as.factor(climate$Site_ID)
climate$Tray_ID <- as.factor(climate$Tray_ID)
climate$Class <- as.factor(climate$Class)

#drop R3T4 because it has wierd errors
climate <- filter(climate, Tray_ID!="R3T4")


```

Get mean, min, max
```{r}
clim <- climate %>%
  dplyr::group_by(Tray_ID, Day, Site_ID, Class) %>%
  dplyr::summarise(meanT=mean(Temp), minT=min(Temp), maxT=max(Temp), meanRH=mean(RH), maxRH=max(RH), minRH=min(RH)) %>% #values per tray
  ungroup() %>%
  group_by(Class, Day) %>% #get mean values per class
  dplyr::summarise(meanT=mean(meanT), minT=mean(minT), maxT=mean(maxT), meanRH=mean(meanRH), maxRH=mean(maxRH), minRH=mean(minRH)) %>%
  ungroup()

```

Temperature Plot:
```{r}
#pdf(file="../figures/forMS/temperature.pdf", width = 6, height=4, family="sans")

ggplot(data=clim, aes(x=Day, group=Class))+
  geom_line(aes(y=meanT, col=Class)) + 
  geom_line(aes(y=minT, col=Class), linetype="dotted") +
  geom_line(aes(y=maxT, col=Class), linetype="dotted") +
  theme_fivethirtyeight() +
  scale_color_manual(values=c("dodgerblue", "gray20", "maroon")) +
  theme(axis.title = element_text(), axis.title.x = element_blank()) +
  ylab("Temperature (C)") + 
  annotate("rect", xmin=as.Date("2016-08-01", format="%Y-%m-%d"), xmax=as.Date("2016-09-01", format="%Y-%m-%d"), ymin=-Inf, ymax=Inf, fill="forestgreen", alpha=0.1)+
    annotate("rect", xmin=as.Date("2016-09-26", format="%Y-%m-%d"), xmax=as.Date("2016-11-07", format="%Y-%m-%d"), ymin=-Inf, ymax=Inf, fill="darkorange", alpha=0.1)+
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        axis.line=element_line(color=ggthemes_data$fivethirtyeight["dkgray"], size=0.5),
        panel.grid = element_blank())+
  theme(legend.background = element_rect(fill = "transparent", colour = NA))
#dev.off()
```

Relative Humidity
```{r}
#pdf(file="../figures/forMS/supplement/relativeHumidity.pdf", width = 6, height=4, family="sans")

ggplot(data=clim, aes(x=Day, group=Class))+
  geom_line(aes(y=meanRH, col=Class)) + 
  geom_line(aes(y=minRH, col=Class), linetype="dotted") +
  geom_line(aes(y=maxRH, col=Class), linetype="dotted") +
  theme_fivethirtyeight() +
  scale_color_manual(values=c("dodgerblue", "gray20", "maroon")) +
  theme(axis.title = element_text(), axis.title.x = element_blank()) +
  ylab("Relative Humidity (%)") + 
  annotate("rect", xmin=as.Date("2016-08-01", format="%Y-%m-%d"), xmax=as.Date("2016-09-01", format="%Y-%m-%d"), ymin=-Inf, ymax=Inf, fill="forestgreen", alpha=0.1)+
    annotate("rect", xmin=as.Date("2016-09-26", format="%Y-%m-%d"), xmax=as.Date("2016-11-07", format="%Y-%m-%d"), ymin=-Inf, ymax=Inf, fill="darkorange", alpha=0.1)+
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank())+
  theme(legend.background = element_rect(fill = "transparent", colour = NA))
#dev.off()
```

# Stats

By tray:

```{r}
fall <- climate %>%
  filter(Day>"2016-09-26") %>%
  mutate(Block="Fall")

summer <- climate %>%
  filter(Day < "2016-09-01") %>%
  mutate(Block="Summer")

climBlocks <- rbind(summer, fall)
rm(summer,fall)

climTray <- climBlocks %>%
  group_by(Block, Tray_ID, Day, Site_ID, Class) %>%
  dplyr::summarise(meanT=mean(Temp), minT=min(Temp), maxT=max(Temp), meanRH=mean(RH), maxRH=max(RH), minRH=min(RH), DTR=max(Temp)- min(Temp), DHR=max(RH)- min(RH))

climTray$classxBlock <- interaction(climTray$Class, climTray$Block)
```

Temperature:

```{r}
##------------ Mean T
climModMean <- lmer(meanT~0 + Class*Block+ (1|Day) + (1|Site_ID), data=climTray)
plot(climModMean)
summary(climModMean)
confint(climModMean)
AIC(climModMean)
car::Anova(climModMean)

#pairwise stats
summary(glht(climModMean, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

summary(glht(climModMean, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(meanT~classxBlock+ (1|Day) + (1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))

anova(climModMean, intMod)

##------------ Min T

climModMin <- lmer(minT~0+Class*Block + (1|Day) + (1|Site_ID), data=climTray)
plot(climModMin)
summary(climModMin)
confint(climModMin)
AIC(climModMin)
car::Anova(climModMin)

#pairwise stats
summary(glht(climModMin, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

summary(glht(climModMin, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(minT~classxBlock+ (1|Day) + (1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))

##------------ Max T
climModMax <- lmer(maxT~0+Class*Block + (1|Day)+ (1|Site_ID), data=climTray)
plot(climModMax)
summary(climModMax)
confint(climModMax)

car::Anova(climModMax)

#pairwise stats
summary(glht(climModMax, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

#pairwise stats
summary(glht(climModMax, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

##------------ DTR
climModDTR <- lmer(DTR~0+Class*Block + (1|Day)+ (1|Site_ID), data=climTray)
plot(climModDTR)
summary(climModDTR)
confint(climModDTR)

car::Anova(climModDTR)

#pairwise stats
summary(glht(climModDTR, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

#pairwise stats
summary(glht(climModDTR, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(DTR~classxBlock+ (1|Day) + (1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))

```

Urban sites are significantly hotter than rural and suburban sites, where there is no difference. This is exactly what we found last year. Surprisingly, rural sites had the hottest maximum temperature. This may explain some of our differences from 2015.

Relative Humidity:
```{r}
## ------ mean RH
ggplot(data=climTray, aes(x=Class, y=meanRH)) +
  geom_boxplot() +
  facet_wrap(~Block)
ggplot(data=climTray, aes(x=meanRH)) +
  geom_histogram()

climModMeanRH <- lmer(meanRH~0 + Block*Class + (1|Day) + (1|Site_ID), data=climTray)
plot(climModMeanRH)
summary(climModMeanRH)
#confint(climModMeanRH)
AIC(climModMeanRH)
car::Anova(climModMeanRH)

#pairwise stats
summary(glht(climModMeanRH, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

summary(glht(climModMeanRH, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(meanRH~classxBlock+ (1|Day) + (1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))

anova(climModMeanRH, intMod)

## ------ min RH
ggplot(data=climTray, aes(x=Class, y=minRH)) +
  geom_boxplot() +
  facet_wrap(~Block)
ggplot(data=climTray, aes(x=minRH)) +
  geom_histogram() +
  facet_wrap(~Block)

climModMinRH <- lmer(minRH~0+Block + (1|Day) + (1|Site_ID), data=climTray) #class not significant
plot(climModMinRH)
summary(climModMinRH)
confint(climModMinRH)
AIC(climModMinRH)
car::Anova(climModMinRH)

#pairwise stats
summary(glht(climModMinRH, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

summary(glht(climModMinRH, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(minRH~classxBlock+ (1|Day) + (1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))

## ------ max RH: can't do becuase of crazy distribution
# ggplot(data=climTray, aes(x=Class, y=maxRH)) +
#   geom_boxplot() +
#   facet_wrap(~Block)
# ggplot(data=climTray, aes(x=maxRH)) +
#   geom_histogram() +
#   facet_wrap(~Block)
# 
# climModMaxRH <- lmer(maxRH~0+Class*Block + (1|Day)+ (1|Site_ID), data=climTray)
# plot(climModMaxRH)
# summary(climModMaxRH)
# confint(climModMaxRH)
# 
# car::Anova(climModMaxRH)
# 
# #pairwise stats
# summary(glht(climModMaxRH, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))
# 
# #pairwise stats
# summary(glht(climModMaxRH, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

## ------ DHR

ggplot(data=climTray, aes(x=Class, y=DHR)) +
  geom_boxplot() +
  facet_wrap(~Block)

climModDHR <- lmer(DHR~0+Block + (1|Day)+ (1|Site_ID), data=climTray)
plot(climModDHR)
summary(climModDHR)
confint(climModDHR)

car::Anova(climModDHR)

#pairwise stats
summary(glht(climModDHR, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

#pairwise stats
summary(glht(climModDHR, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(DHR~classxBlock+ (1|Day) + (1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))

```

## Compare summer and fall

```{r}
ggplot(data=climTray, aes(x=Block, y=meanT)) +
  geom_boxplot()

summary(aov(Temp~Block, data=climBlocks))
```

Summer is definitely hotter than the fall (seems unnecessary to plot but there you go)

```{r}
ggplot(data=climTray, aes(x=Class, y=DHR)) +
  geom_boxplot() +
  facet_wrap(~Block)

summary(aov(Temp~Block, data=climBlocks))
```

