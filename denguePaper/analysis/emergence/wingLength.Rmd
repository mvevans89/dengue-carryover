---
title: "Wing Length Analysis"
author: "Michelle Evans"
date: "5/11/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
```


```{r}
library(dplyr)
library(ggplot2)
library(ggthemes)
library(lme4)
```

```{r load body size data}
augWing <- read.csv("../../data/emergence/raw/AugustWingLength.csv", stringsAsFactors = F)
octWing <- read.csv("../../data/emergence/raw/OctoberWingLength.csv",  stringsAsFactors = F)


#convert to mm & clean
augWing$mm <- augWing$Bars*augWing$Conversion.mm.bars.
octWing$mm <- octWing$Bars*octWing$Conversion.bars.mm.

octWing$site <- as.factor(substr(as.character(octWing$TrayCode), 1, 2))
augWing$site <- as.factor(substr(as.character(augWing$TrayCode), 1, 2))

getClass <- function(monthDf){
  monthDf$class <- NULL
  for (i in 1:nrow(monthDf)){
    if (substr(monthDf$site[i], 1,1)=="R"){
    monthDf$class[i] <- "Rural"
    }
    if (substr(monthDf$site[i], 1,1)=="S"){
    monthDf$class[i] <- "Suburban"
    }
    if (substr(monthDf$site[i], 1,1)=="U"){
    monthDf$class[i] <- "Urban"
    }
  }
  monthDf$class <- as.factor(monthDf$class)
  return(monthDf)
}

augWing <- getClass(augWing)
octWing <- getClass(octWing)

octWing$block <- "fall"
augWing$block <- "summer"

augWing$Date <- as.Date(as.character(augWing$Date), format="%m/%d/%Y")
octWing$Date <- as.Date(as.character(octWing$Date), format="%m/%d/%Y")

#add day of experiment
augWing$Exp_Day <- as.numeric(augWing$Date-as.Date("2016-08-01", format="%Y-%m-%d"))
octWing$Exp_Day <- as.numeric(octWing$Date-as.Date("2016-09-26", format="%Y-%m-%d"))

#rename traycode column to match
colnames(augWing)[1] <- "Tray_ID"
colnames(octWing)[1] <- "Tray_ID"

#combine
fallWing <- octWing %>%
  select(block, class, site, Tray_ID, Exp_Day, mm)

summerWing <- augWing %>%
    select(block, class, site, Tray_ID, Exp_Day, mm)

allWing <- rbind(summerWing, fallWing)
allWing$block<- as.factor(allWing$block)

#drop outlier in S2 (wing size =1.56 mm)
allWing <- allWing %>%
  filter(mm>1.6)
```

# Class * Block Analysis

## Basic Visualization

**Size of mosquitoes over time: Are mosquitoes that emerge later larger?**

```{r}
plot(allWing$Exp_Day, allWing$mm, col=c(1,2,3)[as.numeric(allWing$class)], pch=c(16,17)[as.numeric(as.factor(allWing$block))])
with(allWing, abline(lm(mm~Exp_Day), lty=2))
```

No, we don't need to worry about that in our analysis.

**Does the size of mosquitoes differ between class and block?**

```{r}
ggplot(data=allWing, aes(x=site, y=mm))+
  geom_violin() +
  facet_wrap(~block)+
  theme_base()

ggplot(data=allWing, aes(x=class, y=mm))+
  geom_boxplot() +
  facet_wrap(~block)+
  theme_base()

#note there is an outlier in S2 in the summer (dropping above)
```

No difference in size among those that weren't infected. However we saw a significant difference among those that were infected. Two possible reasons:

- size differences are most pronounced for mosquitoes at the peak of emergence, and these mosquitoes were all measured after the peak, when they may have had more access to resources
- infection is causing smaller mosquitoes to die off

## Stats

We can look at statistical differences, but based on the above visualization, they all look the same.

```{r}
wingMix <- lmer(mm~block*class +(1|site),
                data=allWing)
summary(wingMix)
plot(wingMix)
car::Anova(wingMix)
```

This says that there is an interaction between block and class. Let's plot that out:

```{r}
with(allWing, interaction.plot(x.factor=class, trace.factor=block, response=mm, fun="mean", type="b", legend=T))
```

Yes, it seems that in the summer, suburban mosquitoes were the smallest, while they were the largest in teh fall. There also is a greater difference between urban and rural sites in the summer and fall.

# Climate and Wing Length

For this, I will use the climate up until each individual mosquitoes day of emergence.

```{r load climate data}
climate <- read.csv(file='../../data/microclimate/clean/2016TrialsAdultCleaned.csv', stringsAsFactors = F)

climate$Day <- as.Date(climate$Day, format="%Y-%m-%d")
climate$Site_ID <- as.factor(climate$Site_ID)
climate$Tray_ID <- as.factor(climate$Tray_ID)
```


```{r format climate and wing length data}
getClimate <- function(indMosq, climateDF=climate, season){
  #' This is a function to apply over the rows of the octWing and augWing data frames. Must have climate data loaded
  
  #' @param indMosq row of the dataframe for each individual mosquito
  #' @param climateDF the dataframe containing climate data every 10 minutes
  #' @param season, either "summer" or "fall"
  #' @returns formatted data with climate and winglength for the individual mosquito
  
  
  #get date range
  startDate <- ifelse(season=="summer", "2016-08-01", "2016-09-26")
  startDate <- as.Date(startDate, format="%Y-%m-%d")
  endDate <- indMosq$Date
  
  #subset temperature data
  try(climSubset <- climateDF %>%
    filter(Tray_ID==as.character(indMosq$Tray_ID)) %>%
    filter(Day>startDate & Day<endDate),
    silent=T)
  
  #now take mean temperature
  tempMean <- climSubset %>%
    summarise(Tmean=mean(Temp, na.rm=T))
  
  # if (nrow(climSubset)<1000){
  #   climSubset <- climate %>%
  #     filter(Site_ID==indMosq$site) %>%
  #     filter(Day>startDate & Day<endDate)
  # }
  
  #merge this all together
  #mosqFormat <- cbind(indMosq[,c('block','class','site','Tray_ID','Exp_Day', 'mm')], Tmean=tempMean$Tmean)
  
  return(tempMean$Tmean)
}
```

```{r}
augWing$Temp <- NA
for(i in 1:nrow(augWing)){
  indMosq <- augWing[i,]
  augWing$Temp[i] <- getClimate(indMosq, season="summer")
}

octWing$Temp <- NA
for(i in 1:nrow(octWing)){
  indMosq <- octWing[i,]
  octWing$Temp[i] <- getClimate(indMosq, season="fall")
}

#combine
fallWing <- octWing %>%
  select(block, class, site, Tray_ID, Exp_Day, mm, Temp)

summerWing <- augWing %>%
    select(block, class, site, Tray_ID, Exp_Day, mm, Temp)

allWing <- rbind(summerWing, fallWing)
allWing$block<- as.factor(allWing$block)

#drop outlier in S2 (wing size =1.56 mm)
allWing <- allWing %>%
  filter(mm>1.6)
```

## Basic Visualization

```{r}
ggplot(data=allWing, aes(x=Temp, y=mm)) +
  geom_point(aes(col=factor(class), shape=factor(block))) + 
  theme_base() + 
  #facet_wrap(~block) +
  geom_smooth(method="lm")
```

If you look at each block individually, it does seem like there is a trend between temperature and wing size.

```{r}
ggplot(data=allWing, aes(x=Temp, y=mm)) +
  geom_point(aes(col=factor(class), shape=factor(block))) + 
  theme_base() + 
  facet_wrap(~block) +
  geom_smooth(method="lm")
```

## Statistics

```{r}
modDf <- na.omit(allWing)
wingTemp <- lmer(mm~Temp + (1|site),
                 data=modDf)
summary(wingTemp)
plot(wingTemp)
car::Anova(wingTemp)
AIC(wingTemp)
confint(wingTemp)

preds <- predict(wingTemp)
ranef(wingTemp)
coef(wingTemp)

plot(x=jitter(modDf$mm,0.01), y=preds, col=RColorBrewer::brewer.pal(6,name="RdBu")[.bincode(modDf$Temp, breaks=c(15,18,20,22,25,26,30))], pch=16)
cor(modDf$mm, preds)
```

The effect of temperature on wing size is slightly positive, but not significant. This matches what we found above.

**This is opposite of what we found last year.** So I am looking into what our results from last year would say if we only considered the subset of mosquitoes after the peak emergence.

```{r}
wings2015 <- read.csv("../../data/emergence/clean/2015wingLength.csv")
wings2015$Date <- as.Date(paste("2016", wings2015$Month, wings2015$Day, sep="-"), format="%Y-%m-%d")
```

```{r}
ggplot(data=wings2015, aes(x=Date, y=WingSize)) +
  geom_point()+
  theme_base()
```

