---
title: "Survival Analyses"
author: "Michelle Evans"
date: ''
output:
  pdf_document: default
  html_document: default
---

This is the document exploring larval survival for the 2016 Athens Field Project (both seasons).

```{r setup, echo=F}
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(echo=FALSE)
```

```{r load packages}
library(xtable)
library(dplyr)
library(ggplot2)
library(lme4)
library(MASS)
library(car)
library(survival)
library(survminer)
library(ggthemes)
```

# Notebook of Tasks Done

* overall survival per tray by Class and Block using a linear mixed model (this could probably also be a logistic regression) (2017-04-05)
* survival curves using Cox PH: PH Assumptions were very violated, even when turning `Class` into a time dependent variable. Decided against this method (2017-04-10)
* creating individual regression curves for each tray, and then using the growth rate as response variables in a mixed-model (2017-04-16)
* attempting to use a `nls` formula within a lmer statistical model (similar to Shapiro et al. 2016) - Spoke with John and decided to explore the fall data and explain why the survial curves do not fit (2017-05-01)
* plot KM curves and then analyze seasons seperately


# Data Visualization

```{r data load and sort}
emergAug <- read.csv("../../data/emergence/raw/AugustEmergence.csv")
emergAug$block <- "summer"

emergOct <- read.csv("../../data/emergence/raw/OctoberEmergence.csv")
emergOct$block <- "fall"
#drop U3T1 in fall because it was eaten by ants
emergOct <- filter(emergOct, Tray_Code!="U3T1")

emergAll <- rbind(emergOct, emergAug)
#expand so each mosquito gets one row
emergExp <- emergAll[rep(seq.int(1,nrow(emergAll)), emergAll$Num_Emerge),
                      c(11, 2,4,5,6:9)]
sum(emergAll$Num_Emerge)==nrow(emergExp) #quick check this worked
```

Investigate tray level survival for some basic box plots. Note, we are only including female survival because that is what contributes to disease and population growth.

```{r tray level}
#get survival per tray
survSumm <- emergExp %>%
  filter(Sex=="F") %>%
  group_by(block, Tray_Code) %>%
  mutate(percSurv=n()) %>%
  ungroup() %>%
  dplyr::select(block, Class, Site_Code, Tray_Code, percSurv)
survSumm <- unique(survSumm)

#box plot by site
ggplot(data=survSumm, aes(x=Site_Code, y=percSurv)) +
  geom_boxplot() +
  facet_wrap(~block) +
  theme_base() +
  ylab("Number emerged (out of 50)")
```

```{r}
ggplot(data=survSumm, aes(x=Class, y=percSurv)) +
  geom_boxplot() +
  facet_wrap(~block) +
  theme_base() +
  ylab("Number emerged (out of 50)")
```

```{r}
with(survSumm, interaction.plot(x.factor=Class, trace.factor=block, response=percSurv, fun=mean, type="b", legend=T))
```

In general, I would say survival is more likely in urban in the fall and less likely in urban in the summer, although this is slight. There is no difference between rural and suburban.

# Mixed Model Emergence Percentages

```{r, results='asis'}
mixMortality <- lmer(percSurv ~  Class*block + (1|Site_Code), data=survSumm)
summary(mixMortality)
#anova(mixMortality)
emergAnova <- Anova(mixMortality, test.statistic = "F") #with car loaded
#plot(mixMortality)
#qqnorm(resid(mixMortality))
knitr::kable(emergAnova, caption="LMEM of class * block on tray level emergence with site as a random effect")
```

I also reran this on data aggregated by site (becuase I was concerned that treating each tray as an observation was pseudo-replication), and found an even stronger effect of block larval survival. Note that this gets rid of site as a random effect, and basically becomes an ANOVA. TukeyHSD still finds block to be significant.

```{r}
siteSumm <- emergExp %>%
  filter(Sex=="F") %>%
  group_by(block, Site_Code) %>%
  mutate(numSurv=n()) %>%
  ungroup() %>%
  dplyr::select(block, Class, Site_Code, numSurv)
siteSumm <- unique(siteSumm)

siteEmerg <- aov(numSurv ~  Class*block, data=siteSumm)
summary(siteEmerg)
#plot(siteEmerg)
TukeyHSD(siteEmerg)
```

Block had a significant effect. With higher survival in the summer than the fall.

# Development Rates

We can also look at the time to development (i.e. emergence day) for block and class.

```{r}
emergExpF <- filter(emergExp, Sex=="F")
ggplot(data=emergExpF, aes(x=Site_Code, y=Exp_Day)) +
  geom_violin() +
  facet_wrap(~block) +  
  theme_base() +
  ylab("Emergence Day")
```

```{r}
with(emergExpF, interaction.plot(x.factor=Class, trace.factor=block, response=Exp_Day, fun=mean, type="b", legend=T))
```


It took much longer in the fall than in the summer for mosquitoes to emerge, implying they were developing more slowly. In both seasons, however, mosquitoes in urban sites emerged more quickly.


```{r}
mixEmerge <- lmer(Exp_Day ~  Class*block + (1|Site_Code), data=emergExpF)
plot(mixEmerge)
summary(mixEmerge)
knitr::kable(Anova(mixEmerge))
```

The day of emergence differed significantly across block (and nearly class). Mosquitoes in the summer emerged on average 14 days sooner than those in the fall. 

# Survival Analysis

## Format Data

Using `emergExp`, in which each mosquito has its own row, we then fillIn rows for mosquitoes which did not emerge. Again, assuming 50 F per tray.

```{r fillIn function}
fillIn <- function(df, endDay, totalMosq=50){
  #' Fill In Emergence Dates
  #' this function fills in for those mosquitoes that did not emerge so we do not have data for, it gives them an observation/event of 0 on the last day we found a mosquito emerged
  #' @param df the data frame you wish to fill in, in our case by pot
  #' @param endDay the last day of emergence
  #' @param totalMosq estimated starting number of mosquitoes per pot
  #' @returns dataframe with census data filled in for mosquitoes that did not emerge
  toRep <- df[1,]
  toRep$Exp_Day <- endDay
  toRep$event <- 0
  if(nrow(df)<totalMosq){
    toAdd <- toRep[rep(1, (totalMosq-nrow(df))),]
    allTest <- rbind(df, toAdd)
  } else {
    toAdd <- NA
    allTest <- NA
  }
  return(allTest)
}
```


```{r apply FillIn function}
applyFill <- function(season, allData=emergExp){
  #' Apply FillIn function
  #' @param season "fall" or "summer"
  #' @param allData full dataframe with row for each mosquito that emerged
  #' @returns censused data for the full season
  tempList <- list()
  tempDF <- allData
  tempDF <- tempDF[tempDF$Sex=="F",]
  tempDF <- tempDF[tempDF$block==season,]
  tempDF$event <- 1 #add emergence event
  for (i in 1:length(unique(tempDF$Tray_Code))){ 
    df <- tempDF[tempDF$Tray_Code==unique(tempDF$Tray_Code)[i],]
    endDay <- max(tempDF$Exp_Day)
    tempList[[i]] <- fillIn(df=df, endDay=endDay)
  }
  allSurv <- do.call(rbind.data.frame, tempList)
  return(allSurv)
}
```

```{r}
summerSurv <- applyFill(season="summer")
fallSurv <- applyFill(season="fall")
allSurv <- rbind(summerSurv, fallSurv)
```

```{r combine with climate data, eval=F}
#create summarised climate data by Tray_Code and Exp_Day
climate <- read.csv("../../data/microclimate/clean/2016TrialsAdultCleaned.csv", stringsAsFactors = F)
```

## Cox PH by Block and Season

```{r KM fit and plot}

with (allSurv, table(event, block, Class))

km.fit <- survfit(Surv(Exp_Day, event) ~ block + Class + cluster(Site_Code), data=allSurv, type="kaplan-meier", se.fit=T, conf.int=0.95)
summary(km.fit)

ggsurvplot(km.fit, 
           data=allSurv, 
           risk.table=F, 
           pval=F, 
           conf.int=T, 
           ggtheme=theme_minimal()
           #palette=rep(c(colRural,colSuburban, colUrban), 2),
           #legend.labs=rep(c("Rural", "Suburban", "urban"), 2)
          )


  data <- eval(km.fit$call$data)
  d <- surv_summary(km.fit, data=data)
  d$emerge <- (1 - d$surv)*100
  ggplot(data=d, aes(x=time, y=emerge, group=factor(strata)))+
    geom_line(aes(color=Class))+
    geom_ribbon(aes(ymin=(1-upper)*100, ymax=(1-lower)*100, fill=Class), alpha=0.4)+
    scale_color_manual(values=c("dodgerblue", "gray80", "maroon"), labels=c("Rural", "Suburban", "Urban"))+
    scale_fill_manual(values=c("dodgerblue", "gray80", "maroon"))+
    theme_base()+
    ylab("Percent of Females Emerged") +
    xlab("Day")+
    guides(color=F)+
    ggtitle("Female Larval Emergence")


```

```{r, eval=F}
allSurv$bins <- cut(allSurv$Exp_Day, breaks=c(10,12,14,21,42))

coxFit <- coxph(Surv(Exp_Day, event) ~ Class*block + block:Exp_Day + cluster(Site_Code), data=allSurv, method="breslow")
summary(coxFit)


cox.zph(coxFit)
plot(cox.zph(coxFit))

hist(allSurv$Exp_Day[allSurv$block=="summer"])
hist(allSurv$Exp_Day[allSurv$block=="fall"])
#their distributions are very different, may make sense to model them seperately

summFit <- coxph(Surv(Exp_Day, event) ~ Class + Class:Exp_Day + cluster(Site_Code),
                 data=allSurv[allSurv$block=="summer",],
                 method="breslow")
summary(summFit)
cox.zph(summFit)
plot(cox.zph(summFit))

fallFit <- coxph(Surv(Exp_Day, event) ~ Class + Class:Exp_Day + cluster(Site_Code),
                 data=allSurv[allSurv$block=="fall",],
                 method="breslow")
summary(fallFit)
cox.zph(fallFit)
plot(cox.zph(fallFit))

#also test across blocks
blockFit <- coxph(Surv(Exp_Day, event) ~ block + block:Exp_Day , data=allSurv, method="breslow")
summary(blockFit)
cox.zph(blockFit)
plot(cox.zph(blockFit))
```


**Summary**: There is clearly an effect of season on emergence. Although it does seem that urban sites go from having lower emergence in the summer to higher in the fall, the survival models are not significantly different.

I think it makes the most sense to report on the survival statistics and show the curves, noting that the only significant differences are across season.