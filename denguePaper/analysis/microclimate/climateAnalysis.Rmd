---
title: "Athens Dengue Data"
author: "Michelle Evans"
date: ""
output: pdf_document
---

This document contains the code for the analysis of microclimate data in 'Carry-over effects of larval microclimate on the transmission potential of a mosquito-borne pathogen' (Evans et al. 2017).

Paper Citation:

Evans MV, Shiau JC, Solano N, Brindley MA, Drake JM, Murdock, CC. 2017. Carry-over effects of larval microclimate on the transmission potential of a mosquito-borne pathogen.  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)

library(ggplot2)
library(dplyr)
library(ggthemes)
library(lme4)
library(multcomp)
library(cowplot)
```

#Load Data

This data was cleaned in the RMarkdown file "EvansCode.Rmd"

```{r}
climate <- read.csv(file='../../data/microclimate/clean/2016TrialsAdultCleaned.csv', stringsAsFactors = F)

climate$Day <- as.Date(climate$Day, format="%Y-%m-%d")
climate$Site_ID <- as.factor(climate$Site_ID)
climate$Tray_ID <- as.factor(climate$Tray_ID)
climate$Class <- as.factor(climate$Class)

#drop R3T4 because it malfunctioned
climate <- filter(climate, Tray_ID!="R3T4")
```

Get mean, min, max
```{r}
clim <- climate %>%
  dplyr::group_by(Tray_ID, Day, Site_ID, Class) %>%
  dplyr::summarise(meanT=mean(Temp), minT=min(Temp), maxT=max(Temp), meanRH=mean(RH), maxRH=max(RH), minRH=min(RH)) %>% #values per tray
  ungroup() %>%
  group_by(Class, Day) %>% #get mean values per class
  dplyr::summarise(meanT=mean(meanT), minT=mean(minT), maxT=mean(maxT), meanRH=mean(meanRH), maxRH=mean(maxRH), minRH=mean(minRH)) %>%
  ungroup()
```

# Plots
Temperature Plot:
```{r, eval = F}
temperature <- ggplot(data=clim, aes(x=Day, group=Class))+
  geom_line(aes(y=meanT, col=Class)) + 
  geom_line(aes(y=minT, col=Class), linetype="dotted") +
  geom_line(aes(y=maxT, col=Class), linetype="dotted") +
  theme_fivethirtyeight() +
  scale_color_manual(values=c("dodgerblue", "gray20", "maroon")) +
  theme(axis.title = element_text(), axis.title.x = element_blank()) +
  ylab("Temperature (C)") + 
  annotate("rect", xmin=as.Date("2016-08-01", format="%Y-%m-%d"), xmax=as.Date("2016-09-01", format="%Y-%m-%d"), ymin=-Inf, ymax=Inf, fill="gray20", alpha=0.1)+
    annotate("rect", xmin=as.Date("2016-09-26", format="%Y-%m-%d"), xmax=as.Date("2016-11-07", format="%Y-%m-%d"), ymin=-Inf, ymax=Inf, fill="gray20", alpha=0.1)+
  annotate("text", x = as.Date("2016-08-15", format="%Y-%m-%d"), y = 3, label = "Summer") +
  annotate("text", x = as.Date("2016-10-18", format="%Y-%m-%d"), y = 3, label = "Fall") +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        axis.line=element_line(color=ggthemes_data$fivethirtyeight["dkgray"], size=0.5),
        panel.grid = element_blank())+
  theme(legend.background = element_rect(fill = "transparent", colour = NA))

```

Relative Humidity
```{r, eval=F}
rh <- ggplot(data=clim, aes(x=Day, group=Class))+
  geom_line(aes(y=meanRH, col=Class)) + 
  geom_line(aes(y=minRH, col=Class), linetype="dotted") +
  geom_line(aes(y=maxRH, col=Class), linetype="dotted") +
  theme_fivethirtyeight() +
  scale_color_manual(values=c("dodgerblue", "gray20", "maroon")) +
  theme(axis.title = element_text(), axis.title.x = element_blank()) +
  ylab("Relative Humidity (%)") + 
  xlab("Date")+
  annotate("rect", xmin=as.Date("2016-08-01", format="%Y-%m-%d"), xmax=as.Date("2016-09-01", format="%Y-%m-%d"), ymin=-Inf, ymax=Inf, fill="gray20", alpha=0.1)+
    annotate("rect", xmin=as.Date("2016-09-26", format="%Y-%m-%d"), xmax=as.Date("2016-11-07", format="%Y-%m-%d"), ymin=-Inf, ymax=Inf, fill="gray20", alpha=0.1)+
    annotate("text", x = as.Date("2016-08-15", format="%Y-%m-%d"), y = 22, label = "Summer") +
  annotate("text", x = as.Date("2016-10-18", format="%Y-%m-%d"), y = 22, label = "Fall") +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        axis.line=element_line(color=ggthemes_data$fivethirtyeight["dkgray"], size=0.5),
        panel.grid = element_blank())+
  theme(legend.background = element_rect(fill = "transparent", colour = NA))
#dev.off()
```


```{r}
pdf(file="../figures/forMS/SuppFig2.pdf", width = 6, height=8, family="sans")
plot_grid(temperature, rh, align="v", nrow=2)
dev.off()
```

# Stats

By tray:

```{r}
fall <- climate %>%
  filter(Day>"2016-09-26") %>%
  mutate(Block="Fall")

summer <- climate %>%
  filter(Day < "2016-09-01") %>%
  mutate(Block="Summer")

climBlocks <- rbind(summer, fall)
rm(summer,fall)

climTray <- climBlocks %>%
  dplyr::group_by(Tray_ID, Day, Site_ID, Class, Block) %>%
  dplyr::summarise(meanT=mean(Temp), minT=min(Temp), maxT=max(Temp), meanRH=mean(RH), maxRH=max(RH), minRH=min(RH), DTR = max(Temp) - min(Temp), DHR = max(RH) - min(RH)) %>% #values per tray
  ungroup() %>%
  group_by(Block, Class, Site_ID, Tray_ID) %>% #get mean values per class
  dplyr::summarise(meanT=mean(meanT), minT=mean(minT), maxT=mean(maxT), meanRH=mean(meanRH), maxRH=mean(maxRH), minRH=mean(minRH), meanDTR = mean(DTR), meanDHR = mean(DHR)) %>%
  ungroup()

climTray$classxBlock <- interaction(climTray$Class, climTray$Block)
```

Temperature:

```{r}
##------------ Mean T
climModMean <- lmer(meanT~Class*Block + (1|Site_ID), data=climTray)
plot(climModMean)
summary(climModMean)
confint(climModMean)
car::Anova(climModMean)

#pairwise stats
summary(glht(climModMean, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

summary(glht(climModMean, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(meanT~classxBlock+ (1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))

#get means in a reasonable way
extractMean  <- function(model){
  results <- data.frame(unique(climTray[,c('Class', 'Block')]), Mean = NA)
  results$Mean[1] <- fixef(model)[1]
  results$Mean[2] <- fixef(model)[1] + fixef(model)[2]
  results$Mean[3] <- fixef(model)[1] + fixef(model)[3]
  results$Mean[4] <- fixef(model)[1] + fixef(model)[4]
  results$Mean[5] <- fixef(model)[1] + fixef(model)[2] + fixef(model)[4] + fixef(model)[5]
  results$Mean[6] <- fixef(model)[1] + fixef(model)[3] + fixef(model)[4] + fixef(model)[6]
  return(results)
}

extractMean(climModMean)

##------------ Min T

climModMin <- lmer(minT~Class*Block + (1|Site_ID), data=climTray)
plot(climModMin)
summary(climModMin)
confint(climModMin)
AIC(climModMin)
car::Anova(climModMin)

#pairwise stats
summary(glht(climModMin, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

summary(glht(climModMin, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(minT~classxBlock+(1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))

extractMean(climModMin)

##------------ Max T
climModMax <- lmer(maxT~Class*Block + (1|Site_ID), data=climTray)
plot(climModMax)
summary(climModMax)
confint(climModMax)

car::Anova(climModMax)

#pairwise stats
summary(glht(climModMax, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

#pairwise stats
summary(glht(climModMax, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(maxT~classxBlock+(1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))


extractMean(climModMax)

##------------ DTR
climModDTR <- lmer(meanDTR~Class*Block + (1|Site_ID), data=climTray)
plot(climModDTR)
summary(climModDTR)
confint(climModDTR)

car::Anova(climModDTR)

#pairwise stats
summary(glht(climModDTR, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

#pairwise stats
summary(glht(climModDTR, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(meanDTR~classxBlock+ (1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))

extractMean(climModDTR)

```


## Relative Humidity:
```{r}
## ------ mean RH

climModMeanRH <- lmer(meanRH~Class*Block + (1|Site_ID), data=climTray)
plot(climModMeanRH)
summary(climModMeanRH)
#confint(climModMeanRH)
car::Anova(climModMeanRH)

#pairwise stats
summary(glht(climModMeanRH, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

summary(glht(climModMeanRH, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(meanRH~classxBlock+ (1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))

anova(climModMeanRH, intMod)

extractMean(climModMeanRH)

## ------ min RH
climModMinRH <- lmer(minRH~Class*Block + (1|Site_ID), data=climTray)
plot(climModMinRH)
summary(climModMinRH)
confint(climModMinRH)
AIC(climModMinRH)
car::Anova(climModMinRH)

#pairwise stats
summary(glht(climModMinRH, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

summary(glht(climModMinRH, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(minRH~classxBlock+ (1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))

extractMean(climModMinRH)

## ------ max RH

climModMaxRH <- lmer(maxRH~Class*Block + (1|Site_ID), data=climTray)
plot(climModMaxRH)
summary(climModMaxRH)
# confint(climModMaxRH)
# 
anova(climModMaxRH)
car::Anova(climModMaxRH)

anova(climModMaxRH)

#pairwise stats
summary(glht(climModMaxRH, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

#pairwise stats
summary(glht(climModMaxRH, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(maxRH~classxBlock+ (1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))


extractMean(climModMaxRH)

## ------ DHR

climModDHR <- lmer(meanDHR~Class*Block + (1|Site_ID), data=climTray)
plot(climModDHR)
summary(climModDHR)
confint(climModDHR)

car::Anova(climModDHR)

#pairwise stats
summary(glht(climModDHR, linfct = mcp(Class = "Tukey"), test = adjusted("holm")))

#pairwise stats
summary(glht(climModDHR, linfct = mcp(Block = "Tukey"), test = adjusted("holm")))

#pairwise stats-interaction
intMod <- lmer(meanDHR~classxBlock+ (1|Site_ID), data=climTray)
summary(glht(intMod, linfct = mcp(classxBlock = "Tukey"), test = adjusted("holm")))

extractMean(climModDHR)
```
