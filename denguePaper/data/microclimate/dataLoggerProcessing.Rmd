---
title: "climateDataProcessing"
author: "Michelle Evans"
date: "10/5/2016"
output: html_document
---

This document processes data logger data used in the `urbanDengue` project.  It reads in multiple csv's per data logger and binds them together. It then combines these all into one file for all of the data loggers. It also includes cut-offs based on when loggers were put out and collected.

The data is output in two files: data/augustAdult.csv and data/augustLarval.csv

```{r setup}
library(dplyr)
```

# Combine Individual Logger CSVs into CSV files by download date

This works for all of the files in one folder (ie collected on one date). It then saves the data as a csv in the DataLoggerData folder with the appropriate date range as the title.

This function works within the google drive folder, with working directory set to the appropriate year folder (e.g. `2017_rawdata`).

```{r}
processCSVs <- function(dateFolder, adult=T){
  #' Combine multiple data loggers into one csv of date range
  #' @params date range that is the same as the title of the folder on collection date
  #' @returns a dataframe of combined data logger data for that folder
  #'
  
  #get list of CSVs to combine
  file_list <- list.files(path=dateFolder, pattern="*\\.csv")
  if (adult==T){
  file_list <- file_list[grep(file_list, pattern="A")] #for adult loggers
  } else stop("Function does not support larval loggers yet.")
  
  # loop over all the files to read in and format
  for (file in file_list){
  
  # if the merged dataset doesn't exist, create it
  if (!exists("dataset")){
    dataset <- read.table(file, header=F, sep=",")[-1, c(1,2,5)]
   
    colnames(dataset) <- c("Date", "Temp", "RH")
    #change to character and numeric 
    dataset$Date <- as.character(dataset[,1])
    dataset[,c(2,3)] <- apply(dataset[,c(2,3)], 2, function(x) as.numeric((x)))
    #add logger ID
    Pot_ID <- sub(".csv", "", file)
    dataset$Pot_ID <- rep(Pot_ID, nrow(dataset))
  }
  
  # if the merged dataset does exist, append to it
  if (exists("dataset")){
    temp_dataset <- read.table(file, header=F, sep=",")[-1,]
    #subset proper columns if it is a weird csv with Alm columns
    if (ncol(temp_dataset)!=3){
      temp_dataset <- temp_dataset[c(1,2,5)]
    }
    colnames(temp_dataset) <- c("Date", "Temp", "RH")
    #change to character and numeric 
    temp_dataset$Date <- as.character(temp_dataset[,1])
    temp_dataset[,c(2,3)] <- apply(temp_dataset[,c(2,3)], 2, function(x) as.numeric((x)))
    Pot_ID <- sub(".csv", "", file)
    temp_dataset$Pot_ID <- rep(Pot_ID, nrow(temp_dataset))
    
    dataset<-rbind(dataset, temp_dataset)
    rm(temp_dataset)
  }
}

  #Add site ID
  dataset$Site_ID <- as.factor(substring(dataset$Pot_ID,1,2))
  #Add Class
  dataset$Class[dataset$Site_ID %in% c("R1","R2","R3")] <- "Rural"
  dataset$Class[dataset$Site_ID %in% c("S1","S2","S3")] <- "Suburban"
  dataset$Class[dataset$Site_ID %in% c("U1","U2","U3")] <- "Urban"
  dataset$Class <- as.factor(dataset$Class)
  #Reformat Date
  dataset$Date <- as.character(dataset$Date)
  #correct errors (Temperature over 55C)
  dataset <- dataset[-(dataset$Temp>55),]
  if (length(unique(dataset$Pot_ID))!=54){
    print("Warning: missing data loggers")
  }
  return(dataset)
}
```

Now use the function to create CSVs. Example below:

```{r, eval=F}
sep19 <- processCSVs(dateFolder="Sep19-Oct14_2016")
write.csv(sep19, file= "AdultTable_Sep19-Oct14_2016.csv", row.names=F)
```

# Merge CSVs into one csv for whole experiment

This works from inside the microclimate data folder, reading files from `raw` and saving in `clean`

```{r load these grouped tables}
aug1 <- read.csv("raw/AdultTable_July14-Aug8_2016.csv")[,-1]
aug2 <- read.csv("raw/AdultTable_Aug8-Aug29_2016.csv")[,-1]
aug3 <- read.csv("raw/AdultTable_Aug29-Sep19_2016.csv")[,-1]
oct1 <- read.csv("raw/AdultTable_Sep19-Oct14_2016.csv")
oct2 <- read.csv("raw/AdultTable_Oct14-Nov7_2016.csv")
loggerAll <- rbind(aug1, aug2, aug3, oct1, oct2)
#correct Date format
loggerAll$Date <- as.character(loggerAll$Date)
loggerAll$Date <- strptime(loggerAll$Date, format="%m/%d/%Y %H:%M:%S")

#cutoff those before august start date
loggerCrop <- loggerAll[loggerAll$Date>strptime("08-01-2016 17:00:00", format="%m-%d-%Y %H:%M:%S"),]

write.csv(loggerCrop, file="clean/2016TrialsAdult.csv", row.names=F)
```
