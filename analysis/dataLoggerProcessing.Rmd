---
title: "climateDataProcessing"
author: "Michelle Evans"
date: "10/5/2016"
output: html_document
---

This document processes data logger data used in the `urbanDengue` project.  It reads in multiple csv's per data logger and binds them together. It also includes cut-offs based on when loggers were put out and collected.

The data is output in two files: data/augustAdult.csv and data/augustLarval.csv

```{r setup}
library(dplyr)
```

#Adult Microclimate Processing

This works for all of the files in one folder (ie collected on one date). It then saves the data as a csv in the DataLoggerData folder with the appropriate date range as the title.

This first bit is a bit hacky to read in the files. Sorry :)

```{r read in files, eval=F}
setwd("/Users/mvevans/Google\ Drive/AthensFieldWork/DataLoggerData/Aug29-Sep19_2016")
#Grab all the CSV from working directory
file_list <- list.files(pattern="*\\.csv")
file_list <- file_list[grep(file_list, pattern="A")] #for adult loggers
```

```{r merge them all together, eval=F}
for (file in file_list){
  
  # if the merged dataset doesn't exist, create it
  if (!exists("dataset")){
    dataset <- read.table(file, header=F, sep=",")[-1, c(1,2,5)]
   
    colnames(dataset) <- c("Date", "Temp", "RH")
    #change to character and numeric 
    dataset$Date <- as.character(dataset[,1])
    dataset[,c(2,3)] <- apply(dataset[,c(2,3)], 2, function(x) as.numeric((x)))
    #add logger ID
    Pot_ID <- sub(".csv", "", file)
    dataset$Pot_ID <- rep(Pot_ID, nrow(dataset))
  }
  
  # if the merged dataset does exist, append to it
  if (exists("dataset")){
    temp_dataset <- read.table(file, header=F, sep=",")[-1,]
    #subset proper columns if it is a weird csv with Alm columns
    if (ncol(temp_dataset)!=3){
      temp_dataset <- temp_dataset[c(1,2,5)]
    }
    colnames(temp_dataset) <- c("Date", "Temp", "RH")
    #change to character and numeric 
    temp_dataset$Date <- as.character(temp_dataset[,1])
    temp_dataset[,c(2,3)] <- apply(temp_dataset[,c(2,3)], 2, function(x) as.numeric((x)))
    Pot_ID <- sub(".csv", "", file)
    temp_dataset$Pot_ID <- rep(Pot_ID, nrow(temp_dataset))
    
    dataset<-rbind(dataset, temp_dataset)
    rm(temp_dataset)
  }
}

#Add site ID
dataset$Site_ID <- as.factor(substring(dataset$Pot_ID,1,2))
#Add Class
dataset$Class[dataset$Site_ID %in% c("R1","R2","R3")] <- "Rural"
dataset$Class[dataset$Site_ID %in% c("S1","S2","S3")] <- "Suburban"
dataset$Class[dataset$Site_ID %in% c("U1","U2","U3")] <- "Urban"
dataset$Class <- as.factor(dataset$Class)
#Reformat Date
dataset$Date <- as.character(dataset$Date)
```

```{r check and save, eval=F}
length(unique(dataset$Pot_ID)) #should be 54
range(dataset$Temp)
#correct errors (Temperature over 55C)
dataset <- dataset[-(dataset$Temp>55),]
write.csv(dataset, file="../AdultTable_Aug29-Sep19_2016.csv", rownames=F)
```

## Add Cut-Offs for August Trial and Save

```{r load these grouped tables}
#setwd(getSrcDirectory()[1]) #when knitting
#setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
aug1 <- read.csv("../AdultTable_July14-Aug8_2016.csv")[,-1]
aug2 <- read.csv("../AdultTable_Aug8-Aug29_2016.csv")[,-1]
aug3 <- read.csv("../AdultTable_Aug29-Sep19_2016.csv")[,-1]
augustAll <- rbind(aug1, aug2, aug3)
#correct Date format
augustAll$Date <- as.character(augustAll$Date)
augustAll$Date <- strptime(augustAll$Date, format="%m/%d/%Y %H:%M:%S")
```

```{r cutoff and save, eval=F}
#with(augustAll[augustAll$Class=="Rural",],
     #plot(x=Date, y=Temp)
#)
# there are some dates in 1970???? these will be cutoff so it's fine
augustCrop <- augustAll[augustAll$Date>strptime("08-01-2016 17:00:00", format="%m-%d-%Y %H:%M:%S") & augustAll$Date<strptime("08-30-2016", format="%m-%d-%Y"),]
# with(augustCrop[augustCrop$Class=="Rural",],
#     plot(x=Date, y=Temp)
# )
#change working directory to here
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
write.csv(augustCrop, file="../data/microclimate/augustAdult.csv")
```