---
title: "Figures"
author: "Michelle Evans"
date: "March 21, 2018"
output: html_document
---

This document makes the figures for 'Carry-over effects of larval microclimate on the transmission potential of a mosquito-borne pathogen' (Evans et al.).

Paper Citation:

Evans MV, Shiau JC, Solano N, Brindley MA, Drake JM, Murdock, CC. Carry-over effects of larval microclimate on the transmission potential of a mosquito-borne pathogen. 

Data is loaded individually for each figure so they are easier to make individually.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#packages
library(ggplot2)
library(ggthemes)
library(raster)
library(sp)
library(ggmap)
library(rgdal)
library(rasterVis)
library(RColorBrewer)
library(viridis)
library(latticeExtra)
library(scales)
library(png)
library(grid)
library(dplyr)
```


```{r set colors}
colR <- "dodgerblue"
colS <- "gray60"
colU <- "maroon"

axisColor <- "gray40"
errorColor <- "gray20"
```

# Population Dynamics

```{r}
survTray <-  readRDS("denguePaper/data/emergence/clean/survivalTray.RData")
emergTray <- readRDS("denguePaper/data/emergence/clean/emergenceTray.RData")
growthDF2 <- readRDS("denguePaper/data/emergence/clean/growthRates.RData")
```




```{r}
#survival
survPlot <- ggplot(data=survTray)+
  geom_boxplot(aes(alpha=Block, x = as.factor(Class), y = numFSurv/50, fill = Class), width=0.7)+
  scale_fill_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  scale_color_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  scale_alpha_discrete(range=c(1, 0.1), name="Season", labels=c("Summer", "Fall"))+
  ylab("Percent Survival")+
  theme_bw() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        #strip.background = element_blank(),
        strip.text.x = element_text(size=10),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10))+
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(),
        axis.title.y= element_text(size=10),
        strip.text = element_text(size=10))+
  theme(legend.position="none")

#Emergence Plot
emergePlot <- ggplot(emergTray)+
  geom_boxplot(aes(alpha=Block, x = as.factor(Class), y = (devRate), fill = Class), width=0.7)+
  scale_fill_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  scale_alpha_discrete(range=c(1, 0.1), name="Season", labels=c("Summer", "Fall"))+
  ylab("Development Rate")+
   theme_bw() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        #strip.background = element_blank(),
        strip.text.x = element_text(size=10),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10))+
  theme(legend.position="none") +
  theme(strip.background = element_blank(),
  strip.text.x = element_blank()) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(),
        axis.title.y= element_text(size=10))

# growth plot
growthPlot <- ggplot(data=growthDF2)+
  geom_boxplot(aes(alpha=Block, x = as.factor(Class), y = r, fill = Class), width=0.7)+
  scale_fill_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  scale_alpha_discrete(range=c(1, 0.1), name="Season", labels=c("Summer", "Fall"))+
   theme_bw() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        #strip.background = element_blank(),
        strip.text.x = element_text(size=10),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10))+
  theme(legend.position="none") +
  theme(strip.background = element_blank(),
  strip.text.x = element_blank()) +
  ylab("Growth Rate (r')")+
  xlab("Land Class") +
  theme(axis.text.x = element_text(size=10)) +
  theme(axis.title = element_text(size=10), 
        axis.title.y= element_text(size=10))
```


```{r }
pdf(file="denguePaper/results/figures/forMS/demographic.pdf", width = 3.25, height=6, family="sans")
ggdraw()+
  draw_plot(survPlot, x=0.017, y=0.69, width=0.98, height=0.31)+
  draw_plot(emergePlot, x=0, y=0.38, width=1, height=0.31)+
  draw_plot(growthPlot, x=0.016, y=0, width=0.98, height=0.36)+
  draw_plot_label(label=c("A", "B", "C"),
                  x=c(0,0,0),
                  y=c(1,0.69,0.38))
dev.off()
```

# Infection Dynamics

## Class x Block

```{r infection data format}
infLong <- readRDS("denguePaper/data/infections/clean/infectionSummaryLong.RData")
```

Infection plot to combine in 6 panel figure in chunk 46. **NOTE** I am now trying to make this a seperate plot. A 6 panel figure just has too much going on.

```{r}
bodyPlot <- ggplot(data=infLong[infLong$type=="Body",], aes(x=Class, group=Block))+
  geom_bar(stat="identity", aes(y=mean.inf, alpha=Block, fill=Class), color="gray20", position=position_dodge(width=-0.9))+
  scale_y_continuous(breaks=c(0,0.5,1), minor_breaks = c(0.25, 0.75), labels=c("0%", "50%", "100%"), limits=c(0,1))+
  scale_fill_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(0.1,1), name="Season", labels=c("Fall", "Summer"))+
  geom_errorbar(aes(ymin=mean.inf-se.inf, ymax=mean.inf+se.inf), width=0.2, color="gray20", position =position_dodge(-0.9))+
  guides(fill = F, color = F,
         alpha = F) +
  ylab("Percent Positive") +
  theme_bw() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_blank(),
        axis.title.y=element_text(size = 10),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10))

headPlot <- ggplot(data=infLong[infLong$type=="Head",], aes(x=Class, group=Block))+
  geom_bar(stat="identity", aes(y=mean.inf, alpha=Block, fill=Class), color="gray20", position=position_dodge(width=-0.9))+
  scale_y_continuous(breaks=c(0,0.5,1), minor_breaks = c(0.25, 0.75), labels=c("0%", "50%", "100%"), limits=c(0,1))+
  scale_fill_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(0.1,1), name="Season", labels=c("Fall", "Summer"))+
  geom_errorbar(aes(ymin=mean.inf-se.inf, ymax=mean.inf+se.inf), width=0.2, color="gray20", position =position_dodge(-0.9))+
  ylab("Percent Positive") +
  guides(fill = F, color = F,
         alpha = F) +
  theme_bw() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_blank(),
        axis.title.y=element_text(size = 10),
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10))

SalivaPlot <- ggplot(data=infLong[infLong$type=="Saliva",], aes(x=Class, group=Block))+
  geom_bar(stat="identity", aes(y=mean.inf, alpha=Block, fill=Class), color="gray20", position=position_dodge(width=-0.9))+
  scale_y_continuous(breaks=c(0,0.5,1), minor_breaks = c(0.25, 0.75), labels=c("0%", "50%", "100%"), limits=c(0,1))+
  scale_fill_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(0.1,1), name="Season", labels=c("Fall", "Summer"))+
  geom_errorbar(aes(ymin=mean.inf-se.inf, ymax=mean.inf+se.inf), width=0.2, color="gray20", position =position_dodge(-0.9))+
  xlab("Land Class") +
  ylab("Percent Positive")+
  guides(fill = F, color = F,
         alpha = F) +
  theme_bw() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_text(size = 10),
        axis.title.y=element_text(size = 10),
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_text(size = 10),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10))
```


```{r}
pdf(file="denguePaper/results/figures/forMS/infection.pdf", width = 3.25, height=6, family="sans")
ggdraw()+
  draw_plot(bodyPlot, x=0, y=0.69, width=0.98, height=0.31)+
  draw_plot(headPlot, x=0, y=0.38, width=1, height=0.31)+
  draw_plot(SalivaPlot, x=0, y=0, width=0.98, height=0.36)+
  draw_plot_label(label=c("A", "B", "C"),
                  x=c(0,0,0),
                  y=c(1,0.69,0.38))
dev.off()
```


## Temperature

```{r}
seasons <- readRDS("denguePaper/data/infections/clean/seasonInfection.RData")
augEnvVar <- readRDS("denguePaper/data/microclimate/clean/summerInfectionClimate.RData")
octEnvVar <- readRDS("denguePaper/data/microclimate/clean/fallInfectionClimate.RData")

seasonSite <- seasons %>%
  dplyr::select(-Individual, - Wing) %>%
  dplyr::group_by(Block, Class, Site_ID) %>%
  summarise_all(funs(mean(.,na.rm=T), se=(sd(., na.rm=T)/sqrt(n())))) %>%
  ungroup()

#group with temperature data
seasonInfSite <- merge(seasonSite, rbind(augEnvVar,octEnvVar), by=c("Block", "Site_ID"))
```


```{r}
pdf(file="denguePaper/results/figures/extra/InfxTemp.pdf", width = 8, height=3, family="sans")
plotBody <- ggplot(data=seasonInfSite, aes(x=Temp_mean_mean, y=Body_mean))+
  geom_errorbar(aes(ymin=Body_mean-Body_se, ymax=Body_mean+Body_se), color=errorColor, width=0.1) +
  geom_smooth(method = "glm", formula = y ~ x, color = axisColor, method.args = list(family = gaussian(link = "log")), se = F) +
  geom_point(aes(color=Class, shape=Block), size=4.5) + 
  scale_color_manual(values=c(colR, colS, colU)) +
  theme_bw() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(),
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank())+
  ylab("Prop. Infected")+
  xlab("") +  
  theme(legend.position="none")

plotHead <- ggplot(data=seasonInfSite, aes(x=Temp_mean_mean, y=Head_mean))+
    geom_smooth(method = "glm", formula = y ~ x, color = axisColor, method.args = list(family = gaussian(link = "log")), se = F) +
   geom_errorbar(aes(ymin=Head_mean-Head_se, ymax=Head_mean+Head_se), color=errorColor, width=0.1) +
  geom_point(aes(color=Class, shape=Block), size=4) + 
  scale_color_manual(values=c(colR, colS, colU)) +
  theme_bw() +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(),
        axis.title.x = element_text(),
        axis.title.y=element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank())+
  xlab("Mean Daily Temperature (C)")+
  theme(legend.position="none")

plotSaliva <- ggplot(data=seasonInfSite, aes(x=Temp_mean_mean, y=Saliva_mean))+
    # geom_smooth(method = "glm", formula = y ~ x, color = axisColor, method.args = list(family = gaussian(link = "log")), se = F) +
  geom_errorbar(aes(ymin=Saliva_mean-Saliva_se, ymax=Saliva_mean+Saliva_se), color=errorColor, width=0.1) +
  geom_point(aes(color=Class, shape=Block), size=4.5) + 
  scale_color_manual(values=c(colR, colS, colU)) +
  theme_bw() +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(),
        axis.title.x = element_text(),
        axis.title.y=element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank()) +
  xlab("") +  
  scale_y_continuous(limits=c(0,1))+
  theme(legend.position="none")


plot_grid(plotBody, plotHead, plotSaliva, 
          labels=c("A", "B", "C"), 
          ncol=3)
dev.off()
```

## Wing Length

Not currently included in anything.

```{r}
seasons <- readRDS("denguePaper/data/infections/clean/seasonInfection.RData")
augEnvVar <- readRDS("denguePaper/data/microclimate/clean/summerInfectionClimate.RData")
octEnvVar <- readRDS("denguePaper/data/microclimate/clean/fallInfectionClimate.RData")
seasonInf <- seasonInf <- merge(seasons, rbind(augEnvVar, octEnvVar), by = c("Block", "Site_ID"))
```

```{r body inf x size plot, eval=F, include=F}
ggplot(data=seasonInf, aes(x=factor(Body), y=Wing))+
  geom_boxplot() +
  geom_jitter(shape=16, position=position_jitter(0.1), aes(color=factor(Class)), alpha=0.5) +
    theme_fivethirtyeight()+
  theme(axis.title = element_text()) +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank())+
  theme(legend.background = element_rect(fill = "transparent", colour = NA))+
  theme(legend.position="right", legend.direction="vertical") +
  scale_color_manual(values=c("dodgerblue", "gray10", "maroon"), labels=c("Rural", "Suburban", "Urban"))+
    scale_fill_manual(values=c("dodgerblue", "gray80", "maroon"), labels=c("Rural", "Suburban", "Urban")) +
  guides(color=F) +
  xlab("Body Positivity") +
  ylab("Wing Size")
```

# Vectorial Capacity

```{r}
VecCapacity <- readRDS("denguePaper/data/infections/clean/VecCapacity.RData")

siteTemp <- climateTray %>%
  group_by(Block, Class, Site_ID) %>%
  summarise(meanT = mean(meanT))

VecCapacityClimate <- left_join(VecCapacity, siteTemp, by = c("Block", "Class", "Site_ID"))
```

Calculate Difference Between each for Plot

```{r}
VecCapacityDiff <- VecCapacity %>%
  select(Block, Class, Site_ID, Calculation, VC) %>%
  spread(Calculation, VC) %>%
  mutate(Difference = FieldBased - GrandMean) %>%
  gather(Calculation, VC, FieldBased:Difference)
```


## Season x Class

```{r}
ggplot(data=VecCapacity)+
  geom_boxplot(aes(alpha=Calculation, x = as.factor(Class), y = VC, fill = Class), width=0.7)+
  scale_fill_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  scale_color_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  scale_alpha_discrete(range=c(1, 0.1), name="Calculation", labels=c("Field Based", "Grand Mean"))+
  ylab("Vectorial Capacity")+
  xlab("Land Class") + 
  theme_bw() +
  guides(color = "none", 
         fill = "none",
         alpha = guide_legend(override.aes = list(fill = colS))) +
  facet_wrap(~Block, dir = "h") + 
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        #strip.background = element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text = element_text(size=10),
        axis.title.y = element_text(size=10),
        strip.text = element_text(size=10))
```


## Temperature

Create predicted model outputs to better include the effect of temperature and random effect of site.

```{r}
VCTempModel <- lme4::lmer(VC+0.01 ~ meanT*Calculation + (1|Site_ID), 
                    data = VecCapacityClimate)

VecCapacityClimate$VChat <- predict(VCTempModel)
```


```{r}
ggplot(data = VecCapacityClimate, aes(x=meanT, y = VC+0.01)) +
  geom_point(aes(color = Class, 
                 shape = Calculation), 
             size = 3) +
  geom_smooth(aes(y = VChat, linetype = Calculation), 
            method = "lm", 
            se = F, 
            col = "gray20") +
  scale_shape_discrete(labels = c("Field Based", "Grand Mean")) +
  ylab("Vectorial Capacity") +
  xlab("Mean Temperature (C)") +
  scale_color_manual(values=c(colR, colS, colU), 
                     labels=c("Rural", "Suburban", "Urban"))+
  guides(linetype = "none")
```

# Map of Study Site

```{r}
impSurf <- raster("denguePaper/data/spatial/impSurfFocal.tif")
sites <- read.csv("denguePaper/data/spatial/sites.csv", header=T)
sitesSp <- SpatialPointsDataFrame(sites[,c('X','Y')], data= sites,
                                proj4string=crs("+init=epsg:4326"))
sitesSp <- spTransform(sitesSp, "+proj=utm +zone=17 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0")

counties <- readOGR("denguePaper/data/spatial/","cb_2016_us_county_500k") #downloaded from US census bureau 2015
acc <- counties[counties$GEOID==13059,]
acc <- spTransform(acc, "+proj=utm +zone=17 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0")
```

```{r}
#bound Athens around sites
athens <- crop(impSurf, c(262000, 297000, 3748000,3765000))
```

```{r}
#load map of georgia
gaMap <- readPNG("denguePaper/data/spatial/accMap.png")
mapRaster<- as.raster(gaMap)
```

```{r}
png("denguePaper/results/figures/forMS/siteMap.png", family="sans", width=7, height=4, units="in", res=500)
levelplot(athens, 
          margin=FALSE,                       
          colorkey=list(
            space='bottom',                   
            labels=list(at=c(0,5,40,100), 
                        labels=c("0%","5%", "40%", "100%"),
                        font=4),
            axis.line=list(col='black')       
          ),    
          par.settings=list(
            axis.line=list(col='gray20') 
          ),
          scales=list(draw=FALSE),
          col.regions=c("white", alpha("dodgerblue",0.7), alpha("maroon",0.7)),
          at=c(0,5,40,100)) +           
  layer(sp.polygons(sitesSp, 
                    pch=c(15,16,17)[sitesSp$CLASS], 
                    fill="gray20",
                    cex=1, lwd=2
                    ))+
  layer(sp.polygons(acc, lwd=2, col="black"))+
  layer(SpatialPolygonsRescale(layout.north.arrow(), offset = c(265000, 3749000), scale = 2000)) +
  layer({
    xs <- seq(267000, 269250, by=750)
    grid.rect(x=xs, y=3750000,
              width=750, height=300,
              gp=gpar(fill=rep(c('transparent', 'black'), 2)),
              default.units='native')
    grid.text(x=seq(266800, 270000, by=750), y=rep(c(3749500, 3750400), 2), label=c("","", "1.5", "", "3 km"),
              gp=gpar(cex=0.5), rot=0,
              default.units='native')
  })

dev.off()
```



# Infection Efficicency

This plot needs to be updated to make sure it still works.

```{r plot efficiency, eval=F}
efficiencyPlot <- readRDS("denguePaper/data/infections/clean/efficiencyPlot.RData")

#supplemental plot
ggplot(data=efficiencyPlot[order(meltAll$Block, decreasing=F),], aes(x=Class, group=Block))+
  geom_bar(stat="identity", aes(y=mean, alpha=factor(Block), fill=factor(Class)), color="gray20", position=position_dodge(width=-0.9))+
  facet_wrap(~type, nrow=3, dir="v") +
  scale_fill_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(1,0.3), name="Season", labels=c("Fall", "Summer"), guide=guide_legend(reverse=T))+
  geom_errorbar(aes(ymin=mean-SE, ymax=mean+SE), width=0.2, color="gray20", position =position_dodge(-0.9))+
  theme_base() + 
  xlab("Land Class") +
  ylab("Infection Efficiency") +
  guides(fill=F)
```








