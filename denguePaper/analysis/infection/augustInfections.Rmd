---
title: "August Infections"
author: "Michelle Evans"
date: "1/17/2016"
output: html_document
---

This document is for the analysis of the August 2016 Trial of Infections of the Dengue Microclimate project in Athens, GA.

```{r packages and setup}
library(dplyr)
library(xtable)
library(tidyr)
library(ggplot2) #for ggpairs
library(GGally) #for ggpairs
library(ROCR) #for prediction and AUC
library(lme4) #mixed models
library(scales)
library(vioplot)
```



```{r load and format data}
august <- read.csv("../../data/infections/raw/augustDengue.csv")
#drop head for now
#august <- select(august, -Head)
#adjust wingLength
august$Wing <- august$WingLength*august$conversion..mm.bar.
august <- select(august, -WingLength, -conversion..mm.bar.)
#dpi as factor
august$DPI <- as.factor(august$DPI)
#drop contaminated individuals
#august <- filter(august, Body != "C")
#august <- filter(august, Saliva != "C")
#add in class and site
august$site <- as.factor(substr(as.character(august$Individual), 1, 2))
august$class <- NULL
for (i in 1:nrow(august)){
  if (substr(august$site[i], 1,1)=="R"){
  august$class[i] <- "Rural"
  } else if (substr(august$site[i], 1,1)=="S"){
  august$class[i] <- "Suburban"
  } else if (substr(august$site[i], 1,1)=="U"){
  august$class[i] <- "Urban"
  }
}
august$class <- as.factor(august$class)

#convert Y and N to 1 and 0 for statistics
levels(august$Body) <- c("NA", 0, 1)
august$Body <- as.numeric(as.character(august$Body))
levels(august$Saliva) <- c("NA", 0, 1)
august$Saliva <- as.numeric(as.character(august$Saliva))
levels(august$Head) <- c( 0, 1)
august$Head <- as.numeric(as.character(august$Head))
#save with NAs for later
augustraw <- august
#omit NA for now
august <- na.omit(august)
```

```{r set color scheme}
colRural <- "dodgerblue"
colSuburban <- "gray80"
colUrban <- "maroon"

```

First, lets create a table of the percentages for an overview:

```{r summary table}
augustSumm <- augustraw %>%
  #drop individual
  select(-Individual) %>%
  group_by(DPI, site, class) %>%
  summarise_each(funs(mean(.,na.rm=T),sd(.,na.rm=T),se=(sd(., na.rm=T)/sqrt(n())))) %>%
  ungroup()
#print table
xtable(augustSumm)
```

## Summary Plots by Site

```{r plot by site function}
sitePlot <- function(summTable, dpi, bodyPart){
  cols <- c(1:3,grep(bodyPart, colnames(summTable)))
temp <- summTable[summTable$DPI==dpi,cols]
colnames(temp)[4:6] <- c("mean", "sd", "se")
  barCenters <- barplot(temp$mean, 
          col=c("gray80", "dodgerblue", "maroon")[temp$class],
          names.arg=temp$site,
          ylim=c(0,max(temp$mean+0.2)),
          main = paste0(bodyPart, " Infection (", dpi, "dpi)")
          )
  #add se bars
  segments(barCenters, temp$mean - temp$se , barCenters,
         temp$mean + temp$se, lwd = 1.5)
  
  arrows(barCenters, temp$mean - temp$se , barCenters,
         temp$mean + temp$se, lwd = 1.5, 
         angle = 90,
       code = 3, length = 0.05)
}

```

```{r plot:body, eval=F}

sitePlot(summTable=augustSumm, dpi="9", bodyPart = "Body")
sitePlot(summTable=augustSumm, dpi="14", bodyPart = "Body")
sitePlot(summTable=augustSumm, dpi="21", bodyPart = "Body")
```

```{r plot:head, eval=F}
sitePlot(summTable=augustSumm, dpi="9", bodyPart = "Head")
sitePlot(summTable=augustSumm, dpi="14", bodyPart = "Head")
sitePlot(summTable=augustSumm, dpi="21", bodyPart = "Head")
```

```{r plot:saliva,eval=F}
sitePlot(summTable=augustSumm, dpi="9", bodyPart = "Saliva")
sitePlot(summTable=augustSumm, dpi="14", bodyPart = "Saliva")
sitePlot(summTable=augustSumm, dpi="21", bodyPart = "Saliva")
```

With such small sample numbers, it is kind of hard to see if there is any real trend. I would say, however, that suburban mosquitoes tend to be more infected. What are the implications of this?

I should compare to the emergence curves. Looking at this it seems like emerging too fast or too slow may increase infection.

I think it would be better to plot all bodies on one and all saliva on one.



```{r beside plot function}
besidePlot <- function(summTable, bodyPart, byclass=F){
  if (byclass==T){
    cols <- c(1:2,grep(bodyPart, colnames(summTable)))
  } else cols <- c(1:3,grep(bodyPart, colnames(summTable)))
  tempLarge <- summTable[,cols]
  colnames(tempLarge)[(ncol(tempLarge)-2):ncol(tempLarge)] <- c("mean", "sd", "se")
  if (byclass==F){
  tempMean <- tempLarge %>%
    select(-sd,-se, -class) %>%
    spread( DPI, mean) %>%
    select(-site)
  } else tempMean <- tempLarge %>%
    select(-sd,-se) %>%
    spread( DPI, mean) %>%
    select(-class)
  if (byclass==T){
    rownames(tempMean) <- levels(summTable$class)
    } else rownames(tempMean) <- levels(summTable$site)
  tempMean <- t(as.matrix(tempMean))
  #colors
  if (byclass==T){
    colvec <- c(rep(colRural,3), rep(colSuburban,3), 
                            rep(colUrban,3))
  } else colvec <- c(rep(colRural,9), rep(colSuburban,9), 
                            rep(colUrban,9))
  #plot
  barCenters <- barplot(tempMean, 
                      beside=T,
                      col=colvec,
                      density = c(10,40,NA),
                      names.arg=colnames(tempMean),
                      ylim=c(0,0.80),
                      main = paste0("Dengue ", bodyPart," Infections"),
                      ylab = "Percent Infected"
                      )

    if (byclass==F){
  tempSE <- tempLarge %>%
    select(-sd,-mean,-class) %>%
    spread( DPI, se) %>%
    select(-site)
  } else   tempSE <- tempLarge %>%
    select(-sd,-mean) %>%
    spread( DPI, se) %>%
    select(-class)
  
  tempSE <- t(tempSE)
  
  #add se bars
  segments(barCenters, tempMean - tempSE , barCenters,
         tempMean + tempSE, lwd = 1.5)
  
  arrows(barCenters, tempMean - tempSE , barCenters,
         tempMean + tempSE,
         lwd = 1.5, 
         angle = 90,
         code = 3, length = 0.03)
  
  legend("topright", legend=c("9 dpi","14 dpi", "21 dpi"), density = c(10,40,NA),
       bty = "n", col = "gray80")
}
```

```{r barplot:besideBody}
pdf(file="../figures/augustBody.pdf", width = 8, height=6, family="sans")
besidePlot(summTable=augustSumm, bodyPart="Body")
dev.off()
```

```{r barplot:besideSaliva}
pdf(file="../figures/augustSaliva.pdf", width = 8, height=6, family="sans")
besidePlot(summTable=augustSumm, bodyPart="Saliva")
dev.off()
```

```{r barplot:besideSaliva}
pdf(file="../figures/augustHead.pdf", width = 8, height=6, family="sans")
besidePlot(summTable=augustSumm, bodyPart="Head")
dev.off()
```

## Statistical Analysis

I think that the best way to approach this type of binary data may be a logistic regression. We can approach this using a mixed-effects model, but first lets try it without to see if this is even the way to do it.

For now (as of 10-5-16) we will just look at wing length and land class and how that effects infection status.  In the future, tying microclimate into this would be good.

```{r infection logreg: bodies}
#ggpairs(augustraw[,-1]) #takes forever
#split into training(70) and testing(30)
set.seed(8675309)
train <- sample_frac(augustraw, 0.7)
test <- setdiff(augustraw, train)
#train a model on training data
model <- glm(Body~class+Wing+DPI+class*Wing+class*DPI, data=train,
             family=binomial(link="logit"))
summary(model)
#look at deviance using an anova
anova(model, test="Chisq")
#predict on test values and look at AUC value
p <- predict(model, newdata=test, type= "response")
pr <- prediction(p, test$Body)
auc <- performance(pr, measure = "auc")@y.values[[1]]
auc #pretty shitty
```

A normal old logistic regression gives us an auc of `r auc`, which isn't great but isn't horrible.  The model tells us a couple things about the predictor variables:

- Those mosquitoes sampled at 21 DPI are significantly more infected than those at 14 DPI. This isn't surprising given how slow this strain of dengue is in cells.

- The effect of wing size is slightly significant, with larger mosquitoes less likely to be infected.  The deviance table does not agree with this, however.

- Class had no significant effect on infection. 

I think it would be helpful to now add in some random effects of site.

```{r mixed logreg: bodies}
mixModel <- glmer(Body~class+ Wing + DPI + (1|site), data=train,
             family=binomial)
summary(mixModel)
#predict on test values and look at AUC value
p <- predict(mixModel, newdata=test, type= "response")
pr <- prediction(p, test$Body)
auc <- performance(pr, measure = "auc")@y.values[[1]]
auc #does perform better when controlling for random effects
```

When you add in the random effects of site, the effect of sampling time (dpi) becomes even more significant than before.  Also the model performs slightly better, with an AUC of `r auc`.

For plotting, it may be better to just use the whole dataset, rather than testing and training.

```{r mixed logreg all: body}
#split by DPI
mixModel14 <- glmer(Body~class + (1|site), data=augustraw[augustraw$DPI=="14",],
             family=binomial)
summary(mixModel14)
mixModel21 <- glmer(Body~class + (1|site), data=augustraw[augustraw$DPI=="21",],
             family=binomial)
summary(mixModel21)
#extract values to plot
bodyMix <- as.data.frame(c("Rural", "Suburban","Urban"))
bodyMix$mean.14 <- c(fixef(mixModel14)[[1]], fixef(mixModel14)[[1]] + fixef(mixModel14)[[2]], fixef(mixModel14)[[1]] + fixef(mixModel14)[[3]])
bodyMix$se.14 <- sqrt(diag(vcov(mixModel14, useScale = FALSE)))
bodyMix$mean.21 <- c(fixef(mixModel21)[[1]], fixef(mixModel21)[[1]] + fixef(mixModel21)[[2]], fixef(mixModel21)[[1]] + fixef(mixModel21)[[3]])
bodyMix$se.21 <- sqrt(diag(vcov(mixModel21, useScale = FALSE)))
```

This isn't working well for now. So I will just plot the mean and se per class normally for the GMCA conference.


##Plots by Class

```{r disease by class}
augustclassSumm <- augustraw %>%
  #drop individual
  select(-Individual, -site) %>%
  group_by(DPI, class) %>%
  summarise_each(funs(mean(.,na.rm=T),sd(.,na.rm=T),se=(sd(., na.rm=T)/sqrt(n())))) %>%
  ungroup()

pdf(file="../figures/augustHeadClass.pdf", width = 8, height=6, family="sans")
besidePlot(summTable=augustclassSumm, bodyPart="Head", byclass=T)
dev.off()

pdf(file="../figures/augustBodyClass.pdf", width = 8, height=6, family="sans")
besidePlot(summTable=augustclassSumm, bodyPart="Body", byclass=T)
dev.off()

pdf(file="../figures/augustSalivaClass.pdf", width = 8, height=6, family="sans")
besidePlot(summTable=augustclassSumm, bodyPart="Saliva", byclass=T)
dev.off()

```

## Saliva

```{r infection logreg: saliva}
#ggpairs(augustraw[,-1])
#split into training(70) and testing(30)
set.seed(8675309)
train <- sample_frac(augustraw, 0.7)
test <- setdiff(augustraw, train)
#train a model on training data
model <- glm(Saliva~class+Wing+DPI+class*Wing+class*DPI, data=train,
             family=binomial(link="logit"))
summary(model)
#look at deviance using an anova
anova(model, test="Chisq")
#predict on test values and look at AUC value
p <- predict(model, newdata=test, type= "response")
pr <- prediction(p, test$Body)
auc <- performance(pr, measure = "auc")@y.values[[1]]
auc #pretty shitty
```



#Wing Length and Infection

```{r linear plot}
pdf(file="figures/wingLengthInfectionlm.pdf", width = 8, height=6, family="sans")
plot(y=jitter(august$Body), x=august$Wing, pch=16, 
     col=c("gray80", "dodgerblue", "maroon")[august$class],
     ylab="Body Infections",
     xlab= "Wing Length (mm)",
     main= "Wing Length and Body Infection by Land Class")
with(august[august$class=="Rural",],abline(lm(Body~Wing), col="gray80"))
with(august[august$class=="Suburban",],abline(lm(Body~Wing), col="dodgerblue"))
with(august[august$class=="Urban",],abline(lm(Body~Wing), col="maroon"))
dev.off()
# or plot the opposite way
plot(x=as.factor(august$Body), y=august$Wing)
points(x=(as.factor(august$Body)), y=august$Wing,
       pch=16,
       col=c("gray80", "dodgerblue", "maroon")[august$class])
#create summary of mean wing length of those that are and are not infected
wingMean <- august[august$DPI=="21",] %>%
  group_by(class, Body) %>%
  summarise(wingmean=mean(Wing), n=n()) %>%
  ungroup()
```

There seems to be a different relationship with size and infection/competence depending on the land use. I suspect this is due to the time to emergence in suburban sites (maybe).

#Add in Climate data

```{r load climate data, eval=F}
climate <- read.csv("../data/microclimate/augustAdult.csv")[,-1]
climate <- climate[climate$Temp<75,]
summary <- climate %>%
  group_by(Site_ID) %>%
  summarise(Tmean=mean(Temp))
boxplot(climate$Temp~climate$Site_ID)
```

#Wing Length Analyses
These are kind of just junk wing length analyses for the GMCA conference.

```{r wing length summary stats}
wings <- augustraw[,6:8]
#mixed model I guess
require(lmerTest)
wingMod <- lmer(Wing~class + (1|site), data=wings)
summary(wingMod)
#create a dataframe to plot
fixef(wingMod)
Vcov <- vcov(wingMod, useScale=F)
se <- sqrt(diag(Vcov))
means <- c(fixef(wingMod)[[1]], (fixef(wingMod)[[1]] + fixef(wingMod)[[2]]), 
           (fixef(wingMod)[[1]] + fixef(wingMod)[[3]]))
ModtoPlot <- as.data.frame(cbind(means, se))
rownames(ModtoPlot) <- c("rural", "suburban", "urban")
wings <- na.omit(wings)
wings$classNum <- as.numeric(wings$class)
require(scales)
require(vioplot)
pdf("figures/wingLength.pdf", height=6, width=6)
par(mar=rep(6,4))
plot(x=c(0.5,1.5,2.5,3.5), y=rep(2.5,4), ylim=c(1.8, 3), pch=NA, xlim=c(0.5,3.5),
     xaxt='n', xlab="Land Class", ylab= "Wing Length (mm)", 
     cex.lab=1.5, cex.axis=1, las=2)
#points(wings$Wing~jitter(wings$classNum, factor=0.3), pch=16, 
       #col=c("dodgerblue", "gray20","maroon")[wings$classNum])
vioplot(wings$Wing[wings$class=="Rural"], col=alpha("dodgerblue",0.5), at=1,
        add=T, rectCol=NA, drawRect=F, clip=F)
points(x=1, y=mean(wings$Wing[wings$class=="Rural"]), pch=16, cex=2)
vioplot(wings$Wing[wings$class=="Suburban"], col=alpha("gray20",0.5), at=2,
        add=T, rectCol=NA, drawRect=F, clip=F)
points(x=2, y=mean(wings$Wing[wings$class=="Suburban"]), pch=16, cex=2)
vioplot(wings$Wing[wings$class=="Urban"], col=alpha("maroon",0.5), at=3,
        add=T, rectCol=NA, drawRect=F, clip=F)
points(x=3, y=mean(wings$Wing[wings$class=="Urban"]), pch=16, cex=2)
axis(side=1, at=c(1,2,3), labels=c("Rural", "Suburban", "Urban"), tck=0, cex=1.5)
dev.off()
```

## Estimating R0

This is just to make a figure of R0 for the TropMed poster:

Parameters in R0:

- m : mosquito density (estimate out of those survived)
- a (bite rate) :keep constant
- bc : vector competence : c is mosquitoes, b is humans
- mu : mosquito mortality : or p ^n where is p is survival, and n is EIP days
- EIP : extrinsic incubation period

```{r create VC function}

vcEq <- function(m, a, bc, p, n){
  vc <- (m * a^2 * bc * (p^n))/(-log(p))
}
```

I will parameterize this with the stuff from Erin's paper, then add in what effects I measured.

I want to calculate the VC for each tray.

- m : mosquitoes emerged out of original 50 (density)
- a : estimated from Mordecai et al 2016
- bc : calculated based on my infectiousness rates
- p : survival, from Mordecai et al 2016 (pEA)
- n : EIP, (1/PDR from Mordecai et al 2016) *used 14 becuase Mordecai estimate was 4.8 for 28C, which is just way too low*

To get the parameters for the temperature, we use the equations from Mordecai et al 2016 with the average temperature per tray as the temperature.

Briere equation: aa * T * (T - Tmin) * (Tmax - T)^(1/2)

```{r merge experimental data together by tray}
#read in dataframe to link trays with loggers
idMerge <- read.csv("../data/microclimate/trayLoggerID.csv")
#add climate to idMerge
climateTray <- merge(idMerge, climate, by="Pot_ID")
#create dataframe of average temperature by tray
tempByTray <- climateTray %>%
  group_by(Tray_ID, Site_ID, Class) %>%
  summarise(Temp=mean(Temp)) %>%
  ungroup()

# add in mosquito density per tray
emergence <- read.csv("../data/microclimate/emergenceAugust.csv")
byTray <- emergence %>%
  group_by(Class, Tray_Code, Sex) %>%
  summarise(cumulative=sum(Num_Emerge)) %>%
  ungroup()
byTrayF <- byTray[byTray$Sex=="F",]
R0params <- merge(tempByTray, byTrayF, by.x="Tray_ID", by.y="Tray_Code")
#drop extra columns
R0params <- select(R0params, -Class.y, -Sex)
R0params$m <- R0params$cumulative/50

#we only have infection by site, but we'll add it to each tray anyways
bc <- select(augustSumm21, site, Saliva_mean)
#merge infectiousness into parameter dataframe
R0params <- merge(R0params, bc, by.x="Site_ID", by.y="site")
```


It may be better to parameterize using rate summation. This involves calculating the parameters throughout a day with varying temperatures.  So I need to:

1. create a plot of the average daily temperature plot by hour for each tray
2. use these values to calculate the parameter at each of these
3. take mean value

```{r or use rate summation}
#### calculate hourly temperatures 
#split Date into date and hour
climateTray$Date <- as.POSIXct(climateTray$Date)
require(lubridate)
climateTray$Hour <- hour(climateTray$Date)
#aggregate by Hour
climateTrayHr <- climateTray %>%
  group_by(Tray_ID, Class, Site_ID, Hour) %>%
  summarise(Temp=mean(Temp)) %>%
  ungroup()

#### merge with other stuff as above
R0params <- merge(climateTrayHr, byTrayF, by.x="Tray_ID", by.y="Tray_Code")
#drop extra columns
R0params <- select(R0params, -Class.y, -Sex)
R0params$m <- R0params$cumulative/50

#we only have infection by site, but we'll add it to each tray anyways
bc <- select(augustSumm21, site, Saliva_mean)
#merge infectiousness into parameter dataframe
R0params <- merge(R0params, bc, by.x="Site_ID", by.y="site")
```


```{r parameterize based on mordecai et al}
R0params$a <- 1.93E-04 * R0params$Temp * (R0params$Temp - 10.25) * (38.32 - R0params$Temp)^(1/2)

#egg to adult survival is quadratic
#solve for equation with known points
x=c(9.04,29.33,25)
y=c(0,0,.85)
pEAMod <- lm(y ~ poly(x,2, raw=T))
R0params$p <- coef(pEAMod)[[2]] * R0params$Temp + coef(pEAMod)[[3]] * (R0params$Temp^2) + coef(pEAMod)[[1]]

#this is using the 28C from the incubator, but honestly it definitely took longer than that
R0params$n <- 1/(1.09E-04 * 28 * (28 - 10.39) * (43.05 - 28)^(1/2))
#let's use 14 for now
#R0params$n <- 14

#take mean value, this is specifically for rate summation, but should be fine for the other as well
R0params <- R0params %>%
  group_by(Tray_ID, Class.x, Site_ID) %>%
  summarise(m=mean(m), Saliva_mean=mean(Saliva_mean), a=mean(a, na.rm=T), p=mean(p, na.rm=T), n=mean(n, na.rm=T)) %>%
  ungroup()


```

Calculate vector competence

```{r vector competence calc}
#This is really small and based on only 100 mosquitoes, so let's multiply by 10
R0params$VC <- vcEq(m=R0params$m, a=R0params$a, bc=R0params$Saliva_mean, p=R0params$p, n=R0params$n) * 10
```

Now make some sweet bar plots comparing the disease risk:

```{r calculate means + se for bar plots}
r0Plot <- R0params %>%
  group_by(Class.x) %>%
  summarise(mean=mean(VC, na.rm=T), se=(sd(VC, na.rm=T)/sqrt(n()))) %>%
  ungroup()
```

```{r barplots}
pdf(file="figures/R0class.pdf", width = 8, height=6, family="sans")
par(mar=rep(6,4))
barCenters <- barplot(r0Plot$mean, 
                      col=c(colRural, colSuburban, 
                            colUrban),
                      names.arg=r0Plot$Class.x,
                      ylim=c(0,max(r0Plot$mean)+0.02),
                      #main = "Predicted Disease Risk",
                      ylab = "Relative Vectorial Capacity", #calculate per 1k initial larvae
                      las=1,
                      cex.lab=1.5, cex.axis=1,
                      xlab = "Land Class"
                      )
  #add se bars
segments(barCenters, r0Plot$mean - r0Plot$se , barCenters,
         r0Plot$mean + r0Plot$se, lwd = 1.5)
  
arrows(barCenters, r0Plot$mean - r0Plot$se , barCenters,
         r0Plot$mean + r0Plot$se,
         lwd = 1.5, 
         angle = 90,
         code = 3, length = 0.03)
dev.off()
```

```{r plot stats}
require(lmerTest)
r0stats <- lmerTest::lmer(VC~Class.x + (1|Site_ID), data=R0params)
summary(r0stats)
```