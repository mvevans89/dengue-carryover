---
title: "Athens Dengue Data"
author: "Michelle Evans"
date: ""
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
```

This document goes over the main results from the 2016 Athens Dengue Field Project.

```{r load packages and colors}
library(xtable)
library(tidyr)
library(ggplot2) 
library(lme4) #mixed models
library(car)
library(MASS)
library(gridExtra) #for facet grids later
library(caret)
library(ggthemes)
library(piecewiseSEM) #marginal rsquared
library(survival)
library(DHARMa) #mixed model residuals
library(survminer) #extracts survival objects
library(dplyr)

colR <- colRural <- "dodgerblue"
colS <- colSuburban <- "gray80"
colU <- colUrban <- "maroon"
```

```{r data loading and formatting}
formatData <- function(month){
  #' format infection data
  #' @params month (ie. "august")
  #' @returns dataframe of properly formatted data
  #adjust wingLength
  monthDf <- read.csv(paste0("../data/infections/raw/", month,"Dengue.csv"))
  #convert wingLength and drop extra columns
  monthDf$Wing <- monthDf$WingLength*monthDf$conversion..mm.bar.
  monthDf <- dplyr::select(monthDf, -WingLength, -conversion..mm.bar.)
  
  #dpi as factor
  monthDf$DPI <- as.factor(monthDf$DPI)
  
  #add in class and site
  monthDf$site <- as.factor(substr(as.character(monthDf$Individual), 1, 2))
  monthDf$class <- NULL
  for (i in 1:nrow(monthDf)){
    if (substr(monthDf$site[i], 1,1)=="R"){
    monthDf$class[i] <- "Rural"
    } else if (substr(monthDf$site[i], 1,1)=="S"){
    monthDf$class[i] <- "Suburban"
    } else if (substr(monthDf$site[i], 1,1)=="U"){
    monthDf$class[i] <- "Urban"
    }
  }
  monthDf$class <- as.factor(monthDf$class)
  
  #convert Y and N to 1 and 0 for statistics
  levels(monthDf$Body) <- c("NA", 0, 1)
  monthDf$Body <- as.numeric(as.character(monthDf$Body))
  levels(monthDf$Saliva) <- c("NA", 0, 1)
  monthDf$Saliva <- as.numeric(as.character(monthDf$Saliva))
  # august had no contaminated heads, so different corrections
  if (month=="august"){
    levels(monthDf$Head) <- c(0, 1)
  } else levels(monthDf$Head) <- c("NA",0, 1)
  monthDf$Head <- as.numeric(as.character(monthDf$Head))
  
  ##Fix false negatievs
  #adjust so that if saliva is positive, so is head
  #ddjust so that is head is positive, so is body
  monthDf$Head[monthDf$Saliva>0] <- 1
  monthDf$Body[monthDf$Head>0] <- 1
  
  return(monthDf)
}

august <- formatData("august")
oct <- formatData("october")
seasons <- rbind(august,oct)
seasons$block <- as.factor(c(rep("summer", nrow(august)), rep("fall", nrow(oct))))

seasonSumm <- seasons %>%
  filter(DPI==21) %>%
  #drop individual
  dplyr::select(-Individual, -site, -Wing, -DPI) %>%
  group_by(block, class) %>%
  summarise_each(funs(mean(.,na.rm=T),sd(.,na.rm=T),se=(sd(., na.rm=T)/sqrt(n())))) %>%
  ungroup()
```

```{r season plot function}
seasonPlot <- function(bodyPart, summTable=seasonSumm){
  cols <- c(1,2,grep(bodyPart, colnames(summTable)))
  tempLarge <- summTable[,cols]
  colnames(tempLarge)[3:5] <- c("mean", "sd", "se")
    
  tempMean <- tempLarge %>%
    dplyr::select(-sd,-se) %>%
    spread(block, mean) %>%
    dplyr::select(-class)
  
  #put summer before fall
  tempMean <- tempMean[,c(2,1)]

  
  rownames(tempMean) <- levels(tempLarge$class)
  tempMean <- t(as.matrix(tempMean))
  
  colvec <- c(rep(colRural,2), rep(colSuburban,2), 
                            rep(colUrban,2))
  
  barCenters <- barplot(tempMean, 
                      beside=T,
                      col=colvec,
                      density = c(40,NA),
                      names.arg=colnames(tempMean),
                      ylim=c(0,0.80)
                      )
  
  tempSE <- tempLarge %>%
    dplyr::select(-sd,-mean) %>%
    spread(block, se) %>%
    dplyr::select(-class)
  
   #put summer before fall
  tempSE <- tempSE[,c(2,1)]
  
   tempSE <- t(tempSE)
  
  #add se bars
  segments(barCenters, tempMean - tempSE , barCenters,
         tempMean + tempSE, lwd = 1.5)
  
  arrows(barCenters, tempMean - tempSE , barCenters,
         tempMean + tempSE,
         lwd = 1.5, 
         angle = 90,
         code = 3, length = 0.03)
  
  #legend("topright", legend=c("Summer", "Fall"), density = c(40,NA),
       #bty = "n", col = "gray80")
}
```

```{r load and format microclimate data}
climate <- read.csv('../data/microclimate/clean/2016TrialsAdult.csv')[,-1]
#toss out ridiculous levels
climate <- climate[climate$Temp<75,]
#format date
climate$Date <- strptime(climate$Date, format="%Y-%m-%d %H:%M:%S")
#draw out day
climate$Day <- as.Date(climate$Date)

# add tray id to climate data
trayID <- read.csv("../data/microclimate/trayLoggerID.csv") #read in IDs
climate <- merge(climate, trayID, by="Pot_ID")

#fix duplicates for R1T1
climate <- unique(climate)

#U2T2 and U1T2 are missing data
# range(climate[climate$Tray_ID=="U2T2", 'Date']) 
# range(climate[climate$Tray_ID=="U1T2", 'Date']) 

#drop U2T2 becuase it only has data until August 5th
inds <- which(climate$Tray_ID=="U2T2")
climate <- climate[-inds,]
rm(inds)

#U2T4 wasn't working right, reporting temps above 40C in October
inds <- which(climate$Tray_ID=="U2T4")
climate <- climate[-inds,]
rm(inds)

```

```{r load emergence data,echo=FALSE}
augEmerg <- read.csv("../data/emergence/raw/AugustEmergence.csv")
augEmerg$block <- as.factor("summer")
octEmerg <- read.csv("../data/emergence/raw/OctoberEmergence.csv")
octEmerg$block <- as.factor("fall")

allEmerg <- rbind(augEmerg, octEmerg)
```

```{r standardize and correct for emergence, echo=FALSE}
#filter out only days when infected mosquitoes were in the trays
octInf <- octEmerg %>%
  filter(Sex=="F") %>%
  filter((Site_Code %in% c("U3", "R3") & Day <= 21) |
           (Site_Code %in% c("U2", "U1", "S3") & Day <= 20) |
           (Site_Code %in% c("S1", "S2", "R1", "R2") & Day <= 24))

augInf <- augEmerg %>%
  filter(Sex=="F") %>%
    filter((Site_Code %in% c("U2", "U1", "S3", "R1") & Day <= 14) |
           (Site_Code %in% c("S1", "S2", "R2", "R3", "U3") & Day <= 17))
```

```{r process october climate, message=F, echo=FALSE}

octClim <- climate %>%
  dplyr::select(-Date) %>%
  filter(Day >= as.Date("2016-09-26","%Y-%m-%d")) %>%
  #filter out appropriate days
  filter((Site_ID %in% c("U3", "R3") & Day <= "2016-10-21") |
           (Site_ID %in% c("U2", "U1", "S3") & Day <= "2016-10-20") |
           (Site_ID %in% c("S1", "S2", "R1", "R2") & Day <= "2016-10-24")) %>%
  dplyr::select(-Site_ID, -Pot_ID, -Class) %>%
  #get daily averages by Tray
  group_by(Tray_ID, Day) %>%
  summarise_each(funs(mean(., na.rm=T), min(., na.rm=T), max(., na.rm=T))) %>%
  #calculate DTR
  mutate(DTR=Temp_max-Temp_min) %>%
  #get overall average over study period per tray (average daily values)
  ungroup() %>%
  dplyr::select(-Day) %>%
  group_by(Tray_ID) %>%
  summarise_each(funs(mean))

#calculate hours above a set Tmax and below a set Tmin based on Mordecai et al min and max r0, min=16C, max= 31 C

#calculate percent of time above and below temperatures

octBelow16 <- climate %>%
  dplyr::select(-Date) %>%
  filter(Day >= as.Date("2016-09-26","%Y-%m-%d")) %>%
  #filter out appropriate days
  filter((Site_ID %in% c("U3", "R3") & Day <= "2016-10-21") |
           (Site_ID %in% c("U2", "U1", "S3") & Day <= "2016-10-20") |
           (Site_ID %in% c("S1", "S2", "R1", "R2") & Day <= "2016-10-24")) %>%
  filter(Temp<16) %>%
  group_by(Tray_ID) %>%
  dplyr::summarise(Tcount=n()) %>%
  mutate(hoursBelow16=Tcount/6) %>%
  dplyr::select(-Tcount)



octAbove31 <- climate %>%
  dplyr::select(-Date) %>%
  filter(Day >= as.Date("2016-09-26","%Y-%m-%d")) %>%
  #filter out appropriate days
  filter((Site_ID %in% c("U3", "R3") & Day <= "2016-10-21") |
           (Site_ID %in% c("U2", "U1", "S3") & Day <= "2016-10-20") |
           (Site_ID %in% c("S1", "S2", "R1", "R2") & Day <= "2016-10-24")) %>%
  filter(Temp>31) %>%
  group_by(Tray_ID) %>%
  summarise(Tcount=n()) %>%
  mutate(hoursAbove31=Tcount/6) %>%
  dplyr::select(-Tcount)


#merge climate variables together
octClim <- merge(octClim, octBelow16, by="Tray_ID", all.x=T)
octClim <- merge(octClim, octAbove31, by="Tray_ID", all.x=T)

#add 0s
octClim$hoursAbove31[is.na(octClim$hoursAbove31)] <- 0
octClim$hoursBelow16[is.na(octClim$hoursBelow16)] <- 0

##new method of weighting climate by expanded infection
octInfExp <- octInf[rep(seq.int(1,nrow(octInf)), octInf$Num_Emerge),]
test <- merge(octInfExp, octClim, by.x="Tray_Code", by.y="Tray_ID", all.x=T)

octEnvVar <- test %>%
  dplyr::select(-Tray_Code,-Site, -Tray, - Class, - Month, - Day, - Exp_Day, - Sex, -Num_Emerge) %>%
  group_by(block,Site_Code) %>%
  summarise_each(funs(mean(.,na.rm=T),se=(sd(., na.rm=T)/sqrt(n())))) 

  
rm(test) #clear unused temporary dataframe
```

```{r august climate formatting, message=F, echo=FALSE}
##repeat above for August
augClim <- climate %>%
  dplyr::select(-Date) %>%
  filter(Day >= as.Date("2016-08-01","%Y-%m-%d")) %>%
    filter((Site_ID %in% c("U2", "U1", "S3", "R1") & Day <= "2016-08-14") |
           (Site_ID %in% c("S1", "S2", "R2", "R3", "U3") & Day <= "2016-08-17")) %>%
  dplyr::select(-Site_ID, -Pot_ID, -Class) %>%
  #get daily averages by Tray
  group_by(Tray_ID, Day) %>%
  summarise_each(funs(mean(., na.rm=T), min(., na.rm=T), max(., na.rm=T))) %>%
  #calculate DTR
  mutate(DTR=Temp_max-Temp_min) %>%
  #get overall average over study period per tray (average daily values)
  ungroup() %>%
  dplyr::select(-Day) %>%
  group_by(Tray_ID) %>%
  summarise_each(funs(mean))

#calculate hours above a set Tmax and below a set Tmin based on Mordecai et al min and max r0, min=16C, max= 31 C

#calculate number of hours above and below temperatures
#there are no hours below 16 in august
# augBelow16 <- climate %>%
#   dplyr::select(-Date) %>%
#   filter(Day >= as.Date("2016-08-01","%Y-%m-%d")) %>%
#     filter((Site_ID %in% c("U2", "U1", "S3", "R1") & Day <= "2016-08-14") |
#            (Site_ID %in% c("S1", "S2", "R2", "R3", "U3") & Day <= "2016-08-17")) %>%
#   filter(Temp<16) %>%
#   group_by(Tray_ID) %>%
#   summarise(Tcount=n()) %>%
#   mutate(hoursBelow16=Tcount/6) %>%
#   select(-Tcount)

augAbove31 <- climate %>%
  dplyr::select(-Date) %>%
  filter(Day >= as.Date("2016-08-01","%Y-%m-%d")) %>%
  filter((Site_ID %in% c("U2", "U1", "S3", "R1") & Day <= "2016-08-14") |
           (Site_ID %in% c("S1", "S2", "R2", "R3", "U3") & Day <= "2016-08-17")) %>%
  filter(Temp>31) %>%
  group_by(Tray_ID) %>%
  dplyr::summarise(Tcount=n()) %>%
  mutate(hoursAbove31=Tcount/6) %>%
  dplyr::select(-Tcount)


#merge climate variables together
augClim <- merge(augClim, augAbove31, by="Tray_ID", all.x=T)

#add 0s
augClim$hoursAbove31[is.na(augClim$hoursAbove31)] <- 0
augClim$hoursBelow16 <- 0

##new method of weighting climate by expanded infection
augInfExp <- augInf[rep(seq.int(1,nrow(augInf)), augInf$Num_Emerge),]
test <- merge(augInfExp, augClim, by.x="Tray_Code", by.y="Tray_ID", all.x=T)

augEnvVar <- test %>%
  dplyr::select(-Tray_Code,-Site, -Tray, - Class, - Month, - Day, - Exp_Day, - Sex, -Num_Emerge) %>%
  group_by(block,Site_Code) %>%
  summarise_each(funs(mean(.,na.rm=T),se=(sd(., na.rm=T)/sqrt(n())))) 

rm(test)

```

```{r, echo=FALSE}
#merge the summer and fall into one dataframe
oct$block <- as.factor("fall")
august$block <- as.factor("summer")
seasonInf <- merge(rbind(oct, august[august$DPI=="21",]), rbind(augEnvVar,octEnvVar), by.x=c("block", "site"), by.y=c("block", "Site_Code"))
```

# Infection Dynamics

**Methods Overview**: Mosquitoes were reared at 9 sites (3 rural, 3 suburban, 3 urban) and brought back to the lab to infect with dengue. Mosquitoes were reared in four trays at each site, but pooled by site for infections because there were not enough numbers. At 21 days post infection, they were processed to test for infection (body), dissemination (head), and infectiousness (saliva). This was repeated in the fall and summer. Climate data reported was averaged at the site level over the larval rearing period, and weighted to account for the amount of time mosquitoes spent in each tray.

## Infection by Class and Season


The first analysis was to determine how infection dynamics differed by class (rural, suburban, or urban) & season (summer or fall).

```{r season by class infection plot, fig.width=4, fig.height=6}
#png(file="../figures/forMS/seasonInfections.png", width = 4, height=6, units="in", res=500, family="sans")
par(mfrow=c(3,1), las=1, par(mar=c(5.1,6.1,4.1,2.1)))
seasonPlot(bodyPart="Body")
par(xpd=T)
legend(x=7.5, y=1.0, legend=c("Summer", "Fall"), density = c(40,NA),
       bty = "n", col = "gray80", cex=1.1)
mtext("Body")



seasonPlot(bodyPart="Head")
mtext("Head")
par(las=0)
mtext("Proportion Infected", side=2, line=3)



par(las=1)
seasonPlot(bodyPart="Saliva")
mtext("Saliva")
#dev.off()
```

A binomial generalized linear mixed-effects model was fit to the data, with class and season and their interaction as fixed effects and site as a random effect. To test for significance, we calculated an analysis of variance table using a Type II Wald chi square test for the fixed effects. Both class and season had significant effects on body and head infections, however there was no effect of either on saliva infection.

```{r seasonal infection stats}
#model #there was no interaction of class and block
mixModelseasonsBody21 <- lme4::glmer(Body~class + block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
Body21Aov <- car::Anova(mixModelseasonsBody21) #Wald test
#confint(mixModelseasonsBody21) #parametric bootstrap
drop1(mixModelseasonsBody21, test="Chisq") #Likelihood ratio test

mixModelseasonsHead21 <- lme4::glmer(Head~class + block  + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
Head21Aov <- car::Anova(mixModelseasonsHead21) #Wald test
confint(mixModelseasonsHead21) #profiled confidence interval

mixModelseasonsSaliva21 <- lme4::glmer(Saliva~class + block  + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
summary(mixModelseasonsSaliva21) #z-test
Saliva21Aov <- car::Anova((mixModelseasonsSaliva21)) #Wald test
confint(mixModelseasonsSaliva21) #profiled confidence interval
```

We found that infection in the body and head was significantly lower in the summer than the fall. Although there was a trend towards higher infection in the saliva in the summer, this was not significant (p=0.05676).  Land class also influence infection of both the body and head, with urban mosquitoes having lower rates of infection than rural and suburban mosquitoes. Saliva infections were unaffected by land class, however.

```{r seasonal infection tables, results='asis', eval=T}
knitr::kable(Body21Aov, caption="Mixed model Wald Test for body level infections.")
knitr::kable(Head21Aov, caption="Mixed model Wald Test for head infections.")
```


As both the summer season and urban land classes had the highest temperatures in their respective groups, this suggests that these differences in vector competence may be due to differences in temperature in the larval environment.

### Infection and Body Size

```{r}
with(na.omit(seasonInf), interaction.plot(x.factor=class, trace.factor=block, response=Wing, fun=mean, type="b", legend=T, ylab="Wing Size"))
```


In general, mosquitoes without head or body infections were larger than those that were infected. There was no difference in body size with regards to saliva infection. There is so much variation in these groups however, that there is no significant trend.

```{r}
wingInf <- seasonInf[seasonInf$Body %in% c(1,0),]

ggplot(data=wingInf, aes(Wing))+
  geom_histogram(aes(fill=class), bins=50)+
  facet_wrap(~Body, dir="v")+
  scale_fill_manual(values=c("dodgerblue", "gray80", "maroon"))+
  #geom_vline(aes(xintercept=mean(Wing)))+
  theme_base()+
  geom_vline(data=wingInf[wingInf$Body==1 & wingInf$class=="Rural",], aes(xintercept=mean(Wing, na.rm=T)), color="dodgerblue")+
    geom_vline(data=wingInf[wingInf$Body==0 & wingInf$class=="Rural",], aes(xintercept=mean(Wing, na.rm=T)), color="dodgerblue")+
    geom_vline(data=wingInf[wingInf$Body==1 & wingInf$class=="Suburban",], aes(xintercept=mean(Wing, na.rm=T)), color="black")+
    geom_vline(data=wingInf[wingInf$Body==0 & wingInf$class=="Suburban",], aes(xintercept=mean(Wing, na.rm=T)), color="black")+
      geom_vline(data=wingInf[wingInf$Body==1 & wingInf$class=="Urban",], aes(xintercept=mean(Wing, na.rm=T)), color="maroon")+
        geom_vline(data=wingInf[wingInf$Body==0 & wingInf$class=="Urban",], aes(xintercept=mean(Wing, na.rm=T)), color="maroon")+
        geom_vline(data=wingInf[wingInf$Body==0,], aes(xintercept=mean(Wing, na.rm=T)), color="black", size=2)+
        geom_vline(data=wingInf[wingInf$Body==1,], aes(xintercept=mean(Wing, na.rm=T)), color="black", size=2)+
  ggtitle("Distribution of Body Size across Body Infections")

ggplot(data=wingInf, aes(x=factor(Body)))+
  geom_violin(aes(y=Wing))
  
  
```


```{r}
# bodyWingDF <- seasonInf %>%
#   dplyr::select(Body, Wing, site, block, class) %>%
#   filter(!is.na(Body)) %>%
#   filter(!is.na(Wing))
# 
# 
# bodyWing <- glmer(Body~Wing + (1|block),
#                           data=bodyWingDF,
#                           family=binomial(link="logit"))
# summary(bodyWing)
# plot(bodyWing)
# qqnorm(resid(bodyWing))
# simulationOutput <- simulateResiduals(fittedModel = bodyWing)
# plotSimulatedResiduals(simulationOutput = simulationOutput)
# plotResiduals(bodyWingDF$Wing,  simulationOutput$scaledResiduals)
# 
# with(bodyWingDF,plot(x=jitter(Wing), y=Body, pch=c(16,17)[block], col=c(colR, colS, colU)[class]))
# with(bodyWingDF, abline(lm(Body~Wing)))
```


```{r}

wingInf <- seasonInf[seasonInf$Head %in% c(1,0),]

ggplot(data=wingInf, aes(Wing))+
  geom_histogram(aes(fill=class), bins=50)+
  facet_wrap(~Head, dir="v")+
  scale_fill_manual(values=c("dodgerblue", "gray80", "maroon"))+
  #geom_vline(aes(xintercept=mean(Wing)))+
  theme_base()+
  geom_vline(data=wingInf[wingInf$Head==1 & wingInf$class=="Rural",], aes(xintercept=mean(Wing, na.rm=T)), color="dodgerblue")+
    geom_vline(data=wingInf[wingInf$Head==0 & wingInf$class=="Rural",], aes(xintercept=mean(Wing, na.rm=T)), color="dodgerblue")+
    geom_vline(data=wingInf[wingInf$Head==1 & wingInf$class=="Suburban",], aes(xintercept=mean(Wing, na.rm=T)), color="black")+
    geom_vline(data=wingInf[wingInf$Head==0 & wingInf$class=="Suburban",], aes(xintercept=mean(Wing, na.rm=T)), color="black")+
      geom_vline(data=wingInf[wingInf$Head==1 & wingInf$class=="Urban",], aes(xintercept=mean(Wing, na.rm=T)), color="maroon")+
        geom_vline(data=wingInf[wingInf$Head==0 & wingInf$class=="Urban",], aes(xintercept=mean(Wing, na.rm=T)), color="maroon")+
        geom_vline(data=wingInf[wingInf$Head==0,], aes(xintercept=mean(Wing, na.rm=T)), color="black", size=2)+
        geom_vline(data=wingInf[wingInf$Head==1,], aes(xintercept=mean(Wing, na.rm=T)), color="black", size=2)+
  ggtitle("Distribution of Wing Size across Head Infections")
```

```{r}

wingInf <- seasonInf[seasonInf$Saliva %in% c(1,0),]

ggplot(data=wingInf, aes(Wing))+
  geom_histogram(aes(fill=class), bins=50)+
  facet_wrap(~Saliva, dir="v")+
  scale_fill_manual(values=c("dodgerblue", "gray80", "maroon"))+
  #geom_vline(aes(xintercept=mean(Wing)))+
  theme_base()+
  geom_vline(data=wingInf[wingInf$Saliva==1 & wingInf$class=="Rural",], aes(xintercept=mean(Wing, na.rm=T)), color="dodgerblue")+
    geom_vline(data=wingInf[wingInf$Saliva==0 & wingInf$class=="Rural",], aes(xintercept=mean(Wing, na.rm=T)), color="dodgerblue")+
    geom_vline(data=wingInf[wingInf$Saliva==1 & wingInf$class=="Suburban",], aes(xintercept=mean(Wing, na.rm=T)), color="black")+
    geom_vline(data=wingInf[wingInf$Saliva==0 & wingInf$class=="Suburban",], aes(xintercept=mean(Wing, na.rm=T)), color="black")+
      geom_vline(data=wingInf[wingInf$Saliva==1 & wingInf$class=="Urban",], aes(xintercept=mean(Wing, na.rm=T)), color="maroon")+
        geom_vline(data=wingInf[wingInf$Saliva==0 & wingInf$class=="Urban",], aes(xintercept=mean(Wing, na.rm=T)), color="maroon")+
        geom_vline(data=wingInf[wingInf$Saliva==0,], aes(xintercept=mean(Wing, na.rm=T)), color="black", size=2)+
        geom_vline(data=wingInf[wingInf$Saliva==1,], aes(xintercept=mean(Wing, na.rm=T)), color="black", size=2)+
  ggtitle("Distribution of Wing Size across Saliva Infections")
```

### Infection Efficiency

We can also look at infection efficiency. This is similar to what proportion of mosquitoes proceed to having head infections, out of those that have body infections.

```{r create efficiency data}
bodyEff <- seasons %>%
  filter(DPI==21) %>%
  #drop individual
  select(-Individual, -site, -Wing, -DPI) %>%
  group_by(block, class) %>%
  summarise_each(funs(bodyMean=mean(.,na.rm=T),bodySE=(sd(., na.rm=T)/sqrt(n()))), Body) %>%
  ungroup()

headEff <- seasons %>%
  filter(DPI==21) %>%
  filter(Body==1) %>%
  #drop individual
  select(-Individual, -site, -Wing, -DPI) %>%
  group_by(block, class) %>%
  summarise_each(funs(headMean=mean(.,na.rm=T),headSE=(sd(., na.rm=T)/sqrt(n()))), Head) %>%
  ungroup()

salEff <-  seasons %>%
  filter(DPI==21) %>%
  filter(Head==1) %>%
  #drop individual
  select(-Individual, -site, -Wing, -DPI) %>%
  group_by(block, class) %>%
  summarise_each(funs(salMean=mean(.,na.rm=T),salSE=(sd(., na.rm=T)/sqrt(n()))), Saliva) %>%
  ungroup()

#group together
allEff <- full_join(bodyEff, headEff, by=c("block", "class"))
allEff <- full_join(allEff, salEff, by=c("block", "class"))

library(tidyr)
meltMean <- allEff %>%
  select(block, class, contains("Mean")) %>%
  gather(key=variable, value=mean, -block, -class) 

meltMean$type <- rep(c("Body", "Head", "Saliva"), each=6)
  
meltSE <- allEff %>%
  select(block, class, contains("SE")) %>%
  gather(variable, SE, -block, -class)

meltSE$type <- rep(c("Body", "Head", "Saliva"), each=6)
  
meltAll <- full_join(meltMean, meltSE, by=c("class", "block", "type")) %>%
  select(-variable.x, -variable.y)


```


```{r plot efficiency}
ggplot(data=meltAll[order(meltAll$block, decreasing=F),], aes(x=class, group=block))+
  geom_bar(stat="identity", aes(y=mean, alpha=factor(block), fill=factor(class)), color="gray20", position=position_dodge(width=-0.9))+
  facet_wrap(~type, nrow=3, dir="v") +
  scale_fill_manual(values=c(colRural, colSuburban, colU))+
  scale_alpha_discrete(range=c(1,0.3), name="Season", labels=c("Fall", "Summer"), guide=guide_legend(reverse=T))+
  geom_errorbar(aes(ymin=mean-SE, ymax=mean+SE), width=0.2, color="gray20", position =position_dodge(-0.9))+
  theme_base() + 
  xlab("Land Class") +
  ylab("Infection Efficiency") +
  guides(fill=F)
  #theme(legend.title=element_text("Season"))
  
```

```{r efficiency stats}
#model 
mixModelseasonsBody21 <- lme4::glmer(Body~class + block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
Body21Aov <- car::Anova(mixModelseasonsBody21)

mixModelseasonsHead21 <- lme4::glmer(Head~class + block  + (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))
Head21Aov <- car::Anova(mixModelseasonsHead21) #no effect

mixModelseasonsSaliva21 <- lme4::glmer(Saliva~class + block  + (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Head==1,],
                          family=binomial(link="logit"))
Saliva21Aov <- car::Anova((mixModelseasonsSaliva21))
```


```{r efficiency infection tables, results='asis', eval=T}
knitr::kable(Body21Aov, caption="Significance of block and season on infection efficiency using a mixed effect model. This is identical to body infection above.")
knitr::kable(Head21Aov, caption="Significance of block and season on dissemination efficiency using a mixed effect model.")
knitr::kable(Saliva21Aov, caption="Significance of block and season on efficiency of salivary gland infections, using a mixed effect model.")
```

The two major obstacles to infectiousness are at the level of the body and the saliva.  Nearly all mosquitoes that have body infections also have disseminated infections, suggesting that midgut escape is relatively uncontrolled. However, of the disseminated infections, not all result in salivary gland infections, suggesting there is a mechanism blocking the virus from spreading to the salivary glands. The summer has a significantly higher efficiency than the fall season with regards to saliva, however, there is no difference in progression to disseminated infections.

## Infection and Microclimate

```{r create dataframe of site-aggregated infections}
seasonSite <- seasons %>%
  filter(DPI=="21") %>%
  dplyr::select(-Individual, -DPI, - Wing) %>%
  dplyr::group_by(block, class, site) %>%
  summarise_each(funs(mean(.,na.rm=T), se=(sd(., na.rm=T)/sqrt(n()))))

#group with temperature data
seasonInfSite <- merge(seasonSite, rbind(augEnvVar,octEnvVar), by.x=c("block", "site"), by.y=c("block", "Site_Code"))
```

Based on our findings above, we wanted to investigate if these patterns across season and class could be driven by microclimate, and how.

Because our experimental design was somewhat limited by the number of mosquitoes emerging, we grouped infections by site, rather than tray. This means that the microclimate data used is the same for all mosquitoes across sites, and that we cannot use it to predict individual level infections in a meaningful way, as we did for land class and season.  Therefore, our response variable in this analysis is the proportion of infected mosquitoes by site. This greatly reduces our sample size to 18, and therefore our statistical power.

The original starting set of variables were the average daily mean, minimum, and maximum temperature and relative humidity per site, daily temperature range, and  the average number of hours below 16C and above 31C. These temperature values were chosen based on thresholds from the Mordecai et al 2017 model of temperature dependence of dengue infections. Because maximum relative humidity is 100% for all sites, this variable was dropped. This resulted in eight total environmental covariates. Because temperature and relative humidity are so dependent on each other, this resulted in high correlations amongst the covariates.

To select covariates, I used a lasso regression in the `glmnet` package to conduct a step wise regression selection process based on the RMSE.  At each step, the variable whose omission resulted in the greatest drop in RMSE was dropped from the model.  As the selection process continued, previously dropped variables were again included in the model at each step to determine any effect on RMSE, and if this increased the error, were left out of the final model. Variable selection ended when the dropping of any of the included variables did not decrease the RMSE of the overall model.

Because most of these variables were still highly correlated ($\rho>0.9$), I then further selected models to eliminate collinearity amongst covariates. For this stage, I chose to use a linear mixed model because many of the exploratory visualizations were clearly linear, but with a strong random effect of season, which I could include in a mixed model. I modeled all variables individually and with an interaction term between another, if the correlation between the variables was less than 0.75. Models were chosen based on that which minimized the AICc and maximized the marginal $r^2$.

### Body Infection

LASSO regression identified mean, minimum, and maximum temperatures and daily temperature range as important variables, with mean temperature the most important. 

```{r body inf x climate stats}
respV <- "Body_mean"
predVs <- c("Temp_mean_mean","RH_mean_mean","Temp_min_mean","RH_min_mean", "Temp_max_mean", "DTR_mean", "hoursAbove31_mean", "hoursBelow16_mean")

myCols <- c(respV, predVs, "block")
modDF <- seasonInfSite %>%
  dplyr::select(one_of(myCols)) 
modDF <- na.omit(modDF)

finalBody <- lmer(Body_mean~ Temp_mean_mean + (1|block), data=modDF)
```


The final linear mixed model included mean temperature as a fixed effect. It had a marginal $r^2$ of `r  round(MuMIn::r.squaredGLMM(finalBody)[[1]],3)`. It also had the lowest AIC value out of all models.  

The relationship between mean temperature and body infection is negative ($\beta$=`r round(coef(finalBody)$block$Temp_mean_mean[[1]], 3)`) and significant ($p<0.05$). Higher temperatures seem to be leading to lower body infection rates.  Additionally, the relationship seems qualitatively different over the seasons, with the season as a random intercept explaining nearly as much of the variance as the mean temperature ($r^2_{GLMM_c}$=`r  round(MuMIn::r.squaredGLMM(finalBody)[[2]],3)`). This may be because the summer temperatures are near the thermal optimum, where the effect of temperature is more pronounced.

```{r body x meanT plot, fig.width=6, fig.height=4}
#png(file="../figures/forMS/bodyInfxMeanTemp.png", width = 6, height=4, units="in", res=500, family="sans")
par(family="sans")
ggplot(data=seasonInfSite, aes(x=Temp_mean_mean, y=Body_mean))+
  geom_errorbar(aes(ymin=Body_mean-Body_se, ymax=Body_mean+Body_se), color="gray20", width=0.1) +
  #geom_errorbarh(aes(xmin=Temp_mean_mean-Temp_mean_se, xmax=Temp_mean_mean+Temp_mean_se, y=Body_mean),color="gray20", height=0.05) + #not enough error to see
  geom_point(aes(color=class, shape=block), size=4.5) + 
  scale_color_manual(values=c(colRural, colSuburban, colUrban)) +
  theme_base() +
  ylab("Prop. Body Infection")+
  xlab("Mean Daily Temperature (C)") +  
  ggtitle("Infection Rates and Mean Temp.")
#dev.off()
```

### Head Infection

LASSO regression identified maximum temperature, mean temperature, and mean relative humidity as important variables.

```{r}
respV <- "Head_mean"
predVs <- c("Temp_mean_mean","RH_mean_mean","Temp_min_mean","RH_min_mean", "Temp_max_mean", "DTR_mean", "hoursAbove31_mean", "hoursBelow16_mean")

#create dataframe without NAs
myCols <- c(respV, predVs, "block")
modDF <- seasonInfSite %>%
  dplyr::select(one_of(myCols)) 
modDF <- na.omit(modDF)

finalHead <- lmer(Head_mean~ Temp_mean_mean + (1|block), data=modDF)
```

The final linear mixed model included mean temperature as a fixed effect. It had a marginal $r^2$ of `r  round(MuMIn::r.squaredGLMM(finalHead)[[1]],3)`. It only had the second lowest AIC value out of the models, however the marginal $r^2$ of the model with the lowest AIC, which included mean temperature and relative humidity and their interaction, was much lower than that of the final model, and included additional variables.

Similar to body infections, the relationship between mean temperature and head infection rates was negative ($\beta$=`r round(coef(finalHead)$block$Temp_mean_mean[[1]], 3)`). The effect of mean temperature was significant ($p<0.05$),  as measured using a Type II Wald chi square test. Again, much of the variation was explained by the random effect of season, resulting in a conditional $r^2$ of `r  round(MuMIn::r.squaredGLMM(finalHead)[[2]],3)`.

```{r head x meanT plot,  fig.width=6, fig.height=4}
#png(file="../figures/forMS/headInfxMeanTemp.png", width = 6, height=4, units="in", res=500, family="sans")
par(family="sans")
ggplot(data=seasonInfSite, aes(x=Temp_mean_mean, y=Head_mean))+
   geom_errorbar(aes(ymin=Head_mean-Head_se, ymax=Head_mean+Head_se), color="gray20", width=0.1) +
  #geom_errorbarh(aes(xmin=Temp_mean_mean-Temp_mean_se, xmax=Temp_mean_mean+Temp_mean_se), color="gray20", height=0.05) +
  geom_point(aes(color=class, shape=block), size=4) + 
  scale_color_manual(values=c(colRural, colSuburban, colUrban)) +
  theme_base() +
  ylab("Prop. Head Infection")+
  xlab("Mean Daily Temperature (C)")+
  ggtitle("Dissemination Rates and Mean Temp.")
#dev.off()
```


### Saliva Infection

As noted above, there was no significant difference in saliva infection across land class or season. I went through similar steps as above to investigate the effect of microclimate on saliva infection.  Although the best fitting linear model did include maximum temperature, it was not significant. Plots of saliva infection across different environmental variables show no clear trends.

```{r saliva x maxT plot, fig.width=6, fig.height=4}
#png(file="../figures/forMS/salivaInfxMaxTemp.png", width = 6, height=4, units="in", res=500, family="sans")
par(family="sans")
ggplot(data=seasonInfSite, aes(x=Temp_max_mean, y=Saliva_mean))+
  geom_errorbar(aes(ymin=Saliva_mean-Saliva_se, ymax=Saliva_mean+Saliva_se), color="gray20", width=0.05) +
  geom_errorbarh(aes(xmin=Temp_max_mean-Temp_max_se, xmax=Temp_max_mean+Temp_max_se), color="gray20", height=0.05) +
  geom_point(aes(color=class, shape=block), size=4) + 
  scale_color_manual(values=c(colRural, colSuburban, colUrban)) +
  theme_base() +
  #theme(text=element_text(size=12)) +
  ylab("Prop. Saliva Infection")+
  xlab("Maximum Daily Temperature (C)") +
  ggtitle("Infectious Rates and Mean Temp.")
#dev.off()
```

# Emergence and Survival Results

In general, we found that larval emergence and survival differed significantly across season, but not across land class.

```{r}
emergAug <- read.csv("../data/emergence/raw/AugustEmergence.csv")
emergAug$block <- "summer"

emergOct <- read.csv("../data/emergence/raw/OctoberEmergence.csv")
emergOct$block <- "fall"
#drop U3T1 in fall because it was eaten by ants
emergOct <- filter(emergOct, Tray_Code!="U3T1")

emergAll <- rbind(emergOct, emergAug)
#expand so each mosquito gets one row
emergExp <- emergAll[rep(seq.int(1,nrow(emergAll)), emergAll$Num_Emerge),
                      c(11, 2,4,5,6:9)]
#sum(emergAll$Num_Emerge)==nrow(emergExp) #quick check this worked

#get survival per tray
survSumm <- emergExp %>%
  filter(Sex=="F") %>%
  group_by(block, Tray_Code) %>%
  mutate(percSurv=n()) %>%
  ungroup() %>%
  dplyr::select(block, Class, Site_Code, Tray_Code, percSurv)
survSumm <- unique(survSumm)
```

```{r fillIn function}
fillIn <- function(df, endDay, totalMosq=50){
  #' Fill In Emergence Dates
  #' this function fills in for those mosquitoes that did not emerge so we do not have data for, it gives them an observation/event of 0 on the last day we found a mosquito emerged
  #' @param df the data frame you wish to fill in, in our case by pot
  #' @param endDay the last day of emergence
  #' @param totalMosq estimated starting number of mosquitoes per pot
  #' @returns dataframe with census data filled in for mosquitoes that did not emerge
  toRep <- df[1,]
  toRep$Exp_Day <- endDay
  toRep$event <- 0
  if(nrow(df)<totalMosq){
    toAdd <- toRep[rep(1, (totalMosq-nrow(df))),]
    allTest <- rbind(df, toAdd)
  } else {
    toAdd <- NA
    allTest <- NA
  }
  return(allTest)
}
```

```{r apply FillIn function}
applyFill <- function(season, allData=emergExp){
  #' Apply FillIn function
  #' @param season "fall" or "summer"
  #' @param allData full dataframe with row for each mosquito that emerged
  #' @returns censused data for the full season
  tempList <- list()
  tempDF <- allData
  tempDF <- tempDF[tempDF$Sex=="F",]
  tempDF <- tempDF[tempDF$block==season,]
  tempDF$event <- 1 #add emergence event
  for (i in 1:length(unique(tempDF$Tray_Code))){ 
    df <- tempDF[tempDF$Tray_Code==unique(tempDF$Tray_Code)[i],]
    endDay <- max(tempDF$Exp_Day)
    tempList[[i]] <- fillIn(df=df, endDay=endDay)
  }
  allSurv <- do.call(rbind.data.frame, tempList)
  return(allSurv)
}
```

```{r}
summerSurv <- applyFill(season="summer")
fallSurv <- applyFill(season="fall")
allSurv <- rbind(summerSurv, fallSurv)
```

```{r kaplan meier curves, fig.width=6, fig.height=4}
km.fit <- survival::survfit(Surv(Exp_Day, event) ~ block + Class, data=allSurv, type="kaplan-meier", se.fit=T, conf.int=0.95)


  data <- eval(km.fit$call$data)
  d <- survminer::surv_summary(km.fit, data=data)
  d$emerge <- (1 - d$surv)*100
  ggplot(data=d, aes(x=time, y=emerge, group=factor(strata)))+
    geom_line(aes(color=Class))+
    geom_ribbon(aes(ymin=(1-upper)*100, ymax=(1-lower)*100, fill=Class), alpha=0.4)+
    scale_color_manual(values=c("dodgerblue", "gray80", "maroon"), labels=c("Rural", "Suburban", "Urban"))+
    scale_fill_manual(values=c("dodgerblue", "gray80", "maroon"))+
    theme_base()+
    ylab("Percent of Females Emerged") +
    xlab("Day")+
    guides(color=F)+
    ggtitle("Female Larval Emergence")
```

This resulted in a difference in both the average time to emergence and survival across season, but not land class.

```{r survival plot and stats, results='asis'}
siteSumm <- emergExp %>%
  filter(Sex=="F") %>%
  group_by(block, Site_Code) %>%
  mutate(numSurv=n()) %>%
  ungroup() %>%
  dplyr::select(block, Class, Site_Code, numSurv)
siteSumm <- unique(siteSumm)

siteEmerg <- aov(numSurv ~  Class*block, data=siteSumm) # a better AIC than mixed model
summary(siteEmerg)
#plot(siteEmerg)
TukeyHSD(siteEmerg)

with(survSumm, interaction.plot(x.factor=Class, trace.factor=block, response=percSurv, fun=mean, type="b", legend=T, ylab="Percentage Emerged"))
mtext("Percentage Emerged by Class and Season")
```

```{r emergence time plot and stats, results='asis'}
emergExpF <- filter(emergExp, Sex=="F")
ggplot(data=emergExpF, aes(x=Site_Code, y=Exp_Day)) +
  geom_boxplot(aes(fill=Class)) +
  scale_fill_manual(values=c("dodgerblue", "gray80", "maroon"))+
  facet_wrap(~block) +  
  theme_base() +
  ylab("Emergence Day")+
  xlab("Site")+
  ggtitle("Day of Emergence by Site")

mixEmerge <- aov(Exp_Day ~  Class*block, 
                 data=emergExpF
                   )
plot(mixEmerge)
qqnorm(resid(mixEmerge))
summary(mixEmerge)
confint(mixEmerge)

knitr::kable(Anova(mixEmerge), caption = "Results from Mixed model on the effect of class and block on time to emergence.")

with(na.omit(emergExpF), interaction.plot(x.factor=Class, trace.factor=block, response=Exp_Day, fun=mean, type="b", legend=T, ylab="Emergence Day"))

```

The day of emergence differed significantly across block and class. Mosquitoes in the summer emerged on average 14 days sooner than those in the fall. Urban sites had faster development times than rural and suburban sites.


# Body Size

```{r load body size data}
augWing <- read.csv("../data/emergence/raw/AugustWingLength.csv", stringsAsFactors = F)
octWing <- read.csv("../data/emergence/raw/OctoberWingLength.csv",  stringsAsFactors = F)


#convert to mm & clean
augWing$mm <- augWing$Bars*augWing$Conversion.mm.bars.
octWing$mm <- octWing$Bars*octWing$Conversion.bars.mm.

octWing$site <- as.factor(substr(as.character(octWing$TrayCode), 1, 2))
augWing$site <- as.factor(substr(as.character(augWing$TrayCode), 1, 2))

getClass <- function(monthDf){
  monthDf$class <- NULL
  for (i in 1:nrow(monthDf)){
    if (substr(monthDf$site[i], 1,1)=="R"){
    monthDf$class[i] <- "Rural"
    }
    if (substr(monthDf$site[i], 1,1)=="S"){
    monthDf$class[i] <- "Suburban"
    }
    if (substr(monthDf$site[i], 1,1)=="U"){
    monthDf$class[i] <- "Urban"
    }
  }
  monthDf$class <- as.factor(monthDf$class)
  return(monthDf)
}

augWing <- getClass(augWing)
octWing <- getClass(octWing)

octWing$block <- "fall"
augWing$block <- "summer"

augWing$Date <- as.Date(as.character(augWing$Date), format="%m/%d/%Y")
octWing$Date <- as.Date(as.character(octWing$Date), format="%m/%d/%Y")

#add day of experiment
augWing$Exp_Day <- as.numeric(augWing$Date-as.Date("2016-08-01", format="%Y-%m-%d"))
octWing$Exp_Day <- as.numeric(octWing$Date-as.Date("2016-09-26", format="%Y-%m-%d"))

#rename traycode column to match
colnames(augWing)[1] <- "Tray_ID"
colnames(octWing)[1] <- "Tray_ID"

#combine
fallWing <- octWing %>%
  select(block, class, site, Tray_ID, Exp_Day, mm)

summerWing <- augWing %>%
    select(block, class, site, Tray_ID, Exp_Day, mm)

allWing <- rbind(summerWing, fallWing)
allWing$block<- as.factor(allWing$block)

#drop outlier in S2 (wing size =1.56 mm)
allWing <- allWing %>%
  filter(mm>1.6)
```

```{r}
wingMix <- lmer(mm~block*class +(1|site),
                data=allWing)
summary(wingMix)
plot(wingMix)
car::Anova(wingMix)

with(allWing, interaction.plot(x.factor=class, trace.factor=block, response=mm, fun="mean", type="b", legend=T))
```

With the exception of suburban sites, there is no significant difference across season and class. Suburban sites, however, are very small in the summer and large in the fall. This may be due to differences in microclimate, see below.

## Climate and Wing Length

```{r}
climate <- read.csv(file='../data/microclimate/clean/2016TrialsAdultCleaned.csv', stringsAsFactors = F)

climate$Day <- as.Date(climate$Day, format="%Y-%m-%d")
climate$Site_ID <- as.factor(climate$Site_ID)
climate$Tray_ID <- as.factor(climate$Tray_ID)

getClimate <- function(indMosq, climateDF=climate, season){
  #' This is a function to apply over the rows of the octWing and augWing data frames. Must have climate data loaded
  
  #' @param indMosq row of the dataframe for each individual mosquito
  #' @param climateDF the dataframe containing climate data every 10 minutes
  #' @param season, either "summer" or "fall"
  #' @returns formatted data with climate and winglength for the individual mosquito
  
  
  #get date range
  startDate <- ifelse(season=="summer", "2016-08-01", "2016-09-26")
  startDate <- as.Date(startDate, format="%Y-%m-%d")
  endDate <- indMosq$Date
  
  #subset temperature data
  try(climSubset <- climateDF %>%
    filter(Tray_ID==as.character(indMosq$Tray_ID)) %>%
    filter(Day>startDate & Day<endDate),
    silent=T)
  
  #now take mean temperature
  tempMean <- climSubset %>%
    summarise(Tmean=mean(Temp, na.rm=T))
  
  # if (nrow(climSubset)<1000){
  #   climSubset <- climate %>%
  #     filter(Site_ID==indMosq$site) %>%
  #     filter(Day>startDate & Day<endDate)
  # }
  
  #merge this all together
  #mosqFormat <- cbind(indMosq[,c('block','class','site','Tray_ID','Exp_Day', 'mm')], Tmean=tempMean$Tmean)
  
  return(tempMean$Tmean)
}

augWing$Temp <- NA
for(i in 1:nrow(augWing)){
  indMosq <- augWing[i,]
  augWing$Temp[i] <- getClimate(indMosq, season="summer")
}

octWing$Temp <- NA
for(i in 1:nrow(octWing)){
  indMosq <- octWing[i,]
  octWing$Temp[i] <- getClimate(indMosq, season="fall")
}

#combine
fallWing <- octWing %>%
  select(block, class, site, Tray_ID, Exp_Day, mm, Temp)

summerWing <- augWing %>%
    select(block, class, site, Tray_ID, Exp_Day, mm, Temp)

allWing <- rbind(summerWing, fallWing)
allWing$block<- as.factor(allWing$block)

#drop outlier in S2 (wing size =1.56 mm)
allWing <- allWing %>%
  filter(mm>1.6)
```

```{r}
ggplot(data=allWing, aes(x=Temp, y=mm)) +
  geom_point(aes(col=factor(class), shape=factor(block))) + 
  theme_base() + 
  facet_wrap(~block) +
  geom_smooth(method="lm")
```

```{r}
modDf <- na.omit(allWing)
wingTemp <- lmer(mm~Temp +(1|site),
                 data=modDf)
summary(wingTemp)
plot(wingTemp)
car::Anova(wingTemp)
AIC(wingTemp)
confint(wingTemp)

preds <- predict(wingTemp)
ranef(wingTemp)
coef(wingTemp)

plot(x=modDf$Temp, y=preds)
```

Temperature had no significant effect on wing length. This makes sense, as we saw very little difference across site and land use, with the exception of suburban sites.