---
title: "Emergence Exploration"
author: "Michelle Evans"
date: "August 25, 2016"
output: html_document
---

```{r load packages and setup, echo=F, message=F}
library(dplyr)
```

This is a document used to explore the emergence data from the 2016 Athens Albopictus Field Project, October (Fall) Trial.

#Emergence for Infections

The data is from Google Sheets document named ['October Emergence (Infections only)'](https://docs.google.com/spreadsheets/d/1gxVditu8jU5z9wICneYsovoTR_XmrwE3-DTvSWMFK0o/edit?usp=sharing)

```{r load data}
emergence <- read.csv("../../data/emergence/raw/SeptemberEmergence.csv")
```

First let's look at how many have emerged out of each tray:

```{r emergence by tray}
#cumulative emergence
byTray <- emergence %>%
  group_by(Class, Tray_Code, Sex) %>%
  summarise(cumulative=sum(Num_Emerge)) %>%
  ungroup()
#order by tray
byTray <- byTray[order(byTray$Tray_Code),]
#make a little bar graph
barplot(byTray$cumulative, 
        names.arg = byTray$Tray_Code, col=c("pink",
                                            "dodgerblue")[byTray$Sex],
        xlab="Tray",
        ylab="Cumulative Emerged",
        main="Cumulative Albo Emerged by Tray to Infect")
#just the women
byTrayF <- byTray[byTray$Sex=="F",]
barplot(byTrayF$cumulative, 
        names.arg = byTrayF$Tray_Code, col=c("dodgerblue",
                                            "black", "maroon")[byTrayF$Class],
        xlab="Tray",
        ylab="Cumulative Emerged",
        main="Cumulative Female Albo Emerged by Tray")
legend("topleft", legend=levels(byTrayF$Class), col=c("dodgerblue",
                                            "black", "maroon"), pch=15)
```

Looks like a pretty good number, now let's go by site.

```{r emergence by site}
bySite <- emergence %>%
  group_by(Class, Site_Code, Sex) %>%
  summarise(cumulative=sum(Num_Emerge)) %>%
  ungroup()
#make a little bar graph
barplot(bySite$cumulative, 
        names.arg = bySite$Site_Code, col=c("pink",
                                            "dodgerblue")[bySite$Sex],
        xlab="Site",
        ylab="Cumulative Emerged",
        main="Cumulative Albo Emerged by Site")
bySite
#just the women
bySiteF <- bySite[bySite$Sex=="F",]
barplot(bySiteF$cumulative, 
        names.arg = bySiteF$Site_Code, col=c("dodgerblue",
                                            "black", "maroon")[bySiteF$Class],
        xlab="Site",
        ylab="Cumulative Emerged",
        main="Cumulative Female Albo Emerged by Site")
legend("topleft", legend=levels(bySiteF$Class), col=c("dodgerblue",
                                            "black", "maroon"), pch=15)

```


I would like at least 100 females from each site to blood feed.  Currently there are **`r nrow(bySiteF[bySiteF$cumulative>100,])`** sites that meet that criteria.

#Age Distribution of Females

I also need to know the age distribution of the mosquitoes I am feeding, so I can plan the best day to feed on.

```{r current female age distribution}
females <- emergence[emergence$Sex=="F",]
#calculate age
#needs to be calculated for both feed dates
#feed date 1: 8-16-2016: R1, U1, U2, S3
#feed date 2: 8-19-2016: R2, R3, U3, S1, S2
if (females$Month[1]==7){
  for (i in 1:nrow(females)){
    if (females$Site[i] %in% c(2, 7, 3, 5)) {
    females$age[i] <- as.numeric(format(as.Date("2016-07-17"),
                                        "%d"))-females$Day[i]
    } else females$age[i] <- as.numeric(format(as.Date("2016-07-20"),
                                               "%d"))-females$Day[i]
  }
} else if (females$Month[1]==8) {
  for (i in 1:nrow(females)){
    if (females$Site[i] %in% c(4, 7, 8, 6)) {
    females$age[i] <- as.numeric(format(as.Date("2016-08-16"),
                                        "%d"))-females$Day[i]
    } else females$age[i] <- as.numeric(format(as.Date("2016-08-19"),
                                               "%d"))-females$Day[i]
  }
} else if (females$Month[1]==10) {
  for (i in 1:nrow(females)){
    if (females$Site[i] %in% c(1, 4, 7, 8, 9)) { #first round of infections
    females$age[i] <- as.numeric(format(as.Date("2016-10-23"),
                                        "%d"))-females$Day[i]
    } else females$age[i] <- as.numeric(format(as.Date("2016-10-25"),
                                               "%d"))-females$Day[i]
  }
}


#new dataframe listing each individual mosquito by site
require(dplyr)
femaleSite <- select(females, Site_Code, Num_Emerge, age)
#repeat each row based on number of mosquitoes emerged, each mosq gets a row
femaleSiteExpanded <- femaleSite[rep(seq.int(1,nrow(femaleSite)), femaleSite$Num_Emerge),c(1,3)]
#can now calculate mean and median age by site
siteAge <- femaleSiteExpanded %>%
  group_by(Site_Code) %>%
  summarise(median(age), mean(age), min(age), max(age)) %>%
  ungroup()
```
So we have the following mean and median ages per site:
```{r}
siteAge
```

All of the sites had a similar mean age when they were infected, of between 4 - 7 days old.

We can also look at plots of emergence over time to have a better idea:

```{r emergence curves}
curve <- emergence[emergence$Sex=="F",] %>%
  group_by(Class, Site_Code, Exp_Day) %>%
  summarise(emerged=sum(Num_Emerge)) %>%
  mutate(cumulative=cumsum(emerged)) %>%
  ungroup()
#order by site and day
curve <- curve[with(curve, order(Site_Code, Exp_Day)),]
```

```{r plotting function}
emergencePlots <- function(site){
  par(mfrow=c(1,2))
  #set plot color
  if (startsWith(site, "R")) {
    siteColor <- "dodgerblue"
  } else if (startsWith(site, "S")) {
    siteColor <- "gray60"
  } else if (startsWith(site, "U")) {
    siteColor <- "maroon"
  }
  #cumulative plot
with(curve[curve$Site_Code==site,], plot(y=cumulative, x=Exp_Day, xlim=c(15, 40), ylim=c(0,100), pch=19, col=siteColor, main=paste(site, "Cumulative Emergence")))
#lines for cumulative
with(curve[curve$Site_Code==site,], lines(y=cumulative, x=Exp_Day, xlim=c(15, 40), ylim=c(0,100), col=siteColor))
#mtext
with(curve[curve$Site_Code==site,], mtext(paste("Cumulative= ", max(cumulative), "/ First Day= ", min(Exp_Day), sep="")))
#emergence plot
with(curve[curve$Site_Code==site,], plot(y=emerged, x=Exp_Day, xlim=c(15, 40), ylim=c(0,25), pch=19, col=siteColor, main=paste(site, "emergence by Day")))
#lines
with(curve[curve$Site_Code==site,], lines(y=emerged, x=Exp_Day, xlim=c(15, 40), ylim=c(0,25), col=siteColor))
#mtext
with(curve[curve$Site_Code==site,], mtext(paste("Cumulative= ", max(cumulative), "/ First Day= ", min(Exp_Day), sep="")))
}
```

Now that I have a sweet function written, I can apply it over all of the sites. To interpret these plots, the cumulative emergence is plotted on the left, with emergence per day on the right.  This allows us to see the rate of emergence on the left, and the peak emergence on the right.  Using this, we can see when emergence is slowing down and plan infections accordingly.

```{r plot them ALL, echo=F}
sapply(as.vector(levels(curve$Site_Code)), FUN=emergencePlots)

```

#The Slow Down

It is also helpful to see when the last mosquito emerged from each tray, to know when the experiment is over. The following is a list of the trays which have not had a mosquito emerge for three days, and the last day of emergence for them:

```{r last days, eval=T}
trayLastDay <- emergence %>%
  group_by(Tray_Code) %>%
  filter(Num_Emerge>0) %>%
  summarise(lastDay=max(Exp_Day)) %>%
  ungroup()

a <- trayLastDay[(42-trayLastDay$lastDay)>3,]
(a[1:nrow(a),])
```

There are too many to show, so let's look at the ones that have had a mosquito emerge in the past three days:

```{r last three days, eval=T}
trayLastDay[as.numeric(42-trayLastDay$lastDay)<=3,]
```