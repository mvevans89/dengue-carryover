---
title: "EvansCode"
author: "Michelle Evans"
date: ""
output: html_document
---

#Set-Up

*NOTE*: Working directory should be set to source file location.

```{r knitr setup}
knitr::opts_chunk$set(echo = T)
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
```

```{r package and color setup}
library(xtable)
library(tidyr)
library(ggplot2) 
library(lme4) #mixed models
library(broom) #easy model comparison
library(MuMIn)
library(car)
library(MASS)
library(gridExtra) #for facet grids later
library(cowplot)
library(caret)
library(ggthemes)
library(survival)
library(DHARMa) #mixed model residuals
library(survminer) #extracts survival objects
library(dplyr)
library(multcomp)

colR <- "dodgerblue"
colS <- "gray60"
colU <- "maroon"

axisColor <- errorColor <- "gray40"
```

# Data Loading and Formatting

Load and format infection data:
```{r data loading and formatting}
formatData <- function(month){
  #' format infection data
  #' @params month (ie. "august")
  #' @returns dataframe of properly formatted data
  #adjust wingLength
  monthDf <- read.csv(paste0("../data/infections/raw/", month,"Dengue.csv"))
  #convert wingLength and drop extra columns
  monthDf$Wing <- monthDf$WingLength*monthDf$conversion..mm.bar.
  monthDf <- dplyr::select(monthDf, -WingLength, -conversion..mm.bar.)
  
  #dpi as factor
  monthDf$DPI <- as.factor(monthDf$DPI)
  
  #add in class and site
  monthDf$site <- as.factor(substr(as.character(monthDf$Individual), 1, 2))
  monthDf$class <- NULL
  for (i in 1:nrow(monthDf)){
    if (substr(monthDf$site[i], 1,1)=="R"){
    monthDf$class[i] <- "Rural"
    } else if (substr(monthDf$site[i], 1,1)=="S"){
    monthDf$class[i] <- "Suburban"
    } else if (substr(monthDf$site[i], 1,1)=="U"){
    monthDf$class[i] <- "Urban"
    }
  }
  monthDf$class <- as.factor(monthDf$class)
  
  #convert Y and N to 1 and 0 for statistics
  levels(monthDf$Body) <- c("NA", 0, 1)
  monthDf$Body <- as.numeric(as.character(monthDf$Body))
  levels(monthDf$Saliva) <- c("NA", 0, 1)
  monthDf$Saliva <- as.numeric(as.character(monthDf$Saliva))
  # august had no contaminated heads, so different corrections
  if (month=="august"){
    levels(monthDf$Head) <- c(0, 1)
  } else levels(monthDf$Head) <- c("NA",0, 1)
  monthDf$Head <- as.numeric(as.character(monthDf$Head))
  
  ##Fix false negatievs
  #adjust so that if saliva is positive, so is head
  #ddjust so that is head is positive, so is body
  monthDf$Head[monthDf$Saliva>0] <- 1
  monthDf$Body[monthDf$Head>0] <- 1
  
  return(monthDf)
}

august <- formatData("august")
oct <- formatData("october")
seasons <- rbind(august,oct)
seasons$block <- as.factor(c(rep("summer", nrow(august)), rep("fall", nrow(oct))))

seasonSumm <- seasons %>%
  filter(DPI==21) %>%
  #drop individual
  dplyr::select(-Individual, -site, -Wing, -DPI) %>%
  group_by(block, class) %>%
  summarise_all(funs(mean(.,na.rm=T),sd(.,na.rm=T),se=(sd(., na.rm=T)/sqrt(n())))) %>%
  ungroup()
```

Load and format microclimate data
```{r load and format microclimate data}
climate <- read.csv('../data/microclimate/clean/2016TrialsAdult.csv')[,-1]
#toss out ridiculous levels
climate <- climate[climate$Temp<75,]
#format date
climate$Date <- strptime(climate$Date, format="%Y-%m-%d %H:%M:%S")
#draw out day
climate$Day <- as.Date(climate$Date)

# add tray id to climate data
trayID <- read.csv("../data/microclimate/trayLoggerID.csv") #read in IDs
climate <- merge(climate, trayID, by="Pot_ID")

#fix duplicates for R1T1
climate <- unique(climate)

#U2T2 and U1T2 are missing data
# range(climate[climate$Tray_ID=="U2T2", 'Date']) 
# range(climate[climate$Tray_ID=="U1T2", 'Date']) 

#drop U2T2 becuase it only has data until August 5th
inds <- which(climate$Tray_ID=="U2T2")
climate <- climate[-inds,]
rm(inds)

#U2T4 wasn't working right, reporting temps above 40C in October
inds <- which(climate$Tray_ID=="U2T4")
climate <- climate[-inds,]
rm(inds)
```

Load and format emergence data
```{r load emergence data,echo=FALSE}
augEmerg <- read.csv("../data/emergence/raw/AugustEmergence.csv")
augEmerg$block <- as.factor("summer")
octEmerg <- read.csv("../data/emergence/raw/OctoberEmergence.csv")
octEmerg$block <- as.factor("fall")

allEmerg <- rbind(augEmerg, octEmerg)
```

Crop and standardize emergence data to be used with infections
```{r standardize and correct for emergence, echo=FALSE}
#filter out only days when infected mosquitoes were in the trays
octInf <- octEmerg %>%
  filter(Sex=="F") %>%
  filter((Site_Code %in% c("U3", "R3") & Day <= 21) |
           (Site_Code %in% c("U2", "U1", "S3") & Day <= 20) |
           (Site_Code %in% c("S1", "S2", "R1", "R2") & Day <= 24))

augInf <- augEmerg %>%
  filter(Sex=="F") %>%
    filter((Site_Code %in% c("U2", "U1", "S3", "R1") & Day <= 14) |
           (Site_Code %in% c("S1", "S2", "R2", "R3", "U3") & Day <= 17))
```

```{r process october climate, message=F, echo=FALSE}
octClim <- climate %>%
  dplyr::select(-Date) %>%
  filter(Day >= as.Date("2016-09-26","%Y-%m-%d")) %>%
  #filter out appropriate days
  filter((Site_ID %in% c("U3", "R3") & Day <= "2016-10-21") |
           (Site_ID %in% c("U2", "U1", "S3") & Day <= "2016-10-20") |
           (Site_ID %in% c("S1", "S2", "R1", "R2") & Day <= "2016-10-24")) %>%
  dplyr::select(-Site_ID, -Pot_ID, -Class) %>%
  #get daily averages by Tray
  group_by(Tray_ID, Day) %>%
  summarise_all(funs(mean(., na.rm=T), min(., na.rm=T), max(., na.rm=T))) %>%
  #calculate DTR
  mutate(DTR=Temp_max-Temp_min) %>%
  #get overall average over study period per tray (average daily values)
  ungroup() %>%
  dplyr::select(-Day) %>%
  group_by(Tray_ID) %>%
  summarise_all(funs(mean))

##new method of weighting climate by expanded infection
octInfExp <- octInf[rep(seq.int(1,nrow(octInf)), octInf$Num_Emerge),]
test <- merge(octInfExp, octClim, by.x="Tray_Code", by.y="Tray_ID", all.x=T)

octEnvVar <- test %>%
  dplyr::select(-Tray_Code,-Site, -Tray, - Class, - Month, - Day, - Exp_Day, - Sex, -Num_Emerge) %>%
  group_by(block,Site_Code) %>%
  summarise_all(funs(mean(.,na.rm=T),se=(sd(., na.rm=T)/sqrt(n())))) 

  
rm(test) #clear unused temporary dataframe
```

```{r august climate formatting, message=F, echo=FALSE}
##repeat above for August
augClim <- climate %>%
  dplyr::select(-Date) %>%
  filter(Day >= as.Date("2016-08-01","%Y-%m-%d")) %>%
    filter((Site_ID %in% c("U2", "U1", "S3", "R1") & Day <= "2016-08-14") |
           (Site_ID %in% c("S1", "S2", "R2", "R3", "U3") & Day <= "2016-08-17")) %>%
  dplyr::select(-Site_ID, -Pot_ID, -Class) %>%
  #get daily averages by Tray
  group_by(Tray_ID, Day) %>%
  summarise_all(funs(mean(., na.rm=T), min(., na.rm=T), max(., na.rm=T))) %>%
  #calculate DTR
  mutate(DTR=Temp_max-Temp_min) %>%
  #get overall average over study period per tray (average daily values)
  ungroup() %>%
  dplyr::select(-Day) %>%
  group_by(Tray_ID) %>%
  summarise_all(funs(mean))

##new method of weighting climate by expanded infection
augInfExp <- augInf[rep(seq.int(1,nrow(augInf)), augInf$Num_Emerge),]
test <- merge(augInfExp, augClim, by.x="Tray_Code", by.y="Tray_ID", all.x=T)

augEnvVar <- test %>%
  dplyr::select(-Tray_Code,-Site, -Tray, - Class, - Month, - Day, - Exp_Day, - Sex, -Num_Emerge) %>%
  group_by(block,Site_Code) %>%
  summarise_all(funs(mean(.,na.rm=T),se=(sd(., na.rm=T)/sqrt(n())))) 

rm(test)

```

```{r, echo=FALSE}
#merge the summer and fall into one dataframe
oct$block <- as.factor("fall")
august$block <- as.factor("summer")
seasonInf <- merge(rbind(oct, august[august$DPI=="21",]), rbind(augEnvVar,octEnvVar), by.x=c("block", "site"), by.y=c("block", "Site_Code"))
```

# Infection Dynamics

## Infection by Class and Season

Make data long
```{r infection data format}
infLong <- seasonInf %>%
  gather(type, infection, Body:Saliva) %>%
  dplyr::select(block, class, site, Individual, type, infection) %>%
  dplyr::group_by(block, class, type, site) %>%
  summarise(mean.inf=mean(infection, na.rm=T), sampleSize=sum(!is.na(infection)), positive=sum(infection, na.rm=T)) %>%
  group_by(block, class, type) %>%
  summarise(se.inf=sd(mean.inf, na.rm=T)/n(), mean.inf=mean(mean.inf), samples=sum(sampleSize), positives=sum(positive)) %>%
  ungroup() %>%
  mutate(stripLabel=case_when(
    type=="Body" ~ "Infected",
    type=="Head" ~ "Disseminated",
    type=="Saliva" ~ "Infectious"
  ))
infLong$sampleLab <- paste0(infLong$positives, "(", infLong$samples, ")")
```

Plot (summer is alpha=1, fall is alpha=0.3)

```{r land class x season plot}
pdf(file="figures/forMS/landclassXseasonInfection.pdf", width = 4, height=7,  family="sans")

ggplot(data=infLong[order(infLong$block, decreasing=F),], aes(x=class, group=block))+
  geom_bar(stat="identity", aes(y=mean.inf, alpha=block, fill=class, color=factor(class)), position=position_dodge(width=-0.9))+
  #geom_text(aes(label=sampleLab, y=mean.inf), vjust=-2, color="black", position=position_dodge(width=-0.9), size=2.5)+
  facet_wrap(~factor(stripLabel, levels=c("Infected", "Disseminated", "Infectious")), nrow=3, dir="v", scales='free') +
  scale_y_continuous(breaks=c(0,0.5,1), minor_breaks = c(0.25, 0.75), labels=c("0%", "50%", "100%"), limits=c(0,1))+
  #ylim(0,1)+
  scale_fill_manual(values=c(colR, colS, colU))+
  scale_color_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(0,1), name="Season", labels=c("Fall", "Summer"))+
  geom_errorbar(aes(ymin=mean.inf-se.inf, ymax=mean.inf+se.inf), width=0.2, color=errorColor, position =position_dodge(-0.9))+
  xlab("Land Class") +
  ylab("Percent Positive") +
  guides(fill=F, color= F,
         alpha=guide_legend(override.aes=list(color=axisColor), reverse=T)) +
  theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        #strip.background = element_blank(),
        strip.text.x = element_text(size=12),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size=12),
        axis.text.x=element_text(size=12))

dev.off()
```



Statistics on infection by season and land class

Body model selection

```{r body model comparison}
#create all the models
m1 <- glmer(Body~block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
m2 <- glmer(Body~class +  (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
m3 <- glmer(Body~class + block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
m4 <- glmer(Body~class*block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))

modelSums <- do.call(rbind, lapply(list(m1,m2,m3, m4), broom::glance)) #m3 is best

AICc(m1,m2,m3,m4) #still 3
```

```{r head model comparison}
#create all the models
m1 <- glmer(Head~block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
m2 <- glmer(Head~class +  (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
m3 <- glmer(Head~class + block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
m4 <- glmer(Head~class*block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))

modelSums <- do.call(rbind, lapply(list(m1,m2,m3, m4), broom::glance)) #model 3 is best

AICc(m1,m2,m3,m4)
tidy(m3)

```

```{r saliva model comparison}
#create all the models
m1 <- glmer(Saliva~block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
m2 <- glmer(Saliva~class +  (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
m3 <- glmer(Saliva~class + block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
m4 <- glmer(Saliva~class*block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
m5 <- glmer(Saliva~ 1 + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit")) #null model

modelSums <- do.call(rbind, lapply(list(m1,m2,m3, m4, m5), broom::glance)) #model 1 is best

AICc(m1,m2,m3,m4, m5) #model 1
tidy(m1)
```


```{r final seasonal infection stats}
mixModelseasonsBody21 <- lme4::glmer(Body~class + block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
tidy(mixModelseasonsBody21)
car::Anova(mixModelseasonsBody21) #Wald test
#confint(mixModelseasonsBody21) #profiled confidence interval
drop1(mixModelseasonsBody21, test="Chisq") #Likelihood ratio test
summary(multcomp::glht(mixModelseasonsBody21, linfct = multcomp::mcp(class = "Tukey"), test = multcomp::adjusted("holm")))
summary(multcomp::glht(mixModelseasonsBody21, linfct = multcomp::mcp(block = "Tukey"), test = multcomp::adjusted("holm")))

mixModelseasonsHead21 <- lme4::glmer(Head~class + block  + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
tidy(mixModelseasonsHead21)
car::Anova(mixModelseasonsHead21) #Wald test
#confint(mixModelseasonsHead21) #profiled confidence interval
drop1(mixModelseasonsHead21, test="Chisq")
summary(multcomp::glht(mixModelseasonsHead21, linfct = multcomp::mcp(class = "Tukey"), test = multcomp::adjusted("holm")))
summary(multcomp::glht(mixModelseasonsHead21, linfct = multcomp::mcp(block = "Tukey"), test = multcomp::adjusted("holm")))

mixModelseasonsSaliva21 <- lme4::glmer(Saliva~block  + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
tidy(mixModelseasonsSaliva21) #z-test
car::Anova((mixModelseasonsSaliva21)) #Wald test
confint(mixModelseasonsSaliva21) #profiled confidence interval
drop1(mixModelseasonsSaliva21, test="Chisq")
#pairwise comparison
summary(multcomp::glht(mixModelseasonsSaliva21, linfct = multcomp::mcp(block = "Tukey"), test = multcomp::adjusted("holm")))
```

### Infection Efficiency

Format data for infection efficiency

```{r create and format efficiency data}
bodyEff <- seasons %>%
  filter(DPI==21) %>%
  #drop individual
  select(-Individual, -site, -Wing, -DPI) %>%
  group_by(block, class) %>%
  summarise_all(funs(bodyMean=mean(.,na.rm=T),bodySE=(sd(., na.rm=T)/sqrt(n()))), Body) %>%
  ungroup()

headEff <- seasons %>%
  filter(DPI==21) %>%
  filter(Body==1) %>%
  #drop individual
  select(-Individual, -site, -Wing, -DPI) %>%
  group_by(block, class) %>%
  summarise_all(funs(headMean=mean(.,na.rm=T),headSE=(sd(., na.rm=T)/sqrt(n()))), Head) %>%
  ungroup()

salEff <-  seasons %>%
  filter(DPI==21) %>%
  filter(Head==1) %>%
  #drop individual
  select(-Individual, -site, -Wing, -DPI) %>%
  group_by(block, class) %>%
  summarise_all(funs(salMean=mean(.,na.rm=T),salSE=(sd(., na.rm=T)/sqrt(n()))), Saliva) %>%
  ungroup()

#group together
allEff <- full_join(bodyEff, headEff, by=c("block", "class"))
allEff <- full_join(allEff, salEff, by=c("block", "class"))

library(tidyr)
meltMean <- allEff %>%
  select(block, class, contains("Mean")) %>%
  gather(key=variable, value=mean, -block, -class) 

meltMean$type <- rep(c("Body", "Head", "Saliva"), each=6)
  
meltSE <- allEff %>%
  select(block, class, contains("SE")) %>%
  gather(variable, SE, -block, -class)

meltSE$type <- rep(c("Body", "Head", "Saliva"), each=6)
  
meltAll <- full_join(meltMean, meltSE, by=c("class", "block", "type")) %>%
  select(-variable.x, -variable.y)
```

Plot of infection efficiency
```{r plot efficiency}
#supplemental plot
ggplot(data=meltAll[order(meltAll$block, decreasing=F),], aes(x=class, group=block))+
  geom_bar(stat="identity", aes(y=mean, alpha=factor(block), fill=factor(class)), color="gray20", position=position_dodge(width=-0.9))+
  facet_wrap(~type, nrow=3, dir="v") +
  scale_fill_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(1,0.3), name="Season", labels=c("Fall", "Summer"), guide=guide_legend(reverse=T))+
  geom_errorbar(aes(ymin=mean-SE, ymax=mean+SE), width=0.2, color="gray20", position =position_dodge(-0.9))+
  theme_base() + 
  xlab("Land Class") +
  ylab("Infection Efficiency") +
  guides(fill=F)
  #theme(legend.title=element_text("Season"))
```

Model Selection (Body is same as initial infection)

```{r head efficiency model comparison}
#create all the models
m1 <- glmer(Head~block + (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))
m2 <- glmer(Head~class +  (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))
m3 <- glmer(Head~class + block + (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))
m4 <- glmer(Head~class*block + (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))
m5 <- glmer(Head~class*(1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))

modelSums <- do.call(rbind, lapply(list(m1,m2,m3, m4, m5), broom::glance)) #model 1 is best

AICc(m1,m2,m3,m4, m5)
tidy(m1)
```

```{r saliva efficiency model comparison}
#create all the models
m1 <- glmer(Saliva~block + (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))
m2 <- glmer(Saliva~class +  (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))
m3 <- glmer(Saliva~class + block + (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))
m4 <- glmer(Saliva~class*block + (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))
m5 <- glmer(Saliva~class*(1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))

modelSums <- do.call(rbind, lapply(list(m1,m2,m3, m4, m5), broom::glance)) #between 1 and 3

AICc(m1,m2,m3,m4, m5)
tidy(m1)
tidy(m3)
```

```{r efficiency stats}
#model 
mixModelseasonsBody21 <- lme4::glmer(Body~class + block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
tidy(mixModelseasonsBody21)
car::Anova(mixModelseasonsBody21)
summary(multcomp::glht(mixModelseasonsBody21, linfct = multcomp::mcp(class = "Tukey"), test = multcomp::adjusted("holm")))
summary(multcomp::glht(mixModelseasonsBody21, linfct = multcomp::mcp(block = "Tukey"), test = multcomp::adjusted("holm")))


mixModelseasonsHead21 <- lme4::glmer(Head~block  + (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))
tidy(mixModelseasonsHead21)
car::Anova(mixModelseasonsHead21) #no effect
drop1(mixModelseasonsHead21, test="Chisq")
summary(multcomp::glht(mixModelseasonsHead21, linfct = multcomp::mcp(block = "Tukey"), test = multcomp::adjusted("holm")))

mixModelseasonsSaliva21 <- lme4::glmer(Saliva~class + block  + (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Head==1,],
                          family=binomial(link="logit"))
tidy(mixModelseasonsSaliva21)
car::Anova((mixModelseasonsSaliva21)) #only block is significant
drop1(mixModelseasonsSaliva21, test="Chisq")
summary(multcomp::glht(mixModelseasonsSaliva21, linfct = multcomp::mcp(class = "Tukey"), test = multcomp::adjusted("holm")))
summary(multcomp::glht(mixModelseasonsSaliva21, linfct = multcomp::mcp(block = "Tukey"), test = multcomp::adjusted("holm")))
```

## Infection and Microclimate

```{r create dataframe of site-aggregated infections}
seasonSite <- seasons %>%
  filter(DPI=="21") %>%
  dplyr::select(-Individual, -DPI, - Wing) %>%
  dplyr::group_by(block, class, site) %>%
  summarise_all(funs(mean(.,na.rm=T), se=(sd(., na.rm=T)/sqrt(n()))))

#group with temperature data
seasonInfSite <- merge(seasonSite, rbind(augEnvVar,octEnvVar), by.x=c("block", "site"), by.y=c("block", "Site_Code"))

# inspect variable correlations
# cor(seasonInfSite[,10:18])
```

```{r body x climate stats}
respV <- "Body_mean"
predVs <- c("Temp_mean_mean","RH_mean_mean", "DTR_mean", "Temp_min_mean", "RH_min_mean", "Temp_max_mean", "RH_max_mean")

myCols <- c(respV, predVs, "block","class", "site")
modDF <- seasonInfSite %>%
  dplyr::select(one_of(myCols)) 
modDF <- na.omit(modDF)

#model selection for initial variable (bc of high correlation)
m1 <- glm(Body_mean ~ Temp_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m2 <- glm(Body_mean ~ RH_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m3 <- glm(Body_mean ~ DTR_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m4 <- glm(Body_mean ~ Temp_min_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m5 <- glm(Body_mean ~ Temp_max_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m6 <- glm(Body_mean ~ RH_min_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m7 <- glm(Body_mean ~ RH_max_mean, 
          data=modDF, 
          family=gaussian(link="log"))

modelSums <- do.call(rbind, lapply(list(m1,m2,m3, m4, m5, m6, m7), broom::glance)) #1 seems best

AICc(m1,m2,m3, m4, m5, m6, m7)
tidy(m1)

#find covariates that aren't correlated
covars <- data.frame(cor(seasonInfSite[,10:18]))
rownames(covars[abs(covars$Temp_mean_mean)<0.8,]) #only RH_mean and RH_max

#model selection
m1 <- glm(Body_mean ~ Temp_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m2 <- glm(Body_mean ~ RH_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))

m3 <- glm(Body_mean ~ Temp_mean_mean+RH_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m4 <- glm(Body_mean ~ Temp_mean_mean*RH_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))



modelSums <- do.call(rbind, lapply(list(m1,m2, m3, m4), broom::glance)) #3 seems best

AICc(m1,m2, m3, m4)
tidy(m3)


finalBody <- glm(Body_mean ~ Temp_mean_mean+RH_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))
plot(cooks.distance(finalBody))
abline(h=4/length(modDF), lty=2)
car::Anova(finalBody)
#confint(finalBody)
tidy(finalBody)
drop1(finalBody, test="F")

outlierTest(finalBody)
vif(finalBody)
sqrt(vif(finalBody))>2

#glm residuals
simulationOutput <- simulateResiduals(fittedModel = finalBody, n=999)
plotSimulatedResiduals(simulationOutput = simulationOutput)

```

```{r head x climate stats}
respV <- "Head_mean"
predVs <- c("Temp_mean_mean","RH_mean_mean", "DTR_mean", "Temp_min_mean", "RH_min_mean", "Temp_max_mean", "RH_max_mean")

myCols <- c(respV, predVs, "block","class", "site")
modDF <- seasonInfSite %>%
  dplyr::select(one_of(myCols)) 
modDF <- na.omit(modDF)

#model selection for initial variable (bc of high correlation)
m1 <- glm(Head_mean ~ Temp_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m2 <- glm(Head_mean ~ RH_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m3 <- glm(Head_mean ~ DTR_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m4 <- glm(Head_mean ~ Temp_min_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m5 <- glm(Head_mean ~ Temp_max_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m6 <- glm(Head_mean ~ RH_min_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m7 <- glm(Head_mean ~ RH_max_mean, 
          data=modDF, 
          family=gaussian(link="log"))

modelSums <- do.call(rbind, lapply(list(m1,m2,m3, m4, m5, m6, m7), broom::glance)) #1 seems best
tidy(m1)

#model selection
m1 <- glm(Head_mean ~ Temp_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m2 <- glm(Head_mean ~ RH_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))

m3 <- glm(Head_mean ~ Temp_mean_mean+RH_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))
m4 <- glm(Head_mean ~ Temp_mean_mean*RH_mean_mean, 
          data=modDF, 
          family=gaussian(link="log"))

modelSums <- do.call(rbind, lapply(list(m1,m2, m3, m4), broom::glance)) #3 seems best

AICc(m1,m2, m3, m4)
tidy(m3)


finalHead <- glm(Head_mean ~ Temp_mean_mean+RH_mean_mean, 
          data=modDF, 
          family=gaussian)

plot(cooks.distance(finalHead))
abline(h=4/length(modDF), lty=2)
car::Anova(finalHead)
#confint(finalHead)
drop1(finalHead, test="F")
tidy(finalHead)


outlierTest(finalHead)

#glm residuals
simulationOutput <- simulateResiduals(fittedModel = finalHead, n=999)
plotSimulatedResiduals(simulationOutput = simulationOutput)
```

```{r saliva x climate stats}
respV <- "Saliva_mean"
predVs <- c("Temp_mean_mean","RH_mean_mean", "DTR_mean", "Temp_min_mean", "RH_min_mean", "Temp_max_mean", "RH_max_mean")

myCols <- c(respV, predVs, "block","class", "site")
modDF <- seasonInfSite %>%
  dplyr::select(one_of(myCols)) 
modDF <- na.omit(modDF)

#model selection for initial variable (bc of high correlation)
m1 <- glm(Saliva_mean ~ Temp_mean_mean, 
          data=modDF, 
          family=gaussian)
m2 <- glm(Saliva_mean ~ RH_mean_mean, 
          data=modDF, 
          family=gaussian)
m3 <- glm(Saliva_mean ~ DTR_mean, 
          data=modDF, 
          family=gaussian)
m4 <- glm(Saliva_mean ~ Temp_min_mean, 
          data=modDF, 
          family=gaussian)
m5 <- glm(Saliva_mean ~ Temp_max_mean, 
          data=modDF, 
          family=gaussian)
m6 <- glm(Saliva_mean ~ RH_min_mean, 
          data=modDF, 
          family=gaussian)
m7 <- glm(Saliva_mean ~ RH_max_mean, 
          data=modDF, 
          family=gaussian)

modelSums <- do.call(rbind, lapply(list(m1,m2,m3, m4, m5, m6, m7), broom::glance)) #2 seems best, but they are all basically the same (dAIC<1)
tidy(m2)


#model selection
m1 <- glm(Saliva_mean ~ Temp_mean_mean, 
          data=modDF,
          family=gaussian)
m2 <- glm(Saliva_mean ~ RH_mean_mean, 
          data=modDF,
          family=gaussian)

m3 <- glm(Saliva_mean ~ Temp_mean_mean+RH_mean_mean, 
          data=modDF, 
          family=gaussian)
m4 <- glm(Saliva_mean ~ Temp_mean_mean*RH_mean_mean, 
          data=modDF,
          family=gaussian)

modelSums <- do.call(rbind, lapply(list(m1,m2, m3, m4), broom::glance)) #2 seems best

AICc(m1,m2, m3, m4)
tidy(m2)

finalSal <- glm(Saliva_mean ~ RH_mean_mean, 
                data=modDF, #drop outlier
                family=gaussian)

plot(cooks.distance(finalSal))
abline(h=4/length(modDF), lty=2)
car::Anova(finalSal)
#confint(finalSal)
drop1(finalSal, test="F")
tidy(finalSal)

outlierTest(finalSal)

#glm residuals
simulationOutput <- simulateResiduals(fittedModel = finalHead, n=999)
plotSimulatedResiduals(simulationOutput = simulationOutput)

```

Infection x Temperature Plot

```{r three panel temp x infection plot}
#pdf(file="figures/forMS/InfxTemp3Panel.pdf", width = 8, height=3, family="sans")
plotBody <- ggplot(data=seasonInfSite, aes(x=Temp_mean_mean, y=Body_mean))+
  geom_errorbar(aes(ymin=Body_mean-Body_se, ymax=Body_mean+Body_se), color=errorColor, width=0.1) +
  geom_point(aes(color=class, shape=block), size=4.5) + 
  scale_color_manual(values=c(colR, colS, colU)) +
  theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(),
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank())+
  ylab("Prop. Infected")+
  xlab("") +  
  theme(legend.position="none")

plotHead <- ggplot(data=seasonInfSite, aes(x=Temp_mean_mean, y=Head_mean))+
   geom_errorbar(aes(ymin=Head_mean-Head_se, ymax=Head_mean+Head_se), color=errorColor, width=0.1) +
  geom_point(aes(color=class, shape=block), size=4) + 
  scale_color_manual(values=c(colR, colS, colU)) +
  theme_fivethirtyeight() +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(),
        axis.title.x = element_text(),
        axis.title.y=element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank())+
  #ylab("Prop. Disseminated")+
  xlab("Mean Daily Temperature (C)")+
  theme(legend.position="none")

plotSaliva <- ggplot(data=seasonInfSite, aes(x=Temp_mean_mean, y=Saliva_mean))+
  geom_errorbar(aes(ymin=Saliva_mean-Saliva_se, ymax=Saliva_mean+Saliva_se), color=errorColor, width=0.1) +
  #geom_errorbarh(aes(xmin=Temp_mean_mean-Temp_mean_se, xmax=Temp_mean_mean+Temp_mean_se, y=Body_mean),color="gray20", height=0.05) + #not enough error to see
  geom_point(aes(color=class, shape=block), size=4.5) + 
  scale_color_manual(values=c(colR, colS, colU)) +
  theme_fivethirtyeight() +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(),
        axis.title.x = element_text(),
        axis.title.y=element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank()) +
  #ylab("Prop. Infectious")+
  xlab("") +  
  scale_y_continuous(limits=c(0,1))+
  #theme(legend.position="right", legend.direction="vertical")
  theme(legend.position="none")


plot_grid(plotBody, plotHead, plotSaliva, 
          labels=c("A", "B", "C"), 
          ncol=3)
#dev.off()
```

Infection x Relative Humidity Plot
```{r}
#png(file="figures/forMS/supplement/InfxRH3Panel.png", width = 8, height=3, units="in", res=500, family="sans")
plotBody <- ggplot(data=seasonInfSite, aes(x=RH_mean_mean, y=Body_mean))+
  geom_errorbar(aes(ymin=Body_mean-Body_se, ymax=Body_mean+Body_se), color=errorColor, width=0.1) +
  geom_point(aes(color=class, shape=block), size=4.5) + 
  scale_color_manual(values=c(colR, colS, colU)) +
  theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(),
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank())+
  ylab("Prop. Infected")+
  xlab("") +  
  theme(legend.position="none")

plotHead <- ggplot(data=seasonInfSite, aes(x=RH_mean_mean, y=Head_mean))+
   geom_errorbar(aes(ymin=Head_mean-Head_se, ymax=Head_mean+Head_se), color=errorColor, width=0.1) +
  geom_point(aes(color=class, shape=block), size=4) + 
  scale_color_manual(values=c(colR, colS, colU)) +
  theme_fivethirtyeight() +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(),
        axis.title.x = element_text(),
        axis.title.y=element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank())+
  #ylab("Prop. Disseminated")+
  xlab("Relative Humidity (%)")+
  theme(legend.position="none")

plotSaliva <- ggplot(data=seasonInfSite, aes(x=RH_mean_mean, y=Saliva_mean))+
  geom_errorbar(aes(ymin=Saliva_mean-Saliva_se, ymax=Saliva_mean+Saliva_se), color=errorColor, width=0.1) +
  geom_point(aes(color=class, shape=block), size=4.5) + 
  scale_color_manual(values=c(colR, colS, colU)) +
  theme_fivethirtyeight() +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(),
        axis.title.x = element_text(),
        axis.title.y=element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank()) +
  #ylab("Prop. Infectious")+
  xlab("") +  
  scale_y_continuous(limits=c(0,1))+
  #theme(legend.position="right", legend.direction="vertical")
  theme(legend.position="none")


plot_grid(plotBody, plotHead, plotSaliva, 
          labels=c("A", "B", "C"), 
          ncol=3)
#dev.off()
```

## Infection and Body Size

### Body Infection

```{r body inf x size stats}
bodyWingDF <- seasonInf %>%
  dplyr::select(Body, Wing, site, block, class) %>%
  filter(!is.na(Body)) %>%
  filter(!is.na(Wing))


bodyWing <- glmer(Body~Wing + (1|site),
                          data=bodyWingDF,
                          family=binomial(link="logit"))
# bodyWing <- lmer(Wing~Body + (1|site),
#                           data=bodyWingDF)
tidy(bodyWing)
summary(bodyWing)

simulationOutput <- simulateResiduals(fittedModel = bodyWing, n=999)
plotSimulatedResiduals(simulationOutput = simulationOutput)
Anova(bodyWing)
drop1(bodyWing, test="Chisq")
```

```{r body inf x size plot}
ggplot(data=bodyWingDF, aes(x=factor(Body), y=Wing))+
  geom_boxplot() +
  geom_jitter(shape=16, position=position_jitter(0.1), aes(color=factor(class)), alpha=0.5) +
    theme_fivethirtyeight()+
  theme(axis.title = element_text()) +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank())+
  theme(legend.background = element_rect(fill = "transparent", colour = NA))+
  theme(legend.position="right", legend.direction="vertical") +
  scale_color_manual(values=c("dodgerblue", "gray10", "maroon"), labels=c("Rural", "Suburban", "Urban"))+
    scale_fill_manual(values=c("dodgerblue", "gray80", "maroon"), labels=c("Rural", "Suburban", "Urban")) +
  guides(color=F) +
  xlab("Body Positivity") +
  ylab("Wing Size")
```

### Head Infection

```{r head inf x size stats}
headWingDF <- seasonInf %>%
  dplyr::select(Head, Wing, site, block, class) %>%
  filter(!is.na(Head)) %>%
  filter(!is.na(Wing))


headWing <- glmer(Head~Wing + (1|site),
                          data=headWingDF,
                          family=binomial(link="logit"))
# headWing <- lmer(Wing~Head + (1|site),
#                           data=headWingDF) #this tests if the wing length is significantly different across infection classes
tidy(headWing)
simulationOutput <- simulateResiduals(fittedModel = headWing, n=99)
plotSimulatedResiduals(simulationOutput = simulationOutput)

Anova(headWing)
drop1(headWing, test="Chisq")
```

### Saliva Infection

```{r saliva inf x size stats}
salWingDF <- seasonInf %>%
  dplyr::select(Saliva, Wing, site, block, class) %>%
  filter(!is.na(Saliva)) %>%
  filter(!is.na(Wing))


salWing <- glmer(Saliva~Wing + (1|site),
                          data=salWingDF,
                          family=binomial(link="logit"))
summary(salWing)
tidy(salWing)
simulationOutput <- simulateResiduals(fittedModel = salWing, n=99)
plotSimulatedResiduals(simulationOutput = simulationOutput)

Anova(salWing)
drop1(salWing, test="Chisq")
```

# Emergence and Survival

## Data Format and Loading

```{r}
emergAug <- read.csv("../data/emergence/raw/AugustEmergence.csv")
emergAug$block <- "summer"

emergOct <- read.csv("../data/emergence/raw/OctoberEmergence.csv")
emergOct$block <- "fall"
#drop U3T1 in fall because it was eaten by ants
emergOct <- filter(emergOct, Tray_Code!="U3T1")
emergOct <- filter(emergOct, Tray_Code!="S1T3") #dumped
emergOct <- filter(emergOct, Tray_Code!="U1T4") #dumped

emergAll <- rbind(emergOct, emergAug)
#expand so each mosquito gets one row
emergExp <- emergAll[rep(seq.int(1,nrow(emergAll)), emergAll$Num_Emerge),
                      c(11, 2,4,5,6:9)]
#sum(emergAll$Num_Emerge)==nrow(emergExp) #quick check this worked

#get survival per tray
survSumm <- emergExp %>%
  filter(Sex=="F") %>%
  group_by(block, Tray_Code) %>%
  dplyr::mutate(percSurv=n()) %>%
  ungroup() %>%
  dplyr::select(block, Class, Site_Code, Tray_Code, percSurv)
survSumm <- unique(survSumm)
```

```{r fillIn function}
fillIn <- function(df, endDay, totalMosq=50){
  #' Fill In Emergence Dates
  #' this function fills in for those mosquitoes that did not emerge so we do not have data for, it gives them an observation/event of 0 on the last day we found a mosquito emerged
  #' @param df the data frame you wish to fill in, in our case by pot
  #' @param endDay the last day of emergence
  #' @param totalMosq estimated starting number of mosquitoes per pot
  #' @returns dataframe with census data filled in for mosquitoes that did not emerge
  toRep <- df[1,]
  toRep$Exp_Day <- endDay
  toRep$event <- 0
  if(nrow(df)<totalMosq){
    toAdd <- toRep[rep(1, (totalMosq-nrow(df))),]
    allTest <- rbind(df, toAdd)
  } else {
    toAdd <- NA
    allTest <- NA
  }
  return(allTest)
}
```

```{r apply FillIn function}
applyFill <- function(season, allData=emergExp){
  #' Apply FillIn function
  #' @param season "fall" or "summer"
  #' @param allData full dataframe with row for each mosquito that emerged
  #' @returns censused data for the full season
  tempList <- list()
  tempDF <- allData
  tempDF <- tempDF[tempDF$Sex=="F",]
  tempDF <- tempDF[tempDF$block==season,]
  tempDF$event <- 1 #add emergence event
  for (i in 1:length(unique(tempDF$Tray_Code))){ 
    df <- tempDF[tempDF$Tray_Code==unique(tempDF$Tray_Code)[i],]
    endDay <- max(tempDF$Exp_Day)
    tempList[[i]] <- fillIn(df=df, endDay=endDay)
  }
  allSurv <- do.call(rbind.data.frame, tempList)
  return(allSurv)
}
```

```{r}
summerSurv <- applyFill(season="summer")
fallSurv <- applyFill(season="fall")
allSurv <- rbind(summerSurv, fallSurv)
```

## Class x Block

### Survival

```{r survival stats by tray}
survTray <- allSurv %>%
  filter(Sex=="F") %>%
  group_by(Tray_Code, Site_Code, Class, block) %>%
  summarise(survival=mean(event))

m1 <- lmer(survival ~ Class + (1|Tray_Code)+(1|Site_Code), 
                   data=survTray)
m2 <- lmer(survival ~ block + (1|Tray_Code)+(1|Site_Code), 
                   data=survTray)

m3 <- lmer(survival ~ Class * block + (1|Tray_Code)+(1|Site_Code), 
                   data=survTray)

m4 <- lmer(survival ~ Class + block + (1|Tray_Code)+(1|Site_Code), 
                   data=survTray)

modelSums <- do.call(rbind, lapply(list(m1,m2,m3, m4), broom::glance))
modelSums #m3 is best

AICc(m1,m2,m3, m4) #still m3

siteSurv <- glmer(survival ~ Class * block + (1|Tray_Code)+(1|Site_Code),
                   data=survTray,
                 family=gaussian(link="logit"))

summary(siteSurv)
tidy(siteSurv)
plot(siteSurv)
car::Anova(siteSurv)

#pairwise
survPair <- pairs(lsmeans::lsmeans(siteSurv, ~Class|block))
survPair
```

Analyzing blocks seperately
```{r}
fallSurvMod <- lmer(survival ~ Class+(1|Site_Code), 
                   data=survTray[survTray$block=="fall",])
tidy(fallSurvMod)
summary(fallSurvMod)
Anova(fallSurvMod)

summerSurvMod <- lmer(survival ~ Class+(1|Site_Code), 
                   data=survTray[survTray$block=="summer",])
tidy(summerSurvMod)
summary(summerSurvMod)
Anova(summerSurvMod)
```

### Emergence

```{r emergence stats individual female}
emergExpF <- filter(emergExp, Sex=="F")

emergExpF$block <- as.factor(emergExpF$block)

m1 <- lmer(Exp_Day ~ Class + (1|Tray_Code)+(1|Site_Code), 
                   data=emergExpF)

m2 <- lmer(Exp_Day  ~ block + (1|Tray_Code)+(1|Site_Code), 
                   data=emergExpF)

m3 <- lmer(Exp_Day  ~ Class + block + (1|Tray_Code)+(1|Site_Code), 
                   data=emergExpF)

m4 <- lmer(Exp_Day ~ Class * block + (1|Tray_Code)+(1|Site_Code), 
                   data=emergExpF)

modelSums <- do.call(rbind, lapply(list(m1,m2,m3, m4), broom::glance)) #m4 is best

AICc(m1,m2,m3, m4) #still m4


mixEmerge <- glmer((1/Exp_Day) ~ Class * block + (1|Tray_Code)+(1|Site_Code),
                   data=emergExpF,
                   family=Gamma(link = "log"))
summary(mixEmerge)
tidy(mixEmerge)
plot(mixEmerge)
qqnorm(resid(mixEmerge))
#confint(mixEmerge)
Anova(mixEmerge)

#pairwise
emergePair <- pairs(lsmeans::lsmeans(mixEmerge, ~Class|block))
emergePair
```

```{r emergence stats by tray}
emergTray <- emergExpF %>%
  group_by(Tray_Code, Site_Code, Class, block) %>%
  summarise(emergeRate=mean(1/Exp_Day, na.rm=T))

#model selection
m1 <- lmer(emergeRate ~ Class +(1|Site_Code), 
                   data=emergTray)

m2 <- lmer(emergeRate ~ block +(1|Site_Code), 
                   data=emergTray)

m3 <- lmer(emergeRate ~ Class * block +(1|Site_Code), 
                   data=emergTray)

m4 <- lmer(emergeRate ~ Class + block +(1|Site_Code), 
                   data=emergTray)

modelSums <- do.call(rbind, lapply(list(m1,m2,m3, m4), broom::glance)) 
modelSums #m2 is best

AICc(m1,m2,m3, m4) #still m2

mixEmergeTray <- lmer(emergeRate ~ block +(1|Site_Code), 
                   data=emergTray)

summary(mixEmergeTray)
tidy(mixEmergeTray)
plot(mixEmergeTray)
qqnorm(resid(mixEmergeTray))
#confint(mixEmerge)
Anova(mixEmergeTray)

#pairwise
summary(multcomp::glht(mixEmergeTray, linfct = multcomp::mcp(block = "Tukey"), test = adjusted("holm")))
```


Land use trends were significant in the fall:
```{r}
mixEmergeFall <- lmer(emergeRate ~ Class + (1|Site_Code), 
                   data=emergTray[emergTray$block=="fall",])

summary(mixEmergeFall)
tidy(mixEmergeFall)
plot(mixEmergeFall)
qqnorm(resid(mixEmergeFall))
summary(mixEmergeFall)
#confint(mixEmergeFall)
Anova(mixEmergeFall)

summary(multcomp::glht(mixEmergeFall, linfct = multcomp::mcp(Class = "Tukey"), test = adjusted("holm")))
```


### Plots

Adjust factors for plotting:
```{r}
levels(emergExpF$block) <- c("Fall", "Summer")
emergExpF <- mutate(emergExpF, block=forcats::fct_rev(block))
levels(emergExpF$Class) <- c("Rural", "Suburban", "Urban")

levels(siteSumm$block) <- c("Fall", "Summer")
siteSumm <- mutate(siteSumm, block=forcats::fct_rev(block))
levels(siteSumm$Class) <- c("Rural", "Suburban", "Urban")
```


Survival and Emergence Plot

```{r}
#png(file="figures/forMS/emergSurvPlot.png", width = 4, height=6, units="in", res=500, family="sans")

#Survival plot
survPlot <- ggplot(data=siteSumm, aes(x=Class, y=(numSurv*2)))+
  geom_boxplot(aes(fill=Class), color=errorColor, width=0.4)+
  scale_fill_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  facet_wrap(~block, ncol=2)+
  ylab("Percent Survival")+
  theme(legend.position="none")+
  #theme(axis.title.x = element_blank(), axis.text.x = element_blank())+
  theme(axis.title = element_text(size=12))
survPlot
# dev.off()
  
#for presentations
# pdf(file="figures/forMS/emergPlotPPT.pdf", width = 6, height=4, family="sans")
#Emergence Plot
emergePlot <- ggplot(emergExpF, aes(x=Class, y=(1/Exp_Day)))+
  geom_boxplot(aes(fill=Class, alpha=0.5), width=0.4)+
  scale_fill_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  facet_wrap(~block, ncol=2)+
  ylab("Development Rate")+
  theme(legend.position="none") +
  #theme(strip.background = element_blank(),
  #strip.text.x = element_blank()) +
  xlab("Land Class") +
  theme(axis.text.x = element_text(size=8)) +
  theme(axis.title = element_text(size=12), axis.title.y= element_text(size=12))

emergePlot
# dev.off()
```


## Microclimate

Tie in tray-level climate data:
```{r}
allClim <- rbind(augClim, octClim)
allClim$block <- rep(c("summer", "fall"), each=34)
survClim <- merge(survSumm, allClim, by.x=c("block","Tray_Code"), by.y=c("block","Tray_ID"))
```

### Survival

Statistics
```{r}
respV <- "percSurv"
predVs <- c("Temp_mean","RH_mean", "DTR", "Temp_min", "RH_min", "Temp_max", "RH_max")

myCols <- c(respV, predVs, "block","Class", "Site_Code")
modDF <- survClim %>%
  dplyr::select(one_of(myCols)) 
modDF <- na.omit(modDF)

#model selection for initial variable

m1 <- lmer(percSurv~Temp_mean + (1|Site_Code),
           data=modDF)

m2 <- lmer(percSurv~RH_mean + (1|Site_Code),
           data=modDF)

m3 <- lmer(percSurv~DTR + (1|Site_Code),
           data=modDF)

m4 <- lmer(percSurv~Temp_min + (1|Site_Code),
           data=modDF)

m5 <- lmer(percSurv~RH_min + (1|Site_Code),
           data=modDF)

m6 <- lmer(percSurv~Temp_max + (1|Site_Code),
           data=modDF)

m7 <- lmer(percSurv~RH_max + (1|Site_Code),
           data=modDF)

modelSums <- do.call(rbind, lapply(list(m1,m2,m3, m4, m5, m6, m7), broom::glance))
modelSums #m1 or m4

MuMIn::AICc(m1,m2,m3, m4, m5, m6, m7)
tidy(m1)

#find covariates that aren't correlated
covars <- data.frame(cor(survClim[,6:12]))
rownames(covars[abs(covars$Temp_mean)<0.8,]) #only RH_mean and RH_max

#model selection
m1 <- lmer(percSurv~Temp_mean + (1|Site_Code),
           data=modDF)

m2 <- lmer(percSurv~Temp_mean + RH_mean + (1|Site_Code),
           data=modDF)

m3 <- lmer(percSurv~Temp_mean * RH_mean + (1|Site_Code),
           data=modDF)

m4 <- lmer(percSurv~RH_mean + (1|Site_Code),
           data=modDF)

modelSums <- do.call(rbind, lapply(list(m1,m2, m3, m4), broom::glance)) #1 seems best
modelSums

AICc(m1,m2, m3, m4)
tidy(m1)


survClimModmix <- lmer(percSurv~Temp_mean+(1|Site_Code),
                    data=survClim)

summary(survClimModmix)
confint(survClimModmix)
tidy(survClimModmix)

plot(survClimModmix)
qqnorm(resid(survClimModmix))
```


### Development Rate

```{r}
allClim$block <- as.factor(allClim$block)
levels(allClim$block) <- c("Fall", "Summer")
emergClim <- merge(emergExpF, allClim, by.x=c("block","Tray_Code"), by.y=c("block","Tray_ID"))
emergClim <- mutate(emergClim, devRate =1/Exp_Day)
```

Statistics:
```{r}
devClimMod <- lmer(devRate~Temp_mean*RH_mean +(1|Site_Code),
                    data=emergClim)

plot(devClimMod)
qqnorm(resid(devClimMod))
summary(devClimMod)
coef(devClimMod)

car::Anova(devClimMod)
```

#Body Size

Load body size data:
```{r load body size data}
augWing <- read.csv("../data/emergence/raw/AugustWingLength.csv", stringsAsFactors = F)
octWing <- read.csv("../data/emergence/raw/OctoberWingLength.csv",  stringsAsFactors = F)


#convert to mm & clean
augWing$mm <- augWing$Bars*augWing$Conversion.mm.bars.
octWing$mm <- octWing$Bars*octWing$Conversion.bars.mm.

octWing$site <- as.factor(substr(as.character(octWing$TrayCode), 1, 2))
augWing$site <- as.factor(substr(as.character(augWing$TrayCode), 1, 2))

getClass <- function(monthDf){
  monthDf$class <- NULL
  for (i in 1:nrow(monthDf)){
    if (substr(monthDf$site[i], 1,1)=="R"){
    monthDf$class[i] <- "Rural"
    }
    if (substr(monthDf$site[i], 1,1)=="S"){
    monthDf$class[i] <- "Suburban"
    }
    if (substr(monthDf$site[i], 1,1)=="U"){
    monthDf$class[i] <- "Urban"
    }
  }
  monthDf$class <- as.factor(monthDf$class)
  return(monthDf)
}

augWing <- getClass(augWing)
octWing <- getClass(octWing)

octWing$block <- "fall"
augWing$block <- "summer"

augWing$Date <- as.Date(as.character(augWing$Date), format="%m/%d/%Y")
octWing$Date <- as.Date(as.character(octWing$Date), format="%m/%d/%Y")

#add day of experiment
augWing$Exp_Day <- as.numeric(augWing$Date-as.Date("2016-08-01", format="%Y-%m-%d"))
octWing$Exp_Day <- as.numeric(octWing$Date-as.Date("2016-09-26", format="%Y-%m-%d"))

#rename traycode column to match
colnames(augWing)[1] <- "Tray_ID"
colnames(octWing)[1] <- "Tray_ID"

#combine
fallWing <- octWing %>%
  dplyr::select(block, class, site, Tray_ID, Exp_Day, mm)

summerWing <- augWing %>%
  dplyr::select(block, class, site, Tray_ID, Exp_Day, mm)

allWing <- rbind(summerWing, fallWing)
allWing$block<- as.factor(allWing$block)

#drop outlier in S2 (wing size =1.56 mm)
allWing <- allWing %>%
  filter(mm>1.6)
```

Statistics:
```{r}
wingMix <- lmer(mm~class*block +(1|site),
                data=allWing)
summary(wingMix)
plot(wingMix)
car::Anova(wingMix, type="2")
coef(wingMix)
```

```{r}
allWingSumm <- summarySE(allWing, measurevar="mm", groupvars=c("class", "block"))

ggplot(data=allWingSumm, aes(x=class, y=mm, group=block))+
  geom_point(aes(y=mm, shape=factor(block), color=factor(class)), position=position_dodge(width=-0.9), size=5)+
  scale_color_manual(values=c(colRural, colSuburban, colU))+
  scale_alpha_discrete(range=c(1,0.3), name="Season", labels=c("Fall", "Summer"), guide=guide_legend(reverse=T))+
  scale_shape_discrete(name="Season",labels=c("Fall", "Summer"), guide=guide_legend(reverse=T))+
  geom_errorbar(aes(ymin=mm-ci, ymax=mm+ci), width=0.2, color="gray20", position =position_dodge(-0.9))+
  ylim(2.2,2.6)+
  theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank())+
  theme(legend.background = element_rect(fill = "transparent", colour = NA)) +
    theme(axis.title = element_text(), axis.title.x = element_text()) +
  ylab("Uninfected Wing Size")+
  xlab("Land Class") +  
  #ggtitle("Body Size ") +
  theme(legend.position="right", legend.direction="vertical")+
  guides(fill=F, color=F) 
```

## Climate and Wing Length

Load Data
```{r}
climate <- read.csv(file='../data/microclimate/clean/2016TrialsAdultCleaned.csv', stringsAsFactors = F)

climate$Day <- as.Date(climate$Day, format="%Y-%m-%d")
climate$Site_ID <- as.factor(climate$Site_ID)
climate$Tray_ID <- as.factor(climate$Tray_ID)

getClimate <- function(indMosq, climateDF=climate, season){
  #' This is a function to apply over the rows of the octWing and augWing data frames. Must have climate data loaded
  
  #' @param indMosq row of the dataframe for each individual mosquito
  #' @param climateDF the dataframe containing climate data every 10 minutes
  #' @param season, either "summer" or "fall"
  #' @returns formatted data with climate and winglength for the individual mosquito
  
  
  #get date range
  startDate <- ifelse(season=="summer", "2016-08-01", "2016-09-26")
  startDate <- as.Date(startDate, format="%Y-%m-%d")
  endDate <- indMosq$Date
  
  #subset temperature data
  try(climSubset <- climateDF %>%
    filter(Tray_ID==as.character(indMosq$Tray_ID)) %>%
    filter(Day>startDate & Day<endDate),
    silent=T)
  
  #now take mean temperature
  tempMean <- climSubset %>%
    summarise(Tmean=mean(Temp, na.rm=T))
  
  # if (nrow(climSubset)<1000){
  #   climSubset <- climate %>%
  #     filter(Site_ID==indMosq$site) %>%
  #     filter(Day>startDate & Day<endDate)
  # }
  
  #merge this all together
  #mosqFormat <- cbind(indMosq[,c('block','class','site','Tray_ID','Exp_Day', 'mm')], Tmean=tempMean$Tmean)
  
  return(tempMean$Tmean)
}

augWing$Temp <- NA
for(i in 1:nrow(augWing)){
  indMosq <- augWing[i,]
  augWing$Temp[i] <- getClimate(indMosq, season="summer")
}

octWing$Temp <- NA
for(i in 1:nrow(octWing)){
  indMosq <- octWing[i,]
  octWing$Temp[i] <- getClimate(indMosq, season="fall")
}

#combine
fallWing <- octWing %>%
  dplyr::select(block, class, site, Tray_ID, Exp_Day, mm, Temp)

summerWing <- augWing %>%
    dplyr::select(block, class, site, Tray_ID, Exp_Day, mm, Temp)

allWing <- rbind(summerWing, fallWing)
allWing$block<- as.factor(allWing$block)

#drop outlier in S2 (wing size =1.56 mm)
allWing <- allWing %>%
  filter(mm>1.6)
```


```{r}
ggplot(data=allWing, aes(x=Temp, y=mm)) +
  geom_point(aes(col=factor(class), shape=factor(block))) + 
  geom_smooth(method="lm")+
  theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank())+
  theme(legend.background = element_rect(fill = "transparent", colour = NA)) +
    theme(axis.title = element_text(), axis.title.x = element_text()) +
  ylab("Uninfected Wing Size")+
  xlab("Mean Temperature (C)") +
  scale_color_manual(values=c(colRural, "gray40", colU), name="Class", labels=c("Rural", "Suburban", "Urban"))+
  #scale_alpha_discrete(range=c(1,0.3), name="Season", labels=c("Fall", "Summer"), guide=guide_legend(reverse=T))+
  scale_shape_discrete(name="Season",labels=c("Fall", "Summer"), guide=guide_legend(reverse=T)) +
  theme(legend.position="right", legend.direction="vertical")+
  guides(shape=F) 
```

# Growth Rate

```{r}
#calculate means per Exp_Day and Tray
growthWing <- allWing %>%
  dplyr::group_by(block,class,site,Tray_ID, Exp_Day) %>%
  dplyr::summarise(meanWing=mean(mm, na.rm=T)) %>%
  dplyr::ungroup()

growthWing$class <- tolower(growthWing$class)

#merge with emergence data
growthDF <- merge(allEmerg, growthWing, by.x=c("block", "Class", "Site_Code", "Tray_Code", "Exp_Day"), by.y=c("block", "class", "site", "Tray_ID", "Exp_Day"), all.x=T) 

trayMeans <- allWing %>%
  dplyr::group_by(block, Tray_ID) %>%
  dplyr::summarise(meanWing=mean(mm, na.rm=T))

#fill in missing with mean of tray during that block
for (i in 1:nrow(growthDF)){
  if (is.na(growthDF$meanWing[i])){
    temp <- trayMeans$meanWing[trayMeans$block==growthDF$block[i] & trayMeans$Tray_ID==growthDF$Tray_Code[i]]
    if (length(temp)==0) next
    growthDF$meanWing[i] <- temp
  } else next
}

#some trays had no mosquitoes emerge that weren't infected, so we take the site level mean for them

siteMeans <- allWing %>%
  dplyr::group_by(site, block) %>%
  dplyr::summarise(meanWing=mean(mm, na.rm=T))

for (i in 1:nrow(growthDF)){
  if (is.na(growthDF$meanWing[i])){
    temp <- siteMeans$meanWing[siteMeans$block==growthDF$block[i] & siteMeans$site==growthDF$Site_Code[i]]
    if (length(temp)==0) next
    growthDF$meanWing[i] <- temp
  } else next
}

```

```{r}
growthDF$Fwx <- -121.240 + (78.02 * growthDF$meanWing)
growthDF$AxFwx <- growthDF$Num_Emerge*growthDF$Fwx
growthDF$xAxFwx <- growthDF$Exp_Day*growthDF$AxFwx

#get sum per day

growthDF2 <- growthDF %>%
  dplyr::group_by(block, Tray_Code, Class, Site_Code) %>%
  dplyr::summarise(xAxFwx = sum(xAxFwx), AxFwx=sum(AxFwx))

growthDF2 <- growthDF2 %>%
  mutate(r=(log((1/50)*AxFwx))/(14+(xAxFwx/AxFwx)))

levels(growthDF2$block) <- c("Summer", "Fall")
levels(growthDF2$Class) <- c("Rural", "Suburban", "Urban")
```

Three panel survival, emergence and growth rate

```{r three panel surv emerge and growth plot}
#png(file="figures/forMS/survEmergeGrowth.png", width = 4, height=7, units="in", res=500, family="sans")

survPlot <- ggplot(data=siteSumm, aes(x=Class, y=(numSurv*2)))+
  geom_boxplot(aes(fill=Class), width=0.4)+
  scale_fill_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  facet_wrap(~block, ncol=2)+
  ylab("Percent Survival")+
  theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        #strip.background = element_blank(),
        strip.text.x = element_text(size=12),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size=12),
        axis.text.x=element_text(size=12))+
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(),
        axis.title.y= element_text(size=10),
        strip.text = element_text(size=10))+
  theme(legend.position="none")

#Emergence Plot
emergePlot <- ggplot(emergExpF, aes(x=Class, y=(1/Exp_Day)))+
  geom_boxplot(aes(fill=Class), width=0.4)+
  scale_fill_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  facet_wrap(~block, ncol=2)+
  ylab("Development Rate")+
   theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        #strip.background = element_blank(),
        strip.text.x = element_text(size=12),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size=12),
        axis.text.x=element_text(size=12))+
  theme(legend.position="none") +
  theme(strip.background = element_blank(),
  strip.text.x = element_blank()) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(),
        axis.title.y= element_text(size=10))

growthPlot <- ggplot(data=growthDF2, aes(x=Class, y=r))+
  geom_boxplot(aes(fill=Class), width=0.4)+
  scale_fill_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  facet_wrap(~block, ncol=2)+
   theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        #strip.background = element_blank(),
        strip.text.x = element_text(size=12),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size=12),
        axis.text.x=element_text(size=12))+
  theme(legend.position="none") +
  theme(strip.background = element_blank(),
  strip.text.x = element_blank()) +
  ylab("Per Capita Growth\nRate (r')")+
  xlab("Land Class") +
  theme(axis.text.x = element_text(size=10)) +
  theme(axis.title = element_text(size=12), 
        axis.title.y= element_text(size=10))

plot_grid(survPlot, emergePlot, growthPlot,
          labels=c("A", "B", "C"),
          nrow=3,
          align='v')

#dev.off()
```


Statistics:

By Block and Site
```{r}
growthMix <- lmer(r~ block+ (1|Site_Code), data=growthDF2) #lowest AICc
tidy(growthMix)
car::Anova(growthMix) #Wald test
#confint(growthMix) #profiled confidence interval
drop1(growthMix, test="Chisq") #Likelihood ratio test

```

Across Temperature
```{r}
levels(allClim$block) <- factor(as.character(allClim$block), levels=c("Summer", "Fall"))
#get temperature data
growthTemp <- merge(growthDF2, allClim, by.x=c("block","Tray_Code"), by.y=c("block", "Tray_ID"))
ggplot(data=growthTemp, aes(x=Temp_mean, y=r))+
  geom_point(aes(color=Class))+
  geom_smooth(method="lm")

growthTempMod <- lm(r~Temp_mean,
                      data=growthTemp)
summary(growthTempMod)
anova(growthTempMod)
```

# Vectorial Capacity

Arrange temperature data by hour for rate summation
```{r}
climS <- climate[climate$Day >="2016-08-01" & climate$Day <="2016-09-03",]
climS$Block <- "summer"

climF <- climate[climate$Day >="2016-09-26" & climate$Day <="2016-11-08",]
climF$Block <- "fall"

#bind back together
climAll <- rbind(climS, climF)
climAll$Date <- as.POSIXct(climAll$Date)
climAll$Hour <- lubridate::hour(climAll$Date)

parameters <- dplyr::select(climAll, Block, Class, Site_ID, Tray_ID, Temp, Day, Hour)
```

Calculated set at 27C constant (x=27):

Briere:  y ~ a * x * (x - t0) * (tmax - x)^(1/2)
Quad: y ~ a * (x-t0) * (x-Tmax)

```{r}
parameters <- unique(dplyr::select(climAll, Block, Class, Site_ID))
#a -- bite rate
parameters$a <- ((1.93/10000)*27*(27-10.25)*((38.32-27)^0.5))
#adjust negatives
parameters$a[parameters$a<0] <- 0
parameters$a[is.na(parameters$a)] <- 0

# PDR - parasite development rate
parameters$PDR <- ((1.09/10000)*27*(27-10.39)*((43.05-27)^0.5))
#adjust negatives
parameters$PDR[parameters$PDR<0] <- 0
parameters$PDR[is.na(parameters$PDR)] <- 0

# lf - mosquito lifespan
parameters$lf <- -1.43*(27- 13.41)*(27-31.51)
#adjust for zeros
parameters$lf[parameters$lf<0] <- 0
parameters$lf[is.na(parameters$lf)] <- 0

# we will then calculate the mean and se for these parameters per site and hour, then sum them up for a daily value
library(dplyr)

paramRate <- parameters

paramRate <- dplyr::rename(paramRate, Site_Code=Site_ID)
paramRate <- dplyr::rename(paramRate, block=Block)

## u - daily probability of mosquito mortality
paramRate$mu <- 1/paramRate$lf

paramRate$block <- tolower(paramRate$block)
paramRate$Class <- tolower(paramRate$Class)

paramRateOld <- paramRate
```

Combine with field measured fecundity, survival, development rate and vector competence:

```{r}
#EFD: from wing length
EFD  <- allWing %>%
  group_by(block, Class=class, Site_Code=site) %>%
  dplyr::summarise(wingL=mean(mm, na.rm=T)) %>%
  ungroup() %>%
  mutate(fecundity=-121.240 + (78.02*wingL))
EFD$block <- tolower(EFD$block)
EFD$Class <- tolower(EFD$Class)

#pEA: larval survival
pEA <- survSumm %>%
  group_by(block, Class, Site_Code) %>%
  dplyr::summarise(pEA=mean((percSurv/50), na.rm=T))
pEA$block <- tolower(pEA$block)
pEA$Class <- tolower(pEA$Class)

#MDR: emergence rate (day^-1)
MDR <- emergExpF %>%
  group_by(block, Class, Site_Code) %>%
  dplyr::summarise(emerDay=mean(Exp_Day, na.rm=T)) %>%
  mutate(MDR=1/emerDay)
MDR$block <- tolower(MDR$block)
MDR$Class <- tolower(MDR$Class)

#bc
bc <- seasonInfSite %>%
  select(block, Class=class, Site_Code=site, bc=Saliva_mean)
bc$block <- tolower(bc$block)
bc$Class <- tolower(bc$Class)
```

Merge traits together
```{r}
paramRate <- full_join(paramRate, EFD, by=c("block", "Class", "Site_Code"))
paramRate <- full_join(paramRate, pEA, by=c("block", "Class", "Site_Code"))
paramRate <- full_join(paramRate, MDR, by=c("block", "Class", "Site_Code"))
paramRate <- full_join(paramRate, bc, by=c("block", "Class", "Site_Code"))
```

Calculate EFD
```{r}
paramRate$EFD <- paramRate$fecundity*paramRate$a
```

Calcuate VC w/o carry-over effects
```{r}
paramNoCOE <- dplyr::select(climAll, Block, Class, Site_ID, Tray_ID, Temp, Day, Hour)

#based on model
paramNoCOE$fecundity2 <- ((4.88/100)*27*(27-8.02)*((35.65-27)^0.5))/24
paramNoCOE$fecundity2[paramNoCOE$fecundity2<0] <- 0
paramNoCOE$fecundity2[is.na(paramNoCOE$fecundity2)] <- 0

paramNoCOE$bc2 <- (((7.35/10000)*27*(27-15.84)*((36.40-27)^0.5)) * ((4.39/10000)*27*(27-3.62)*((36.82-27)^0.5)))/24
paramNoCOE$bc2[paramNoCOE$bc2<0] <- 0
paramNoCOE$bc2[is.na(paramNoCOE$bc2)] <- 0


#take mean of each hour and sum up
library(dplyr)
paramRateNoCOE <- paramNoCOE %>%
  group_by(Block, Class, Site_ID, Hour) %>%
  select(-Temp, -Day, -Tray_ID) %>%
  summarise_all(funs(mean(.,na.rm=T))) %>%
  ungroup() %>%
  group_by(Block, Class, Site_ID) %>%
  summarise_all(funs(sum)) %>%
  ungroup()

paramRateNoCOE <- dplyr::rename(paramRateNoCOE, Site_Code=Site_ID)
paramRateNoCOE <- dplyr::rename(paramRateNoCOE, block=Block)

paramRateNoCOE$Class <- tolower(paramRateNoCOE$Class)
```

Merge w/ and w/o carry-over effects together
```{r}
paramAll <- full_join(paramRate, paramRateNoCOE, by=c("block", "Class", "Site_Code"))

#calculate EFD 
paramAll$EFD2 <- paramAll$fecundity2*paramAll$a
```


Calculate VC from traits (VCnoCOE is w/o carry-over)
```{r}
paramAll <- mutate(paramAll, 
                    VC=((a^2)*bc*(exp(-mu/PDR))*EFD*pEA*(MDR^2))/((mu^2)))

paramAll <- mutate(paramAll,
                   VCnoCOE=(((a^2)*bc2*(exp(-mu/PDR))*EFD2*pEA*(MDR^2))/((mu^2))))
```

Add Temperature Back in For Comparison Plots
```{r}
siteTemps <- select(seasonInfSite, block, site, class, Temp_mean_mean)
levels(paramAll$Class) <- c("Rural", "Suburban", "Urban")
VCplot <- merge(paramAll, siteTemps, by.x=c("block", "Site_Code"), by.y=c("block", "site"))
VCplot <- VCplot %>%
  dplyr::select(block, Class, Site_Code, VC, VCnoCOE, Temp_mean_mean) %>%
  mutate(VCdiff=(VC-VCnoCOE)/VCnoCOE*100)
VCplot$block <- factor(VCplot$block, levels=c("summer", "fall"))
```

Comparison Line Plot
```{r VC over Temp plot}
#pdf(file="figures/forMS/VCxTemp.pdf", width = 4, height=4, family="sans")

VCxTempPlot <- ggplot(data=VCplot, aes(x=Temp_mean_mean))+
  geom_smooth(aes(y=VC, color="WithCOE"), method="lm", show.legend=F)+
  geom_smooth(aes(y=VCnoCOE, color="WithoutCOE"),  method="lm", show.legend=F)+
  geom_smooth(aes(y=VC, color="WithCOE"), method="lm", fill=NA)+
  geom_smooth(aes(y=VCnoCOE, color="WithoutCOE"),  method="lm", fill=NA)+
  geom_point(aes(y=VC, color="WithCOE")) +
  geom_point(aes(y=VCnoCOE, color="WithoutCOE"))+
  coord_cartesian(ylim=c(0,40))+
  theme_fivethirtyeight()+
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        legend.position="bottom", 
        legend.direction="horizontal",
        axis.title = element_text(),
        legend.text=element_text(size=8), 
        legend.title = element_text(size=10),
        axis.line=element_line(color="gray40", size=0.5),
        panel.grid = element_blank())+
  guides(colour=guide_legend(title.position="top", title.hjust=0.5))+
  xlab("Temperature (C)")+
  ylab("Vectorial Capacity")+
  scale_colour_manual(name="Calcuation Type", 
                      #values=c(WithCOE="#af8dc3", WithoutCOE="#7fbf7b"),
                      values=c(WithCOE="black", WithoutCOE="gray55"),
                      labels=c("With COEs", "Without COEs"))
VCxTempPlot
#dev.off()
```

```{r}
#get mean and se summary
VCplotsumm <- VCplot %>%
  dplyr::select(-Site_Code) %>%
  gather(calc, value, VC, VCnoCOE, VCdiff) %>%
  group_by(block, Class, calc) %>%
  dplyr::summarise_each(funs(mean=mean(., na.rm=T), se=sd(.)/sqrt(n()))) %>%
  ungroup()
#add in facet labels
VCplotsumm$labels <- case_when(
  VCplotsumm$calc=="VC" ~ "With COEs" ,
  VCplotsumm$calc=="VCnoCOE" ~ "No COEs",
  VCplotsumm$calc=="VCdiff" ~ "Difference due to COEs"
)
VCplotsumm$labels <- factor(VCplotsumm$labels, levels=c("No COEs", "With COEs", "Difference due to COEs"))
#order factor
VCplotsumm$calc <- factor(VCplotsumm$calc, levels=c("VCnoCOE", "VC", "VCdiff"))
```

Panel Plots with Bar Graphs
```{r three panel bar graph of VC}

noCOEplot <- ggplot(data=VCplotsumm[VCplotsumm$labels=="No COEs",], aes(x=factor(Class), group=block)) +
  geom_bar(stat='identity',
           aes(y=value_mean, fill=Class, alpha=block, color=Class), 
           position=position_dodge(0.9), 
           width=0.7) + 
  geom_errorbar(aes(ymin=value_mean-value_se, ymax=value_mean+value_se),
                position=position_dodge(0.9), 
                width=0.4,
                color=errorColor)+
  ylim(0,50)+
  #facet_wrap(~labels, nrow=3) +
  #theme_fivethirtyeight() +
  ylab("Vectorial Capacity")+
  xlab("Land Class")+
  #theme_fivethirtyeight() +
  scale_x_discrete(labels=c("Rural", "Suburban", "Urban"))+
  scale_fill_manual(values=c(colR, colS, colU), 
                    labels=c("Rural", "Suburban", "Urban")) +
  scale_color_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(1,0), 
                       name="Season", 
                       guide=guide_legend(), 
                       labels=c("Summer", "Fall"))+
  #geom_hline(aes(yintercept=0))+
  guides(fill=F, alpha=F, color=F)+
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        legend.position="right", 
        axis.title.y=element_text(size=12), 
        axis.title.x = element_blank(), 
        axis.text.x = element_text(size=10),
        legend.text=element_text(size=6), 
        legend.title = element_text(size=8), 
        legend.key.size = unit(0.1, "in"), 
        legend.direction = "vertical", 
        legend.box = "vertical",
        panel.grid.major.x = element_blank(),
        panel.grid.major=element_blank(),
        strip.background = element_blank(),
        axis.ticks=element_blank(),
        axis.line=element_line(color=axisColor)) +
 theme(strip.text.x = element_text()) #this has to be seperate for some reason?

noCOEplot

withCOEplot <- ggplot(data=VCplotsumm[VCplotsumm$labels=="With COEs",], aes(x=factor(Class), group=block)) +
  geom_bar(stat='identity',
           aes(y=value_mean, fill=Class, alpha=block, color=Class), 
           position=position_dodge(0.9), 
           width=0.7) + 
  geom_errorbar(aes(ymin=value_mean-value_se, ymax=value_mean+value_se),
                position=position_dodge(0.9), 
                width=0.4,
                color=errorColor)+
  ylim(0,50)+
  #facet_wrap(~labels, nrow=3) +
  ylab("Vectorial Capacity")+
  xlab("Land Class")+
  #theme_fivethirtyeight() +
  scale_x_discrete(labels=c("Rural", "Suburban", "Urban"))+
  scale_fill_manual(values=c(colR, colS, colU), 
                    labels=c("Rural", "Suburban", "Urban")) +
  scale_color_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(1,0), 
                       name="Season", 
                       guide=guide_legend(), 
                       labels=c("Summer", "Fall"))+
  #geom_hline(aes(yintercept=0))+
  guides(color=F, fill=F, alpha=F)+
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        legend.position="right", 
        axis.title.y=element_text(size=12), 
        axis.title.x = element_blank(), 
        axis.text.x = element_text(size=10),
        legend.text=element_text(size=6), 
        legend.title = element_text(size=8), 
        legend.key.size = unit(0.1, "in"), 
        legend.direction = "vertical", 
        legend.box = "vertical",
        panel.grid.major.x = element_blank(),
        panel.grid.major=element_blank(),
        strip.background = element_blank(),
        axis.line = element_line(color=axisColor),
        axis.ticks=element_blank()) +
 theme(strip.text.x = element_text()) #this has to be seperate for some reason?

withCOEplot

diffPlot <- ggplot(data=VCplotsumm[VCplotsumm$labels=="Difference due to COEs",], aes(x=factor(Class), group=block)) +
  geom_bar(stat='identity',
           aes(y=value_mean, fill=Class, alpha=block, color=Class), 
           position=position_dodge(0.9), 
           width=0.7) + 
  geom_errorbar(aes(ymin=value_mean-value_se, ymax=value_mean+value_se),
                position=position_dodge(0.9), 
                width=0.4,
                color=errorColor)+
  #theme_fivethirtyeight() +
  ylab("Change in VC") +
  xlab("Land Class") +
  scale_x_discrete(labels=c("Rural", "Suburban", "Urban"))+
  scale_fill_manual(values=c(colR, colS, colU), 
                    labels=c("Rural", "Suburban", "Urban")) +
  scale_color_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(1,0), 
                       name="Season", 
                       guide=guide_legend(), 
                       labels=c("Summer", "Fall"))+
  geom_hline(aes(yintercept=0))+
  guides(color=F, alpha=guide_legend(override.aes=list(color=axisColor)))+
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        legend.position="bottom", 
        axis.title.y = element_text(size=12), 
        axis.title.x = element_text(size=12), 
        axis.text.x = element_text(size=10),
        legend.text=element_text(size=8), 
        legend.title = element_text(size=12), 
        legend.key.size = unit(0.1, "in"), 
        legend.direction = "horizontal", 
        legend.box = "vertical",
        panel.grid.major.x = element_blank(),
        panel.grid.major=element_blank(),
        strip.background = element_blank(),
        axis.ticks=element_blank(),
        axis.line = element_line(color=axisColor)) +
 theme(strip.text.x = element_text()) #this has to be seperate for some reason?
diffPlot

```

Use cowplot to combine the three bar graphs and VC over temp chart.
```{r}
#pdf(file="figures/forMS/VCPlot.pdf", width = 10, height=7, family="sans")

ggdraw()+
  draw_plot(VCxTempPlot, x=0, y=0, width=0.7, height=1)+
  draw_plot(noCOEplot, x=0.7, y=0.72, width=0.3, height=0.28)+
  draw_plot(withCOEplot, x=0.7, y=0.44, width=0.3, height=0.28)+
  draw_plot(diffPlot, x=0.685, y=0, width=0.3, height=0.44)+
  draw_plot_label(label=c("A", "B", "C", "D"),
                  x=c(0,0.67,0.67,0.67),
                  y=c(1,1,0.72,0.44))
#dev.off()
```



VC Stats:
```{r VC stats}
VCplot$VCforStats <- VCplot$VC+0.000000001
VCplot$VCforStatsnoCOE <- VCplot$VCnoCOE+0.000000001
VCclass <- glmer(VCforStats~Class*block+ (1|Site_Code), 
                 data=VCplot,
                family=Gamma())

plot(VCclass)
summary(VCclass)
car::Anova(VCclass)

VCclassnoCOE <- glmer(VCforStatsnoCOE~Class*block+ (1|Site_Code), 
                 data=VCplot,
                family=Gamma())

plot(VCclassnoCOE)
summary(VCclassnoCOE)
car::Anova(VCclassnoCOE)

#make long for comparison of with and without carry-over
VClong <- VCplot %>%
  gather(COE, value, VC, VCnoCOE)

VCtemp <- lm(value~Temp_mean_mean*COE, data=VClong)
plot(VCtemp)
summary(VCtemp)
```


