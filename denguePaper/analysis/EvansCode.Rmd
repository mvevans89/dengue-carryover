---
title: "Code for 'Carry-over effects of larval microclimate on the transmission potential of a mosquito-borne pathogen' (Evans et al.)"
author: "Michelle Evans"
date: ''
output:
  pdf_document: default
  html_document: default
---

This document contains the code for the analysis of mosquito population and infection data in 'Carry-over effects of larval microclimate on the transmission potential of a mosquito-borne pathogen' (Evans et al.).

Paper Citation:

Evans MV, Shiau JC, Solano N, Brindley MA, Drake JM, Murdock, CC. Carry-over effects of larval microclimate on the transmission potential of a mosquito-borne pathogen.  

# Set-Up

*NOTE*: Working directory should be set to source file location.

```{r knitr setup, echo=F}
knitr::opts_chunk$set(echo = T)
knitr::opts_chunk$set(cache=F)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(eval=T)
```

```{r package and color setup}
library(xtable)
library(tidyr)
library(ggplot2) 
library(lme4) #mixed models
library(broom) #easy model comparison
library(MuMIn)
library(car)
library(MASS)
library(gridExtra) #for facet grids later
library(cowplot)
library(caret)
library(ggthemes)
library(dplyr)
library(multcomp)
```

```{r set colors}
colR <- "dodgerblue"
colS <- "gray60"
colU <- "maroon"

axisColor <- "gray40"
errorColor <- "gray20"
```

# Data Loading and Formatting

## Climate

```{r}
augEnvVar <- readRDS("denguePaper/data/microclimate/clean/summerInfectionClimate.RData")
octEnvVar <- readRDS("denguePaper/data/microclimate/clean/fallInfectionClimate.RData")
```

Tray-level climate data over in both summer and fall replicates.

```{r}
climateTray <- readRDS("denguePaper/data/microclimate/clean/climateTraySummary.RData")
```


## Infection

```{r}
seasons <- readRDS("denguePaper/data/infections/clean/seasonInfection.RData")
```

Combine infection with climate that is relevant to infection

```{r}
seasonInf <- merge(seasons, rbind(augEnvVar, octEnvVar), by = c("Block", "Site_ID"))
```

### Efficiency

```{r}
efficiencyPlot <- readRDS("denguePaper/data/infections/clean/efficiencyPlot.RData")
```

## Direct Effects

```{r}
allSurv <- readRDS("denguePaper/data/emergence/clean/individuals.RData")
emergTray <- readRDS("denguePaper/data/emergence/clean/emergenceTray.RData")
```

Calculate tray level survival and link with climate

```{r}
survTray <- allSurv %>%
  filter(Sex=="F") %>%
  group_by(Tray_ID, Site_ID, Class, Block) %>%
  summarise(survival=mean(event, na.rm = T)) %>%
  ungroup()

survClim <- survTray %>%
  left_join(climateTray, by = c("Block", "Tray_ID", "Class", "Site_ID"))
```

Add tray-level climate data to emergence

```{r}
emergClim <- merge(emergTray, climateTray, by=c("Block","Tray_ID", "Class", "Site_ID"))
```

## Indirect Effects

Wing Length

```{r}
allWing <- readRDS("denguePaper/data/emergence/clean/wingLength.RData")
```

Growth Rate

```{r}
growthDF2 <- readRDS("denguePaper/data/emergence/clean/growthRates.RData")
```

# Infection Dynamics

## Infection by Class and Season

### Prepping for Plot

```{r infection data format}
infLong <- readRDS("denguePaper/data/infections/clean/infectionSummaryLong.RData")
```

Infection plot to combine in 6 panel figure in chunk 46.

```{r}
bodyPlot <- ggplot(data=infLong[infLong$type=="Body",], aes(x=Class, group=Block))+
  geom_bar(stat="identity", aes(y=mean.inf, alpha=Block, fill=Class), color="gray20", position=position_dodge(width=-0.9))+
  scale_y_continuous(breaks=c(0,0.5,1), minor_breaks = c(0.25, 0.75), labels=c("0%", "50%", "100%"), limits=c(0,1))+
  scale_fill_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(0.1,1), name="Season", labels=c("Fall", "Summer"))+
  geom_errorbar(aes(ymin=mean.inf-se.inf, ymax=mean.inf+se.inf), width=0.2, color="gray20", position =position_dodge(-0.9))+
  guides(fill = F, color = F,
         alpha = F) +
  ylab("Percent Positive") +
  theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_blank(),
        axis.title.y=element_text(size = 10),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10))

headPlot <- ggplot(data=infLong[infLong$type=="Head",], aes(x=Class, group=Block))+
  geom_bar(stat="identity", aes(y=mean.inf, alpha=Block, fill=Class), color="gray20", position=position_dodge(width=-0.9))+
  scale_y_continuous(breaks=c(0,0.5,1), minor_breaks = c(0.25, 0.75), labels=c("0%", "50%", "100%"), limits=c(0,1))+
  scale_fill_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(0.1,1), name="Season", labels=c("Fall", "Summer"))+
  geom_errorbar(aes(ymin=mean.inf-se.inf, ymax=mean.inf+se.inf), width=0.2, color="gray20", position =position_dodge(-0.9))+
  ylab("Percent Positive") +
  guides(fill = F, color = F,
         alpha = F) +
  theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_blank(),
        axis.title.y=element_text(size = 10),
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10))

SalivaPlot <- ggplot(data=infLong[infLong$type=="Saliva",], aes(x=Class, group=Block))+
  geom_bar(stat="identity", aes(y=mean.inf, alpha=Block, fill=Class), color="gray20", position=position_dodge(width=-0.9))+
  scale_y_continuous(breaks=c(0,0.5,1), minor_breaks = c(0.25, 0.75), labels=c("0%", "50%", "100%"), limits=c(0,1))+
  scale_fill_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(0.1,1), name="Season", labels=c("Fall", "Summer"))+
  geom_errorbar(aes(ymin=mean.inf-se.inf, ymax=mean.inf+se.inf), width=0.2, color="gray20", position =position_dodge(-0.9))+
  xlab("Land Class") +
  ylab("Percent Positive")+
  guides(fill = F, color = F,
         alpha = F) +
  theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_text(size = 10),
        axis.title.y=element_text(size = 10),
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size = 10),
        axis.text.x=element_text(size = 10),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10))
```


### Statistics on infection by season and land class

```{r final seasonal infection stats}
mixModelseasonsBody21 <- lme4::glmer(Body~Class*Block + (1|Site_ID), 
                          data=seasons,
                          family=binomial(link="logit"))
summary(mixModelseasonsBody21)
tidy(mixModelseasonsBody21)
car::Anova(mixModelseasonsBody21) #Wald test
drop1(mixModelseasonsBody21, test="Chisq") #Likelihood ratio test
summary(multcomp::glht(mixModelseasonsBody21, linfct = multcomp::mcp(Class = "Tukey"), test = multcomp::adjusted("holm")))
summary(multcomp::glht(mixModelseasonsBody21, linfct = multcomp::mcp(Block = "Tukey"), test = multcomp::adjusted("holm")))
#confint(mixModelseasonsBody21)

mixModelseasonsHead21 <- lme4::glmer(Head~Class*Block  + (1|Site_ID), 
                          data=seasons,
                          family=binomial(link="logit"))
tidy(mixModelseasonsHead21)
car::Anova(mixModelseasonsHead21) #Wald test
#confint(mixModelseasonsHead21) #profiled confidence interval
drop1(mixModelseasonsHead21, test="Chisq")
summary(multcomp::glht(mixModelseasonsHead21, linfct = multcomp::mcp(Class = "Tukey"), test = multcomp::adjusted("holm")))
summary(multcomp::glht(mixModelseasonsHead21, linfct = multcomp::mcp(Block = "Tukey"), test = multcomp::adjusted("holm")))

mixModelseasonsSaliva21 <- lme4::glmer(Saliva~Class*Block  + (1|Site_ID), 
                          data=seasons,
                          family=binomial(link="logit"))
tidy(mixModelseasonsSaliva21) #z-test
car::Anova((mixModelseasonsSaliva21)) #Wald test
#confint(mixModelseasonsSaliva21) #profiled confidence interval
drop1(mixModelseasonsSaliva21, test="Chisq")
#pairwise comparison
summary(multcomp::glht(mixModelseasonsSaliva21, linfct = multcomp::mcp(Block = "Tukey"), test = multcomp::adjusted("holm")))
```

## Infection Efficiency

Plot of infection efficiency.

```{r plot efficiency, eval=F}
#supplemental plot
ggplot(data=efficiencyPlot[order(meltAll$Block, decreasing=F),], aes(x=Class, group=Block))+
  geom_bar(stat="identity", aes(y=mean, alpha=factor(Block), fill=factor(Class)), color="gray20", position=position_dodge(width=-0.9))+
  facet_wrap(~type, nrow=3, dir="v") +
  scale_fill_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(1,0.3), name="Season", labels=c("Fall", "Summer"), guide=guide_legend(reverse=T))+
  geom_errorbar(aes(ymin=mean-SE, ymax=mean+SE), width=0.2, color="gray20", position =position_dodge(-0.9))+
  theme_base() + 
  xlab("Land Class") +
  ylab("Infection Efficiency") +
  guides(fill=F)
```


```{r efficiency stats}
#model 
mixModelseasonsBody21 <- lme4::glmer(Body~class + Block + (1|site), 
                          data=seasons[seasons$DPI=="21",],
                          family=binomial(link="logit"))
tidy(mixModelseasonsBody21)
car::Anova(mixModelseasonsBody21)
summary(multcomp::glht(mixModelseasonsBody21, linfct = multcomp::mcp(class = "Tukey"), test = multcomp::adjusted("holm")))
summary(multcomp::glht(mixModelseasonsBody21, linfct = multcomp::mcp(Block = "Tukey"), test = multcomp::adjusted("holm")))


mixModelseasonsHead21 <- lme4::glmer(Head~Block  + (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Body==1,],
                          family=binomial(link="logit"))
tidy(mixModelseasonsHead21)
car::Anova(mixModelseasonsHead21) #no effect
drop1(mixModelseasonsHead21, test="Chisq")
summary(multcomp::glht(mixModelseasonsHead21, linfct = multcomp::mcp(Block = "Tukey"), test = multcomp::adjusted("holm")))

mixModelseasonsSaliva21 <- lme4::glmer(Saliva~class + Block  + (1|site), 
                          data=seasons[seasons$DPI=="21" & seasons$Head==1,],
                          family=binomial(link="logit"))
tidy(mixModelseasonsSaliva21)
car::Anova((mixModelseasonsSaliva21)) #only Block is significant
drop1(mixModelseasonsSaliva21, test="Chisq")
summary(multcomp::glht(mixModelseasonsSaliva21, linfct = multcomp::mcp(class = "Tukey"), test = multcomp::adjusted("holm")))
summary(multcomp::glht(mixModelseasonsSaliva21, linfct = multcomp::mcp(Block = "Tukey"), test = multcomp::adjusted("holm")))
```

## Infection and Microclimate

```{r create dataframe of site-aggregated infections}
seasonSite <- seasons %>%
  dplyr::select(-Individual, - Wing) %>%
  dplyr::group_by(Block, Class, Site_ID) %>%
  summarise_all(funs(mean(.,na.rm=T), se=(sd(., na.rm=T)/sqrt(n())))) %>%
  ungroup()

#group with temperature data
seasonInfSite <- merge(seasonSite, rbind(augEnvVar,octEnvVar), by=c("Block", "Site_ID"))

# inspect variable correlations
# cor(seasonInfSite[,10:18])
```

```{r body x climate stats}
#model selection
m0 <- glm(Body_mean ~ 1,
          data = seasonInfSite,
         family = gaussian(link="log"))
m1 <- glm(Body_mean ~ Temp_mean_mean, 
          data=seasonInfSite, 
          family=gaussian(link="log"))



modelSums <- do.call(rbind, lapply(list(m0, m1), broom::glance))
modelSums

Weights(AICc(m0, m1))
tidy(m1)


finalBody <- glm(Body_mean ~ Temp_mean_mean, 
          data=seasonInfSite, 
          family=gaussian(link="log"))
plot(finalBody)

car::Anova(finalBody)
confint(finalBody)
tidy(finalBody)
drop1(finalBody, test="F")

```

```{r head x climate stats}
#model selection
m0 <- glm(Head_mean ~ 1, 
          data=seasonInfSite, 
          family=gaussian(link="log"))
m1 <- glm(Head_mean ~ Temp_mean_mean, 
          data=seasonInfSite, 
          family=gaussian(link="log"))

modelSums <- do.call(rbind, lapply(list(m0, m1), broom::glance)) 

Weights(AICc(m0, m1))
tidy(m1)


finalHead <- glm(Head_mean ~ Temp_mean_mean, 
          data=seasonInfSite, 
          family=gaussian(link="log"))

plot(finalHead)

car::Anova(finalHead)
#confint(finalHead)
drop1(finalHead, test="F")
tidy(finalHead)
```

```{r saliva x climate stats}
#model selection
m0 <- glm(Saliva_mean ~ 1, 
          data=seasonInfSite,
          family=gaussian)
m1 <- glm(Saliva_mean ~ Temp_mean_mean, 
          data=seasonInfSite,
          family=gaussian)

modelSums <- do.call(rbind, lapply(list(m0, m1), broom::glance)) 

Weights(AICc(m0,m1))


finalSal <- glm(Saliva_mean ~ Temp_mean_mean, 
                data=seasonInfSite,
                family=gaussian)

plot(finalSal)

plot(cooks.distance(finalSal))

car::Anova(finalSal)
#confint(finalSal)
drop1(finalSal, test="F")
tidy(finalSal)

```

```{r three panel temp x infection plot, eval=F, include=F}
#pdf(file="figures/forMS/InfxTemp3Panel.pdf", width = 8, height=3, family="sans")
plotBody <- ggplot(data=seasonInfSite, aes(x=Temp_mean_mean, y=Body_mean))+
  geom_errorbar(aes(ymin=Body_mean-Body_se, ymax=Body_mean+Body_se), color=errorColor, width=0.1) +
  geom_point(aes(color=class, shape=Block), size=4.5) + 
  scale_color_manual(values=c(colR, colS, colU)) +
  theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(),
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank())+
  ylab("Prop. Infected")+
  xlab("") +  
  theme(legend.position="none")

plotHead <- ggplot(data=seasonInfSite, aes(x=Temp_mean_mean, y=Head_mean))+
   geom_errorbar(aes(ymin=Head_mean-Head_se, ymax=Head_mean+Head_se), color=errorColor, width=0.1) +
  geom_point(aes(color=class, shape=Block), size=4) + 
  scale_color_manual(values=c(colR, colS, colU)) +
  theme_fivethirtyeight() +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(),
        axis.title.x = element_text(),
        axis.title.y=element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank())+
  #ylab("Prop. Disseminated")+
  xlab("Mean Daily Temperature (C)")+
  theme(legend.position="none")

plotSaliva <- ggplot(data=seasonInfSite, aes(x=Temp_mean_mean, y=Saliva_mean))+
  geom_errorbar(aes(ymin=Saliva_mean-Saliva_se, ymax=Saliva_mean+Saliva_se), color=errorColor, width=0.1) +
  #geom_errorbarh(aes(xmin=Temp_mean_mean-Temp_mean_se, xmax=Temp_mean_mean+Temp_mean_se, y=Body_mean),color="gray20", height=0.05) + #not enough error to see
  geom_point(aes(color=class, shape=Block), size=4.5) + 
  scale_color_manual(values=c(colR, colS, colU)) +
  theme_fivethirtyeight() +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(),
        axis.title.x = element_text(),
        axis.title.y=element_blank(),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank()) +
  #ylab("Prop. Infectious")+
  xlab("") +  
  scale_y_continuous(limits=c(0,1))+
  #theme(legend.position="right", legend.direction="vertical")
  theme(legend.position="none")


plot_grid(plotBody, plotHead, plotSaliva, 
          labels=c("A", "B", "C"), 
          ncol=3)
#dev.off()
```

## Infection and Body Size

### Body Infection

```{r body inf x size stats}
bodyWing <- glmer(Body~Wing + (1|Site_ID),
                          data=seasonInf,
                          family=binomial(link="logit"))

tidy(bodyWing)
summary(bodyWing)

Anova(bodyWing)
drop1(bodyWing, test="Chisq")
```

```{r body inf x size plot, eval=F, include=F}
ggplot(data=seasonInf, aes(x=factor(Body), y=Wing))+
  geom_boxplot() +
  geom_jitter(shape=16, position=position_jitter(0.1), aes(color=factor(class)), alpha=0.5) +
    theme_fivethirtyeight()+
  theme(axis.title = element_text()) +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank())+
  theme(legend.background = element_rect(fill = "transparent", colour = NA))+
  theme(legend.position="right", legend.direction="vertical") +
  scale_color_manual(values=c("dodgerblue", "gray10", "maroon"), labels=c("Rural", "Suburban", "Urban"))+
    scale_fill_manual(values=c("dodgerblue", "gray80", "maroon"), labels=c("Rural", "Suburban", "Urban")) +
  guides(color=F) +
  xlab("Body Positivity") +
  ylab("Wing Size")
```

### Head Infection

```{r head inf x size stats}
headWing <- glmer(Head~Wing + (1|Site_ID),
                          data=seasonInf,
                          family=binomial(link="logit"))

tidy(headWing)
plot(headWing)

Anova(headWing)
drop1(headWing, test="Chisq")
```

### Saliva Infection

```{r saliva inf x size stats}
salWing <- glmer(Saliva~Wing + (1|Site_ID),
                          data=seasonInf,
                          family=binomial(link="logit"))
summary(salWing)
tidy(salWing)

Anova(salWing)
drop1(salWing, test="Chisq")
```

# Direct Effects

## Survival

### Class x Season

```{r}
SurvModSeason <- glmer(survival ~ Class*Block + (1|Site_ID),
                   data=survTray,
                 family=gaussian(link="logit"))

summary(SurvModSeason)
modResults <- tidy(SurvModSeason)
plot(SurvModSeason)
car::Anova(SurvModSeason)

summary(multcomp::glht(SurvModSeason, linfct = multcomp::mcp(Block = "Tukey"), test = adjusted("holm")))
```

### Microclimate

```{r}
survModClim <- glmer(survival~meanT+(1|Site_ID),
                    data=survClim,
                    family=gaussian("logit"))

summary(survModClim)
modResults <- tidy(survModClim)

plot(survModClim)
qqnorm(resid(survModClim))
```

## Emergence

### Class x Season

```{r}
mixEmergeTray <- lmer(devRate ~ Class*Block +(1|Site_ID), 
                   data=emergTray)

summary(mixEmergeTray)
tidy(mixEmergeTray)
plot(mixEmergeTray)
qqnorm(resid(mixEmergeTray))
#confint(mixEmerge)
Anova(mixEmergeTray)

#pairwise
summary(multcomp::glht(mixEmergeTray, linfct = multcomp::mcp(Block = "Tukey"), test = adjusted("holm")))
```

### Microclimate

```{r}
devClimMod <- lmerTest::lmer(devRate~meanT +(1|Site_ID),
                    data=emergClim)

plot(devClimMod)
qqnorm(resid(devClimMod))
summary(devClimMod)
```

# Indirect Effects

## Uninfected Body Size

### Land Class x Season

```{r}
wingMod <- lmerTest::lmer(mm~class*Block +(1|Site_ID),
                data=allWing)
summary(wingMod)
plot(wingMod)
car::Anova(wingMod)


interaction.plot(allWing$class, allWing$Block, allWing$mm)
```

### Microclimate

Statistics:
```{r}
wingModTemp <- lmerTest::lmer(mm~Temp+(1|Site_ID),
                    data=allWing)
plot(wingModTemp)
summary(wingModTemp)
#confint(wingModTemp) #no effect of temperature
qqnorm(resid(wingModTemp))
car::Anova(wingModTemp)
```

# Growth Rate

## Plot

Figure 1.

```{r}
#survival
survPlot <- ggplot(data=survTray)+
  geom_boxplot(aes(alpha=Block, x = as.factor(Class), y = (survival *100), fill = Class), width=0.7)+
  scale_fill_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  scale_color_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  scale_alpha_discrete(range=c(1, 0.1), name="Season", labels=c("Summer", "Fall"))+
  ylab("Percent Survival")+
  theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        #strip.background = element_blank(),
        strip.text.x = element_text(size=10),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10))+
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(),
        axis.title.y= element_text(size=10),
        strip.text = element_text(size=10))+
  theme(legend.position="none")

#Emergence Plot
emergePlot <- ggplot(emergTray)+
  geom_boxplot(aes(alpha=Block, x = as.factor(Class), y = (devRate), fill = Class), width=0.7)+
  scale_fill_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  scale_alpha_discrete(range=c(1, 0.1), name="Season", labels=c("Summer", "Fall"))+
  ylab("Development Rate")+
   theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        #strip.background = element_blank(),
        strip.text.x = element_text(size=10),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10))+
  theme(legend.position="none") +
  theme(strip.background = element_blank(),
  strip.text.x = element_blank()) +
  theme(axis.title.x = element_blank(), 
        axis.text.x = element_blank(),
        axis.title.y= element_text(size=10))

# growth plot
growthPlot <- ggplot(data=growthDF2)+
  geom_boxplot(aes(alpha=Block, x = as.factor(class), y = r, fill = class), width=0.7)+
  scale_fill_manual(values=c(colR, colS, colU), labels=c("Rural", "Suburban", "Urban"))+
  scale_alpha_discrete(range=c(1, 0.1), name="Season", labels=c("Summer", "Fall"))+
   theme_fivethirtyeight() +
  theme(panel.background = element_rect(fill = "transparent", colour = NA), 
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        axis.title = element_text(), 
        axis.title.x = element_text(),
        axis.title.y=element_text(),
        #strip.background = element_blank(),
        strip.text.x = element_text(size=10),
        axis.line=element_line(color=axisColor, size=0.5),
        panel.grid = element_blank(),
        axis.text.y=element_text(size=10),
        axis.text.x=element_text(size=10))+
  theme(legend.position="none") +
  theme(strip.background = element_blank(),
  strip.text.x = element_blank()) +
  ylab("Growth Rate (r')")+
  xlab("Land Class") +
  theme(axis.text.x = element_text(size=10)) +
  theme(axis.title = element_text(size=10), 
        axis.title.y= element_text(size=10))
```


Combine infection and demographic data into Figure 1.

```{r Figure 1}
pdf(file="figures/forMS/Fig1.pdf", width = 6.5, height=6, family="sans")
ggdraw()+
  draw_plot(survPlot, x=0.01, y=0.69, width=0.5, height=0.31)+
  draw_plot(emergePlot, x=0, y=0.38, width=0.5, height=0.31)+
  draw_plot(growthPlot, x=0, y=0, width=0.5, height=0.36)+
  draw_plot(bodyPlot, x=0.475, y=0.69, width=0.5, height=0.31)+
  draw_plot(headPlot, x=0.475, y=0.38, width=0.5, height=0.31)+
  draw_plot(SalivaPlot, x=0.475, y=0, width=0.5, height=0.36)+
  draw_plot_label(label=c("A", "B", "C", "D", "E", "F"),
                  x=c(0,0,0,0.45, 0.45, 0.45),
                  y=c(1,0.69,0.38,1,0.69,0.38))
dev.off()
```


## Statistics
### Season x Land Class

```{r}
growthModSeason <- lmer(r~ Class*Block+ (1|Site_ID), 
                        data=growthDF2)

summary(growthModSeason)
plot(growthModSeason)

tidy(growthModSeason)
car::Anova(growthModSeason) #Wald test
#confint(growthModSeason) #profiled confidence interval

```

### Microclimate

```{r}
growthTempMod <- lmerTest::lmer(r~meanT + (1|Site_ID),
                      data=growthDF2)
summary(growthTempMod)
anova(growthTempMod)
plot(growthTempMod)
```

# Vectorial Capacity

```{r}
climS <- climate[climate$Day >="2016-08-01" & climate$Day <="2016-09-03",]
climS$Block <- "summer"

climF <- climate[climate$Day >="2016-09-26" & climate$Day <="2016-11-08",]
climF$Block <- "fall"

#bind back together
climAll <- rbind(climS, climF)
climAll$Date <- as.POSIXct(climAll$Date)
climAll$Hour <- lubridate::hour(climAll$Date)

parameters <- dplyr::select(climAll, Block, Class, Site_ID, Tray_ID, Temp, Day, Hour)
```

Calculated set at 27C constant (x=27):

Briere:  $y = a * x * (x - t_0) * (t_{max} - x)^{(1/2)}$
Quad: $y = a * (x-t_0) * (x-t_{max})$

```{r}
parameters <- unique(dplyr::select(climAll, Block, Class, Site_ID))
#a -- bite rate
parameters$a <- ((1.93/10000)*27*(27-10.25)*((38.32-27)^0.5))
#adjust negatives
parameters$a[parameters$a<0] <- 0
parameters$a[is.na(parameters$a)] <- 0

# PDR - parasite development rate
parameters$PDR <- ((1.09/10000)*27*(27-10.39)*((43.05-27)^0.5))
#adjust negatives
parameters$PDR[parameters$PDR<0] <- 0
parameters$PDR[is.na(parameters$PDR)] <- 0

# lf - mosquito lifespan
parameters$lf <- -1.43*(27- 13.41)*(27-31.51)
#adjust for zeros
parameters$lf[parameters$lf<0] <- 0
parameters$lf[is.na(parameters$lf)] <- 0

# we will then calculate the mean and se for these parameters per site and hour, then sum them up for a daily value
library(dplyr)

paramRate <- parameters

paramRate <- dplyr::rename(paramRate, Site_ID=Site_ID)
paramRate <- dplyr::rename(paramRate, Block=Block)

## u - daily probability of mosquito mortality
paramRate$mu <- 1/paramRate$lf

paramRate$Block <- tolower(paramRate$Block)
paramRate$Class <- tolower(paramRate$Class)

paramRateOld <- paramRate
```

Combine with field measured fecundity, survival, development rate and vector competence:

```{r}
#EFD: from wing length
EFD  <- allWing %>%
  group_by(Block, Class=class, Site_ID) %>%
  dplyr::summarise(wingL=mean(mm, na.rm=T)) %>%
  ungroup() %>%
  mutate(fecundity=-121.240 + (78.02*wingL))
EFD$Block <- tolower(EFD$Block)
EFD$Class <- tolower(EFD$Class)

#pEA: larval survival
pEA <- survSumm %>%
  group_by(Block, Class, Site_ID) %>%
  dplyr::summarise(pEA=mean((percSurv/50), na.rm=T))
pEA$Block <- tolower(pEA$Block)
pEA$Class <- tolower(pEA$Class)

#MDR: emergence rate (day^-1)
MDR <- emergTray %>%
  group_by(Block, Class, Site_ID) %>%
  dplyr::summarise(MDR=mean(devRate, na.rm=T))
MDR$Block <- tolower(MDR$Block)
MDR$Class <- tolower(MDR$Class)

#bc
bc <- seasonInfSite %>%
  dplyr::select(Block, Class=class, Site_ID=site, bc=Saliva_mean)
bc$Block <- tolower(bc$Block)
bc$Class <- tolower(bc$Class)
```

Merge traits together
```{r}
paramRate <- full_join(paramRate, EFD, by=c("Block", "Class", "Site_ID"))
paramRate <- full_join(paramRate, pEA, by=c("Block", "Class", "Site_ID"))
paramRate <- full_join(paramRate, MDR, by=c("Block", "Class", "Site_ID"))
paramRate <- full_join(paramRate, bc, by=c("Block", "Class", "Site_ID"))
```

Calculate EFD
```{r}
paramRate$EFD <- paramRate$fecundity*paramRate$a
```


Calcuate VC w/o carry-over effects
```{r}
paramNoCOE <- dplyr::select(climAll, Block, Class, Site_ID, Tray_ID, Temp, Day, Hour)

#based on model
paramNoCOE$fecundity2 <- ((4.88/100)*27*(27-8.02)*((35.65-27)^0.5))/24
paramNoCOE$fecundity2[paramNoCOE$fecundity2<0] <- 0
paramNoCOE$fecundity2[is.na(paramNoCOE$fecundity2)] <- 0

paramNoCOE$bc2 <- (((7.35/10000)*27*(27-15.84)*((36.40-27)^0.5)) * ((4.39/10000)*27*(27-3.62)*((36.82-27)^0.5)))/24
paramNoCOE$bc2[paramNoCOE$bc2<0] <- 0
paramNoCOE$bc2[is.na(paramNoCOE$bc2)] <- 0


#take mean of each hour and sum up
library(dplyr)
paramRateNoCOE <- paramNoCOE %>%
  group_by(Block, Class, Site_ID, Hour) %>%
  dplyr::select(-Temp, -Day, -Tray_ID) %>%
  summarise_all(funs(mean(.,na.rm=T))) %>%
  ungroup() %>%
  group_by(Block, Class, Site_ID) %>%
  summarise_all(funs(sum)) %>%
  ungroup()

paramRateNoCOE <- dplyr::rename(paramRateNoCOE, Site_ID=Site_ID)
paramRateNoCOE <- dplyr::rename(paramRateNoCOE, Block=Block)

paramRateNoCOE$Class <- tolower(paramRateNoCOE$Class)
```

Merge w/ and w/o carry-over effects together
```{r}
paramAll <- full_join(paramRate, paramRateNoCOE, by=c("Block", "Class", "Site_ID"))

#calculate EFD 
paramAll$EFD2 <- paramAll$fecundity2*paramAll$a
```


Calculate VC from traits (VCnoCOE is w/o carry-over)

```{r}
paramAll <- mutate(paramAll, 
                    VC=((a^2)*bc*(exp(-mu/PDR))*EFD*pEA*(MDR^2))/((mu^2)))

paramAll <- mutate(paramAll,
                   VCnoCOE=(((a^2)*bc2*(exp(-mu/PDR))*EFD2*pEA*(MDR^2))/((mu^2))))
```

## Plot

Figure 3.

```{r}
siteTemps <- dplyr::select(seasonInfSite, Block, site, class, Temp_mean_mean)
levels(paramAll$Class) <- c("Rural", "Suburban", "Urban")
VCplot <- merge(paramAll, siteTemps, by.x=c("Block", "Site_ID"), by.y=c("Block", "site"))
VCplot <- VCplot %>%
  dplyr::select(Block, Class, Site_ID, VC, VCnoCOE, Temp_mean_mean) %>%
  mutate(VCdiff=(VC-VCnoCOE)/VCnoCOE*100)
VCplot$Block <- factor(VCplot$Block, levels=c("summer", "fall"))
```

```{r VC over Temp plot}

VCxTempPlot <- ggplot(data=VCplot, aes(x=Temp_mean_mean))+
  geom_smooth(aes(y=VC, color="WithCOE"), method="lm", show.legend=F)+
  geom_smooth(aes(y=VCnoCOE, color="WithoutCOE"),  method="lm", show.legend=F)+
  geom_smooth(aes(y=VC, color="WithCOE"), method="lm", fill=NA)+
  geom_smooth(aes(y=VCnoCOE, color="WithoutCOE"),  method="lm", fill=NA)+
  geom_point(aes(y=VC, color="WithCOE")) +
  geom_point(aes(y=VCnoCOE, color="WithoutCOE"))+
  coord_cartesian(ylim=c(0,40))+
  theme_fivethirtyeight()+
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        legend.position="bottom", 
        legend.direction="horizontal",
        axis.title = element_text(),
        legend.text=element_text(size=8), 
        legend.title = element_text(size=10),
        axis.line=element_line(color="gray40", size=0.5),
        panel.grid = element_blank())+
  guides(color = F)+
  #guides(colour=guide_legend(title.position="top", title.hjust=0.5))+
  xlab("Temperature (C)")+
  ylab("Vectorial Capacity")+
  scale_colour_manual(name="Calcuation Type", 
                      #values=c(WithCOE="#af8dc3", WithoutCOE="#7fbf7b"),
                      values=c(WithCOE="black", WithoutCOE="gray55"),
                      labels=c("With COEs", "Without COEs")) +
  annotate(geom = "text", x = 21, y = 38, col = "black", size = 3,
           label = "VC = -72.208 + 3.912 x Temp (without COE)") +
  annotate(geom = "text", x = 20.845, y = 35, col = "black", size = 3,
           label = "VC = -15.280 + 0.802 x Temp (with COE)")
```

```{r}
pdf(file="figures/forMS/Fig2.pdf", width = 5, height=4, family="sans")
VCxTempPlot
dev.off()
```


```{r}
#get mean and se summary
VCplotsumm <- VCplot %>%
  dplyr::select(-Site_ID) %>%
  gather(calc, value, VC, VCnoCOE, VCdiff) %>%
  group_by(Block, Class, calc) %>%
  dplyr::summarise_all(funs(mean=mean(., na.rm=T), se=sd(.)/sqrt(n()))) %>%
  ungroup()
#add in facet labels
VCplotsumm$labels <- case_when(
  VCplotsumm$calc=="VC" ~ "With COEs" ,
  VCplotsumm$calc=="VCnoCOE" ~ "No COEs",
  VCplotsumm$calc=="VCdiff" ~ "Difference due to COEs"
)
VCplotsumm$labels <- factor(VCplotsumm$labels, levels=c("No COEs", "With COEs", "Difference due to COEs"))
#order factor
VCplotsumm$calc <- factor(VCplotsumm$calc, levels=c("VCnoCOE", "VC", "VCdiff"))
```


```{r three panel bar graph of VC, eval = F, include = F}

noCOEplot <- ggplot(data=VCplotsumm[VCplotsumm$labels=="No COEs",], aes(x=factor(Class), group=Block)) +
  geom_bar(stat='identity',
           aes(y=value_mean, fill=Class, alpha=Block, color=Class), 
           position=position_dodge(0.9), 
           width=0.7) + 
  geom_errorbar(aes(ymin=value_mean-value_se, ymax=value_mean+value_se),
                position=position_dodge(0.9), 
                width=0.4,
                color=errorColor)+
  ylim(0,50)+
  #facet_wrap(~labels, nrow=3) +
  #theme_fivethirtyeight() +
  ylab("Vectorial Capacity")+
  xlab("Land Class")+
  #theme_fivethirtyeight() +
  scale_x_discrete(labels=c("Rural", "Suburban", "Urban"))+
  scale_fill_manual(values=c(colR, colS, colU), 
                    labels=c("Rural", "Suburban", "Urban")) +
  scale_color_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(1,0), 
                       name="Season", 
                       guide=guide_legend(), 
                       labels=c("Summer", "Fall"))+
  #geom_hline(aes(yintercept=0))+
  guides(fill=F, alpha=F, color=F)+
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        legend.position="right", 
        axis.title.y=element_text(size=12), 
        axis.title.x = element_blank(), 
        axis.text.x = element_text(size=10),
        legend.text=element_text(size=6), 
        legend.title = element_text(size=8), 
        legend.key.size = unit(0.1, "in"), 
        legend.direction = "vertical", 
        legend.box = "vertical",
        panel.grid.major.x = element_blank(),
        panel.grid.major=element_blank(),
        strip.background = element_blank(),
        axis.ticks=element_blank(),
        axis.line=element_line(color=axisColor)) +
 theme(strip.text.x = element_text()) #this has to be seperate for some reason?


withCOEplot <- ggplot(data=VCplotsumm[VCplotsumm$labels=="With COEs",], aes(x=factor(Class), group=Block)) +
  geom_bar(stat='identity',
           aes(y=value_mean, fill=Class, alpha=Block, color=Class), 
           position=position_dodge(0.9), 
           width=0.7) + 
  geom_errorbar(aes(ymin=value_mean-value_se, ymax=value_mean+value_se),
                position=position_dodge(0.9), 
                width=0.4,
                color=errorColor)+
  ylim(0,50)+
  #facet_wrap(~labels, nrow=3) +
  ylab("Vectorial Capacity")+
  xlab("Land Class")+
  #theme_fivethirtyeight() +
  scale_x_discrete(labels=c("Rural", "Suburban", "Urban"))+
  scale_fill_manual(values=c(colR, colS, colU), 
                    labels=c("Rural", "Suburban", "Urban")) +
  scale_color_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(1,0), 
                       name="Season", 
                       guide=guide_legend(), 
                       labels=c("Summer", "Fall"))+
  #geom_hline(aes(yintercept=0))+
  guides(color=F, fill=F, alpha=F)+
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        legend.position="right", 
        axis.title.y=element_text(size=12), 
        axis.title.x = element_blank(), 
        axis.text.x = element_text(size=10),
        legend.text=element_text(size=6), 
        legend.title = element_text(size=8), 
        legend.key.size = unit(0.1, "in"), 
        legend.direction = "vertical", 
        legend.box = "vertical",
        panel.grid.major.x = element_blank(),
        panel.grid.major=element_blank(),
        strip.background = element_blank(),
        axis.line = element_line(color=axisColor),
        axis.ticks=element_blank()) +
 theme(strip.text.x = element_text()) #this has to be seperate for some reason?

diffPlot <- ggplot(data=VCplotsumm[VCplotsumm$labels=="Difference due to COEs",], aes(x=factor(Class), group=Block)) +
  geom_bar(stat='identity',
           aes(y=value_mean, fill=Class, alpha=Block, color=Class), 
           position=position_dodge(0.9), 
           width=0.7) + 
  geom_errorbar(aes(ymin=value_mean-value_se, ymax=value_mean+value_se),
                position=position_dodge(0.9), 
                width=0.4,
                color=errorColor)+
  #theme_fivethirtyeight() +
  ylab("Change in VC") +
  xlab("Land Class") +
  scale_x_discrete(labels=c("Rural", "Suburban", "Urban"))+
  scale_fill_manual(values=c(colR, colS, colU), 
                    labels=c("Rural", "Suburban", "Urban")) +
  scale_color_manual(values=c(colR, colS, colU))+
  scale_alpha_discrete(range=c(1,0), 
                       name="Season", 
                       guide=guide_legend(), 
                       labels=c("Summer", "Fall"))+
  geom_hline(aes(yintercept=0))+
  guides(color = F, alpha= F, fill = F)+
  theme(panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_blank(),
        legend.background = element_rect(fill = "transparent", colour = NA),
        legend.position="bottom", 
        axis.title.y = element_text(size=12), 
        axis.title.x = element_text(size=12), 
        axis.text.x = element_text(size=10),
        legend.text=element_text(size=8), 
        legend.title = element_text(size=12), 
        legend.key.size = unit(0.1, "in"), 
        legend.direction = "horizontal", 
        legend.box = "vertical",
        panel.grid.major.x = element_blank(),
        panel.grid.major=element_blank(),
        strip.background = element_blank(),
        axis.ticks=element_blank(),
        axis.line = element_line(color=axisColor)) +
 theme(strip.text.x = element_text()) #this has to be seperate for some reason?

```

Use cowplot to combine the three bar graphs and VC over temp chart.
```{r supp figure 3, eval=F}
pdf(file="figures/forMS/SuppFig3.pdf", width = 3, height=6, family="sans")

plot_grid(noCOEplot, withCOEplot, diffPlot, labels = c("A", "B", "C"),
          align = "v", nrow = 3)

dev.off()
```


## Statistics

```{r VC stats}
VCplot$VCforStats <- VCplot$VC+0.000000001
VCplot$VCforStatsnoCOE <- VCplot$VCnoCOE+0.000000001
VCclass <- lmer(VCforStats~Class*Block+ (1|Site_ID), 
                 data=VCplot)

summary(multcomp::glht(VCclass, linfct = multcomp::mcp(Block = "Tukey"), test = multcomp::adjusted("holm")))

plot(VCclass)
summary(VCclass)
car::Anova(VCclass)

VCclassnoCOE <- lmer(VCforStatsnoCOE~Class*Block+ (1|Site_ID), 
                 data=VCplot)

plot(VCclassnoCOE)
summary(VCclassnoCOE)
car::Anova(VCclassnoCOE)

summary(multcomp::glht(VCclassnoCOE, linfct = multcomp::mcp(Block = "Tukey"), test = multcomp::adjusted("holm")))

#make long for comparison of with and without carry-over
VClong <- VCplot %>%
  gather(COE, value, VC, VCnoCOE)

VCtemp <- lmer(value~Temp_mean_mean*COE + (1|Site_ID), data=VClong)

summary(VCtemp)

## Vectorial Capacity (w carry over) across Temp
VCtempCOE <- lmerTest::lmer(VCforStats~Temp_mean_mean + (1|Site_ID), data=VCplot)

summary(VCtempCOE)

## Vectorial Capacity (w/o carry over) across Temp
VCtempNoCOE <- lmerTest::lmer(VCforStatsnoCOE ~ Temp_mean_mean + (1|Site_ID), data=VCplot)
summary(VCtempNoCOE)
```


